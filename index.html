<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ë§ˆì¼€íŒ… KPI ëª¨ë‹ˆí„°ë§ ëŒ€ì‹œë³´ë“œ</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/luxon@3.3.0/build/global/luxon.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1.3.1/dist/chartjs-adapter-luxon.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Apple SD Gothic Neo', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
            overflow-x: hidden; /* ê°€ë¡œ ìŠ¤í¬ë¡¤ ë°©ì§€ */
        }
        .container { 
            max-width: 1600px; 
            margin: 0 auto;
            width: 100%; /* ê°€ë¡œí­ 100%ë¡œ ì œí•œ */
        }
        header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
            text-align: center;
        }
        h1 { color: #2d3748; font-size: 2.5em; margin-bottom: 10px; }
        .subtitle { color: #718096; font-size: 1.1em; }
        .date-filter {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            flex-wrap: wrap;
        }
        .date-filter label { font-weight: 600; color: #2d3748; font-size: 1.1em; }
        .date-filter input[type="date"] {
            padding: 10px 15px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1em;
            color: #2d3748;
        }
        .date-filter button {
            padding: 10px 25px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
        }
        .chart-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 30px;
            margin-bottom: 30px;
        }
        .chart-container {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .chart-title {
            font-size: 1.4em;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 20px;
            text-align: center;
            padding-bottom: 15px;
            border-bottom: 3px solid #667eea;
        }
        canvas { 
            max-height: 400px;
        }
        
        /* ëª¨ë°”ì¼ ìµœì í™” */
        @media (max-width: 768px) {
            body { 
                padding: 10px; /* ì¢Œìš° ì—¬ë°± ì¤„ì„ */
            }
            
            .container {
                width: 100%;
                max-width: 100%; /* ëª¨ë°”ì¼ì—ì„œ ìµœëŒ€í­ ì œí•œ */
            }
            
            h1 { font-size: 1.4em; }
            .subtitle { font-size: 0.85em; }
            header { padding: 15px; margin-bottom: 15px; }
            
            .chart-grid { 
                grid-template-columns: 1fr;
                gap: 15px;
                margin-bottom: 15px;
            }
            
            .chart-container {
                padding: 12px; /* íŒ¨ë”© ì¤„ì„ */
                width: 100%; /* í­ 100% */
            }
            
            .chart-title {
                font-size: 1em;
                padding-bottom: 8px;
                margin-bottom: 12px;
            }
            
            /* ëª¨ë°”ì¼ì—ì„œ ì°¨íŠ¸ ë†’ì´ í¬ê²Œ */
            canvas { 
                max-height: none !important;
                height: 45vh !important; /* í™”ë©´ ë†’ì´ì˜ 45% */
                min-height: 280px;
                width: 100% !important;
            }
            
            .date-filter {
                padding: 12px;
                gap: 8px;
                margin-bottom: 15px;
            }
            
            .date-filter label {
                font-size: 0.85em;
                width: 100%;
                text-align: left;
            }
            
            .date-filter input[type="date"] {
                padding: 8px;
                font-size: 0.85em;
                width: 100%;
            }
            
            .date-filter button {
                padding: 8px 12px;
                font-size: 0.85em;
                width: 100%;
            }
            
            .legend-info {
                font-size: 0.75em;
                margin-top: 8px;
            }
            
            .date-range {
                font-size: 0.9em;
                padding: 10px;
                margin-bottom: 15px;
            }
            
            .date-info {
                padding: 4px 8px;
                font-size: 0.85em;
            }
        }
        
        .date-range {
            text-align: center;
            color: white;
            font-size: 1.1em;
            margin-bottom: 20px;
            background: rgba(255,255,255,0.2);
            padding: 15px;
            border-radius: 10px;
        }
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        .loading-content {
            background: white;
            padding: 40px;
            border-radius: 15px;
            text-align: center;
            max-width: 90%;
        }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        @media (max-width: 1200px) and (min-width: 769px) {
            .chart-grid { grid-template-columns: 1fr; }
        }
        .legend-info {
            font-size: 0.9em;
            color: #718096;
            margin-top: 15px;
            text-align: center;
        }
        .date-info {
            display: inline-block;
            background: rgba(255, 255, 255, 0.3);
            padding: 5px 12px;
            border-radius: 5px;
            margin: 0 5px;
            font-weight: 600;
        }
        .status {
            text-align: center;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 20px;
            font-weight: 600;
        }
        .status.success { background: #d4edda; color: #155724; }
        .status.error { background: #f8d7da; color: #721c24; }
        .hide { display: none; }
    </style>
</head>
<body>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="spinner"></div>
            <h2>ë°ì´í„° ë¡œë”© ì¤‘...</h2>
            <p>êµ¬ê¸€ ì‹œíŠ¸ì—ì„œ ìµœì‹  ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ê³  ìˆìŠµë‹ˆë‹¤.</p>
        </div>
    </div>

    <div class="container">
        <header>
            <h1>ğŸ¤– ë§ˆì¼€íŒ… KPI ëª¨ë‹ˆí„°ë§ ëŒ€ì‹œë³´ë“œ</h1>
            <p class="subtitle">í‚¤ì›Œë“œ ê²€ìƒ‰ëŸ‰ ì¼ê°„ ì¶”ì´ ë¶„ì„</p>
        </header>

        <div id="statusMessage" class="status hide"></div>

        <div id="mainContent" class="hide">
            <div class="date-filter">
                <label for="startDate">ğŸ“… ì‹œì‘ì¼</label>
                <input type="date" id="startDate" value="2026-01-01">
                <label for="endDate">ğŸ“… ì¢…ë£Œì¼</label>
                <input type="date" id="endDate" value="2026-04-08">
                <button onclick="updateCharts()">ğŸ”„ ê¸°ê°„ ì ìš©</button>
                <button onclick="loadGoogleSheetData()" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%);">ğŸ”„ ë°ì´í„° ìƒˆë¡œê³ ì¹¨</button>
            </div>

            <div class="date-range" id="dateRange">
                <span class="date-info">2026-01-01</span> ~ <span class="date-info">2026-04-08</span> 
                <span style="margin-left: 10px;">ì´ <strong id="dayCount">98</strong>ì¼</span>
            </div>

            <div class="chart-grid">
                <div class="chart-container">
                    <div class="chart-title">ğŸ“ˆ ì—°ë„ë³„ ë¡œë´‡ì²­ì†Œê¸° ê²€ìƒ‰ëŸ‰ ë¹„êµ</div>
                    <canvas id="chart1"></canvas>
                    <p class="legend-info">25ë…„ vs 26ë…„ ë¡œë´‡ì²­ì†Œê¸° ê²€ìƒ‰ íŠ¸ë Œë“œ</p>
                </div>
                <div class="chart-container">
                    <div class="chart-title">ğŸ“ˆ ì—°ë„ë³„ ë¡œë³´ë½ ê²€ìƒ‰ëŸ‰ ë¹„êµ</div>
                    <canvas id="chart2"></canvas>
                    <p class="legend-info">25ë…„ vs 26ë…„ ë¡œë³´ë½ ë¸Œëœë“œ ì¸ì§€ë„ ë³€í™”</p>
                </div>
                <div class="chart-container">
                    <div class="chart-title">ğŸ“ˆ ì œí’ˆ ëª¨ë¸ë³„ ê²€ìƒ‰ëŸ‰ ì¶”ì´</div>
                    <canvas id="chart3"></canvas>
                    <p class="legend-info">S9 Max V Ultra vs S10 Max V Ultra</p>
                </div>
                <div class="chart-container">
                    <div class="chart-title">ğŸ“ˆ ê²½ìŸì‚¬ ë¶„ì„ (4ê°œ ì œí’ˆ)</div>
                    <canvas id="chart4"></canvas>
                    <p class="legend-info">S10 (ë¡œë³´ë½), ì‚¼ì„±, ë“œë¦¬ë¯¸X60, ì—ì½”ë°±ìŠ¤T90</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        const GOOGLE_SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTYbyHRNM0Mtm47UkGFPSaHA0vVJER1imwpttDebMaJHr1jqDgL-P3eI7POuMYpKQ/pub?gid=169813989&single=true&output=csv";
        
        const CORS_PROXIES = [
            'https://corsproxy.io/?',
            'https://api.allorigins.win/raw?url='
        ];
        
        let allData = [];
        let charts = {};

        function showStatus(message, type) {
            const statusEl = document.getElementById('statusMessage');
            statusEl.textContent = message;
            statusEl.className = 'status ' + type;
            statusEl.classList.remove('hide');
            if (type === 'success') {
                setTimeout(() => statusEl.classList.add('hide'), 3000);
            }
        }

        function showLoading(show) {
            document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none';
        }

        function cleanNumber(value) {
            if (value === null || value === undefined || value === '' || value === '-') return null;
            if (typeof value === 'number') return value === 0 ? null : value;
            const cleaned = String(value).replace(/[,\s]/g, '');
            const num = parseFloat(cleaned);
            if (isNaN(num) || num === 0) return null;
            return num;
        }

        function formatNumberK(value) {
            if (value === null || value === undefined) return '';
            if (value >= 1000) {
                return (value / 1000).toFixed(1) + 'k';
            }
            return Math.round(value).toString();
        }

        // Yì¶• ë²”ìœ„ ìë™ ê³„ì‚° í•¨ìˆ˜
        function calculateYAxisRange(datasets) {
            let allValues = [];
            datasets.forEach(dataset => {
                dataset.data.forEach(point => {
                    if (point.y !== null && point.y !== undefined) {
                        allValues.push(point.y);
                    }
                });
            });
            
            if (allValues.length === 0) return { min: 0, max: 10000 };
            
            const min = Math.min(...allValues);
            const max = Math.max(...allValues);
            const range = max - min;
            
            // ì—¬ë°± 10% ì¶”ê°€
            const padding = range * 0.1;
            const suggestedMin = Math.max(0, Math.floor((min - padding) / 100) * 100);
            const suggestedMax = Math.ceil((max + padding) / 100) * 100;
            
            return { min: suggestedMin, max: suggestedMax };
        }

        async function tryFetchWithProxy(proxyUrl, sheetUrl) {
            const url = proxyUrl + encodeURIComponent(sheetUrl);
            const response = await fetch(url, {
                method: 'GET',
                headers: { 'Accept': 'text/csv,text/plain,*/*' }
            });
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            return await response.text();
        }

        async function loadGoogleSheetData() {
            showLoading(true);
            try {
                let csvText = null;

                for (const proxy of CORS_PROXIES) {
                    try {
                        csvText = await tryFetchWithProxy(proxy, GOOGLE_SHEET_URL);
                        break;
                    } catch (error) {
                        continue;
                    }
                }

                if (!csvText) {
                    try {
                        const response = await fetch(GOOGLE_SHEET_URL);
                        if (response.ok) csvText = await response.text();
                    } catch (error) {}
                }

                if (!csvText) {
                    throw new Error('ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                }
                
                Papa.parse(csvText, {
                    header: true,
                    skipEmptyLines: true,
                    complete: function(results) {
                        if (results.data.length === 0) {
                            throw new Error('ë°ì´í„°ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.');
                        }

                        allData = results.data.map(row => {
                            const cleanedRow = {};
                            Object.keys(row).forEach(key => {
                                if (key === 'ë‚ ì§œ' || key.includes('ë‚ ì§œ')) {
                                    cleanedRow['ë‚ ì§œ'] = row[key];
                                } else {
                                    cleanedRow[key] = cleanNumber(row[key]);
                                }
                            });
                            return cleanedRow;
                        });

                        showLoading(false);
                        document.getElementById('mainContent').classList.remove('hide');
                        showStatus(`âœ… ë°ì´í„° ë¡œë“œ ì™„ë£Œ! (${allData.length}ê°œ ë ˆì½”ë“œ)`, 'success');
                        updateCharts();
                    },
                    error: function(error) {
                        showLoading(false);
                        showStatus('âŒ ë°ì´í„° íŒŒì‹± ì˜¤ë¥˜: ' + error.message, 'error');
                    }
                });

            } catch (error) {
                showLoading(false);
                showStatus('âŒ ì˜¤ë¥˜: ' + error.message, 'error');
            }
        }

        function filterDataByDate(data, startDate, endDate) {
            return data.filter(item => item['ë‚ ì§œ'] >= startDate && item['ë‚ ì§œ'] <= endDate);
        }

        function createChart(canvasId, datasets) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            if (charts[canvasId]) charts[canvasId].destroy();
            
            const isMobile = window.innerWidth <= 768;
            
            // Yì¶• ë²”ìœ„ ìë™ ê³„ì‚°
            const yAxisRange = calculateYAxisRange(datasets);
            
            charts[canvasId] = new Chart(ctx, {
                type: 'line',
                data: { datasets: datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: { 
                                usePointStyle: true, 
                                padding: isMobile ? 8 : 15,
                                font: { size: isMobile ? 10 : 12 },
                                boxWidth: isMobile ? 8 : 12
                            }
                        },
                        tooltip: {
                            enabled: true,
                            backgroundColor: 'rgba(0,0,0,0.8)',
                            padding: isMobile ? 8 : 12,
                            titleFont: { size: isMobile ? 11 : 13 },
                            bodyFont: { size: isMobile ? 10 : 12 },
                            callbacks: {
                                label: function(context) {
                                    if (context.parsed.y === null) return null;
                                    let label = context.dataset.label || '';
                                    if (label) label += ': ';
                                    label += formatNumberK(context.parsed.y);
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: { 
                                unit: 'day', 
                                displayFormats: { day: 'MM/dd' }
                            },
                            title: { display: false },
                            grid: { display: false },
                            ticks: {
                                font: { size: isMobile ? 8 : 11 },
                                maxRotation: isMobile ? 45 : 0,
                                autoSkip: true,
                                maxTicksLimit: isMobile ? 5 : 10
                            }
                        },
                        y: {
                            suggestedMin: yAxisRange.min,
                            suggestedMax: yAxisRange.max,
                            title: { display: false },
                            grid: { color: 'rgba(0,0,0,0.05)' },
                            ticks: {
                                font: { size: isMobile ? 9 : 11 },
                                callback: function(value) {
                                    return formatNumberK(value);
                                }
                            }
                        }
                    }
                }
            });
        }

        const colors = {
            roborock: 'rgb(220, 38, 38)',
            samsung: 'rgb(30, 64, 175)',
            dreame: 'rgb(96, 165, 250)',
            ecovacs: 'rgb(120, 53, 15)',
            blue: 'rgb(59, 130, 246)',
            red: 'rgb(239, 68, 68)',
            green: 'rgb(34, 197, 94)',
            orange: 'rgb(249, 115, 22)'
        };

        function updateCharts() {
            if (allData.length === 0) return;

            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            if (!startDate || !endDate) {
                alert('ì‹œì‘ì¼ê³¼ ì¢…ë£Œì¼ì„ ëª¨ë‘ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }
            
            const filteredData = filterDataByDate(allData, startDate, endDate);
            
            if (filteredData.length === 0) {
                alert('ì„ íƒí•œ ê¸°ê°„ì— ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            document.getElementById('dateRange').innerHTML = `
                <span class="date-info">${startDate}</span> ~ <span class="date-info">${endDate}</span> 
                <span style="margin-left: 10px;">ì´ <strong>${filteredData.length}</strong>ì¼</span>
            `;

            const chartConfig = (d, key) => ({x: d['ë‚ ì§œ'], y: d[key]});

            createChart('chart1', [
                { label: '25 ë¡œë´‡ì²­ì†Œê¸°', data: filteredData.map(d => chartConfig(d, '25 ë¡œë´‡ì²­ì†Œê¸°')), borderColor: colors.blue, backgroundColor: 'transparent', borderWidth: 2.5, tension: 0.4, fill: false, pointRadius: 0, pointHoverRadius: 4, spanGaps: false },
                { label: '26 ë¡œë´‡ì²­ì†Œê¸°', data: filteredData.map(d => chartConfig(d, '26 ë¡œë´‡ì²­ì†Œê¸°')), borderColor: colors.red, backgroundColor: 'transparent', borderWidth: 2.5, tension: 0.4, fill: false, pointRadius: 0, pointHoverRadius: 4, spanGaps: false }
            ]);

            createChart('chart2', [
                { label: '25 ë¡œë³´ë½', data: filteredData.map(d => chartConfig(d, '25 ë¡œë³´ë½')), borderColor: colors.green, backgroundColor: 'transparent', borderWidth: 2.5, tension: 0.4, fill: false, pointRadius: 0, pointHoverRadius: 4, spanGaps: false },
                { label: '26 ë¡œë³´ë½', data: filteredData.map(d => chartConfig(d, '26 .ë¡œë³´ë½')), borderColor: colors.roborock, backgroundColor: 'transparent', borderWidth: 2.5, tension: 0.4, fill: false, pointRadius: 0, pointHoverRadius: 4, spanGaps: false }
            ]);

            createChart('chart3', [
                { label: 'S9 Max V Ultra', data: filteredData.map(d => chartConfig(d, 'S9 Max V Ultra')), borderColor: colors.orange, backgroundColor: 'transparent', borderWidth: 2.5, tension: 0.4, fill: false, pointRadius: 0, pointHoverRadius: 4, spanGaps: false },
                { label: 'S10 Max V Ultra', data: filteredData.map(d => chartConfig(d, 'S10 Max V Ultra')), borderColor: colors.roborock, backgroundColor: 'transparent', borderWidth: 2.5, tension: 0.4, fill: false, pointRadius: 0, pointHoverRadius: 4, spanGaps: false }
            ]);

            createChart('chart4', [
                { label: 'S10 (ë¡œë³´ë½)', data: filteredData.map(d => chartConfig(d, 'S10 Max V Ultra')), borderColor: colors.roborock, backgroundColor: 'transparent', borderWidth: 2.5, tension: 0.4, fill: false, pointRadius: 0, pointHoverRadius: 4, spanGaps: false },
                { label: 'ì‚¼ì„±', data: filteredData.map(d => chartConfig(d, 'ì‚¼ì„±ë¡œë´‡ì²­ì†Œê¸°')), borderColor: colors.samsung, backgroundColor: 'transparent', borderWidth: 2.5, tension: 0.4, fill: false, pointRadius: 0, pointHoverRadius: 4, spanGaps: false },
                { label: 'ë“œë¦¬ë¯¸X60', data: filteredData.map(d => chartConfig(d, 'ë“œë¦¬ë¯¸x60')), borderColor: colors.dreame, backgroundColor: 'transparent', borderWidth: 2.5, tension: 0.4, fill: false, pointRadius: 0, pointHoverRadius: 4, spanGaps: false },
                { label: 'ì—ì½”ë°±ìŠ¤T90', data: filteredData.map(d => chartConfig(d, 'ì—ì½”ë°±ìŠ¤T90')), borderColor: colors.ecovacs, backgroundColor: 'transparent', borderWidth: 2.5, tension: 0.4, fill: false, pointRadius: 0, pointHoverRadius: 4, spanGaps: false }
            ]);
        }

        window.addEventListener('DOMContentLoaded', loadGoogleSheetData);
        
        window.addEventListener('resize', () => {
            if (allData.length > 0) {
                updateCharts();
            }
        });
    </script>
</body>
</html>
