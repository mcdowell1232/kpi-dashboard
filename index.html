<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ë¡œë´‡ì²­ì†Œê¸° KPI ëª¨ë‹ˆí„°ë§ ëŒ€ì‹œë³´ë“œ</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/luxon@3.3.0/build/global/luxon.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1.3.1/dist/chartjs-adapter-luxon.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Apple SD Gothic Neo', sans-serif;
            background: linear-gradient(135deg, #c0392b 0%, #922b21 100%);
            padding: 20px;
            min-height: 100vh;
            overflow-x: hidden;
        }
        .container { max-width: 1600px; margin: 0 auto; width: 100%; }

        /* â”€â”€ í—¤ë” â”€â”€ */
        header {
            background: white;
            padding: 28px 30px 22px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 25px;
            text-align: center;
        }
        h1 { color: #2d3748; font-size: 2.2em; font-weight: 700; letter-spacing: -0.5px; }

        /* â”€â”€ ë‚ ì§œ í•„í„° â”€â”€ */
        .date-filter {
            background: white; padding: 20px 25px; border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2); margin-bottom: 25px;
            display: flex; align-items: center; justify-content: center;
            gap: 18px; flex-wrap: wrap;
        }
        .date-filter label { font-weight: 600; color: #2d3748; font-size: 1em; }
        .date-filter input[type="date"] {
            padding: 9px 13px; border: 2px solid #e2e8f0;
            border-radius: 8px; font-size: 0.95em; color: #2d3748;
        }
        .date-filter button {
            padding: 9px 22px;
            background: linear-gradient(135deg, #c0392b 0%, #922b21 100%);
            color: white; border: none; border-radius: 8px;
            font-size: 0.95em; font-weight: 600; cursor: pointer; transition: opacity 0.2s;
        }
        .date-filter button:hover { opacity: 0.88; }
        .btn-refresh { background: linear-gradient(135deg, #28a745 0%, #20c997 100%) !important; }
        .btn-pdf {
            background: linear-gradient(135deg, #c0392b 0%, #e74c3c 100%) !important;
            color: #fff !important; border: none; border-radius: 8px;
            padding: 7px 16px; font-size: 0.88em; font-weight: 700;
            cursor: pointer; display: inline-flex; align-items: center; gap: 5px;
            box-shadow: 0 2px 8px rgba(192,57,43,.25);
            transition: opacity .15s;
        }
        .btn-pdf:hover { opacity: 0.88; }
        @media print {
            .btn-pdf, .btn-refresh, .date-filter, #statusMessage,
            .am-toolbar, .am-period-group, .am-channel-group { display:none !important; }
            body { background:#fff !important; }
            .container { max-width:100% !important; padding:0 !important; }
            .chart-container { break-inside: avoid; page-break-inside: avoid; }
            #adrielWrapper { break-inside: avoid; }
            canvas { max-width: 100% !important; }
        }

        /* â”€â”€ ë‚ ì§œ ë²”ìœ„ â”€â”€ */
        .date-range {
            text-align: center; color: white; font-size: 1em;
            margin-bottom: 20px; background: rgba(255,255,255,0.2);
            padding: 12px 18px; border-radius: 10px;
        }
        .date-info {
            display: inline-block; background: rgba(255,255,255,0.3);
            padding: 4px 11px; border-radius: 5px; margin: 0 4px; font-weight: 600;
        }

        /* â”€â”€ ì°¨íŠ¸ ê·¸ë¦¬ë“œ â”€â”€ */
        .chart-grid {
            display: grid; grid-template-columns: repeat(2, 1fr);
            gap: 28px; margin-bottom: 28px;
        }
        .chart-container {
            background: white; padding: 22px 20px 16px;
            border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        /* íŒë§¤ëŸ‰ ë³µí•© ì°¨íŠ¸ëŠ” ì „ì²´ í­ */
        .chart-container.full-width {
            grid-column: 1 / -1;
        }
        .chart-title {
            font-size: 1.25em; font-weight: 600; color: #2d3748;
            margin-bottom: 16px; text-align: center;
            padding-bottom: 12px; border-bottom: 3px solid #667eea;
        }
        canvas { max-height: 400px; }
        /* íŒë§¤ëŸ‰ ì°¨íŠ¸ ìº”ë²„ìŠ¤ ë†’ì´ ê³ ì • */
        #salesChart { max-height: 420px !important; }

        /* â”€â”€ ë·° í† ê¸€ ë²„íŠ¼ â”€â”€ */
        .view-btn-group {
            display: flex; gap: 8px; margin-bottom: 16px;
            justify-content: flex-start;
        }
        .view-btn {
            padding: 6px 18px; border-radius: 20px;
            border: 1.5px solid #cbd5e1;
            background: #f8fafc; color: #64748b;
            font-size: 0.85em; font-weight: 600;
            cursor: pointer; transition: all 0.18s;
        }
        .view-btn:hover { background: #e2e8f0; }
        .view-btn.active {
            background: #1e3a5f; color: #fff;
            border-color: #1e3a5f;
        }

        /* â”€â”€ ê²€ìƒ‰ëŸ‰ ëŒ€ë¹„ ë¹„ìœ¨ í…Œì´ë¸” â”€â”€ */
        .ratio-section-title {
            font-size: 0.8em; font-weight: 700; color: #475569;
            margin-bottom: 4px; letter-spacing: 0.03em;
        }
        .ratio-table-wrap {
            overflow-x: auto; margin-top: 14px;
            box-sizing: border-box;
        }
        .ratio-table {
            width: 100%; border-collapse: collapse;
            font-size: 0.78em; color: #374151;
            table-layout: fixed;
        }
        /* ì™¼ìª½ ë¼ë²¨ ì—´: afterRenderì—ì„œ ë„ˆë¹„ ë™ì  ì„¤ì • */
        .ratio-label-col {
            text-align: left !important; font-weight: 600;
            font-size: 0.7em !important; line-height: 1.2;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
            padding: 3px 2px !important;
            box-sizing: border-box;
        }
        /* ë°ì´í„° ì…€: afterRenderì—ì„œ ë„ˆë¹„ ë™ì  ì„¤ì • */
        .ratio-data-col {
            text-align: center; box-sizing: border-box;
            white-space: nowrap; overflow: hidden;
        }
        .ratio-table th {
            background: #f1f5f9; padding: 5px 3px;
            font-weight: 600; text-align: center;
            border-bottom: 2px solid #e2e8f0;
            white-space: nowrap; font-size: 0.9em;
        }
        .ratio-table td {
            padding: 4px 3px; text-align: center;
            border-bottom: 1px solid #f0f0f0;
            white-space: nowrap; font-size: 0.9em;
        }
        /* ê²€ìƒ‰ëŸ‰ í–‰ */
        .ratio-row-search td { background: #f8fafc; color:#475569; }
        /* íŒë§¤ëŸ‰ í–‰ */
        .ratio-row-sales td { background: #f0fdf4; color:#166534; font-weight:600; }
        /* ë¹„ìœ¨ í–‰ */
        .ratio-row-ratio td {
            font-weight: 700; background: #fffbeb;
            border-top: 2px solid #fbbf24; color: #dc2626;
        }
        /* ê·¸ë£¹ ìƒì„¸ ë°ì´í„° í–‰ */
        .ratio-row-group td {
            font-size: 0.88em; color:#374151;
            background: #fafafa;
        }
        .ratio-row-group:hover td { background: #f0f9ff; }
        .ratio-pct { font-weight: 700; color: #dc2626; }
        .sales-disclaimer {
            margin-top: 14px; padding: 10px 14px;
            background: #f8fafc; border-left: 3px solid #94a3b8;
            border-radius: 4px; font-size: 0.78em; color: #64748b;
            line-height: 1.5;
        }
        /* ì´í•© ì—´ */
        .ratio-total-col {
            text-align: center; font-weight: 700;
            background: #eef2ff !important;
            color: #3730a3; white-space: nowrap;
            border-left: 2px solid #c7d2fe;
            padding: 4px 6px; font-size: 0.92em;
            min-width: 58px;
        }
        .ratio-total-search { color: #475569; }
        .ratio-total-sales  { color: #166534; }
        .ratio-total-group  { color: #1e40af; }

        /* â”€â”€ ë§ˆì¼€íŒ… ì´ë²¤íŠ¸ í•˜ë‹¨ ë²”ë¡€ (ê³µí†µ ë˜í¼) â”€â”€ */
        .marketing-legend {
            display: flex; align-items: center; justify-content: center;
            gap: 6px 16px; flex-wrap: wrap;
            margin-top: 12px; padding-top: 10px;
            border-top: 1px solid #f0f0f0;
        }
        .ml-item {
            display: flex; align-items: center; gap: 6px;
            font-size: 0.74em; color: #555; font-weight: 500;
            white-space: nowrap;
        }

        /* â”€â”€ ê³µí†µ ë²”ë¡€ ì•„ì´ì½˜ ê¸°ë³¸ â”€â”€ */
        .ml-box {
            width: 16px; height: 12px; border-radius: 3px; flex-shrink: 0;
        }
        .ml-dash {
            width: 20px; height: 0; flex-shrink: 0;
        }

        /* 25ë…„ ë¡œë³´ë½ = ì´ˆë¡ */
        .ml-box-green  { background: rgba(34,197,94,0.2);  border: 1.5px solid rgba(34,197,94,0.6); }
        .ml-dash-green { border-top: 2.5px dashed rgba(22,163,74,0.9); }

        /* 26ë…„ ë¡œë³´ë½ = ë¹¨ê°• */
        .ml-box-red    { background: rgba(220,38,38,0.15); border: 1.5px solid rgba(220,38,38,0.55); }
        .ml-dash-red   { border-top: 2.5px dashed rgba(220,38,38,0.9); }

        /* ì‚¼ì„± = ì§„íŒŒë‘ */
        .ml-box-samsung  { background: rgba(30,64,175,0.15); border: 1.5px solid rgba(30,64,175,0.5); }
        .ml-dash-samsung { border-top: 2.5px dashed rgba(30,64,175,0.9); }

        /* ë“œë¦¬ë¯¸ = í•˜ëŠ˜íŒŒë‘ */
        .ml-box-dreame   { background: rgba(96,165,250,0.2); border: 1.5px solid rgba(96,165,250,0.7); }
        .ml-dash-dreame  { border-top: 2.5px dashed rgba(96,165,250,1); }

        /* â”€â”€ êµ¬ë¶„ì„  â”€â”€ */
        .ml-divider {
            width: 1px; height: 14px;
            background: #ddd; flex-shrink: 0; margin: 0 4px;
        }

        /* â”€â”€ ì¼ë°˜ í…ìŠ¤íŠ¸ ë²”ë¡€ â”€â”€ */
        .legend-info { font-size: 0.82em; color: #718096; margin-top: 10px; text-align: center; }

        /* â”€â”€ ìƒíƒœ / ë¡œë”© â”€â”€ */
        .status { text-align: center; padding: 10px; border-radius: 5px; margin-bottom: 18px; font-weight: 600; }
        .status.success { background: #d4edda; color: #155724; }
        .status.error   { background: #f8d7da; color: #721c24; }
        .hide { display: none; }
        .loading-overlay {
            position: fixed; top:0; left:0; width:100%; height:100%;
            background: rgba(0,0,0,0.7); display:flex;
            justify-content:center; align-items:center; z-index:9999;
        }
        .loading-content { background:white; padding:40px; border-radius:15px; text-align:center; max-width:90%; }
        .spinner {
            border: 4px solid #f3f3f3; border-top: 4px solid #667eea;
            border-radius: 50%; width:50px; height:50px;
            animation: spin 1s linear infinite; margin: 0 auto 20px;
        }
        @keyframes spin { 0%{transform:rotate(0deg)} 100%{transform:rotate(360deg)} }

        /* â”€â”€ íƒœë¸”ë¦¿ â”€â”€ */
        @media (max-width:1200px) and (min-width:769px) {
            .chart-grid { grid-template-columns: 1fr; }
        }

        /* â”€â”€ ëª¨ë°”ì¼ â”€â”€ */
        @media (max-width:768px) {
            body { padding: 8px; }
            .container { width:100%; max-width:100%; padding:0; }
            h1 { font-size: 1.28em; }
            header { padding: 14px 12px 12px; margin-bottom: 10px; border-radius: 12px; }
            /* chart-grid: 1ì—´, ë™ì¼ ë„ˆë¹„ ê°•ì œ */
            .chart-grid {
                display: flex !important;
                flex-direction: column !important;
                gap: 10px !important;
                margin-bottom: 10px !important;
                width: 100% !important;
            }
            .chart-container {
                padding: 12px 10px 10px !important;
                width: 100% !important;
                box-sizing: border-box !important;
                border-radius: 12px !important;
                margin-left: 0 !important;
                margin-right: 0 !important;
            }
            .chart-container.full-width {
                width: 100% !important;
                box-sizing: border-box !important;
            }
            .chart-title { font-size: 0.92em; padding-bottom:7px; margin-bottom:8px; }
            /* ìº”ë²„ìŠ¤: ì ì ˆí•œ ë†’ì´ */
            canvas { max-height:none !important; height:42vw !important; min-height:220px !important; max-height:320px !important; width:100% !important; }
            /* chart4: canvasê°€ Wrap ì „ì²´ë¥¼ ì±„ìš°ë„ë¡ max-height í•´ì œ */
            #chart4Wrap canvas { height:100% !important; max-height:none !important; min-height:unset !important; }
            /* chart4 ì»¨í…Œì´ë„ˆ í•˜ë‹¨ ê³µë°± ìµœì†Œí™” */
            #chart4Container { padding-bottom: 8px !important; }
            /* íŒë§¤ëŸ‰ ì°¨íŠ¸: ë” ë†’ê²Œ */
            #salesChart { height:58vw !important; min-height:260px !important; max-height:400px !important; }
            /* íŒë§¤ëŸ‰ ì°¨íŠ¸ wrapperë„ ì¡°ì • */
            #salesChartContainer [style*='height:480px'] { height:auto !important; }
            .view-btn { padding:5px 10px; font-size:0.76em; }
            .view-btn-group { gap:4px; flex-wrap:wrap; }
            .ratio-table { font-size:0.68em; }
            .ratio-table th, .ratio-table td { padding:3px 4px; }
            .ratio-table-wrap { margin-top:6px !important; overflow-x:auto; }
            .date-filter { padding:10px 8px; gap:6px; margin-bottom:10px; flex-wrap:wrap; }
            .date-filter label { font-size:0.80em; width:100%; text-align:left; }
            .date-filter input[type="date"] { padding:6px 8px; font-size:0.80em; width:100%; box-sizing:border-box; }
            .date-filter button { padding:7px 10px; font-size:0.80em; width:100%; box-sizing:border-box; }
            .date-range { font-size:0.85em; padding:8px 10px; margin-bottom:10px; }
            .date-info { padding:3px 6px; font-size:0.85em; }
            .marketing-legend { gap:4px 8px; margin-top:6px; padding-top:6px; }
            .ml-item { font-size:0.67em; white-space:normal; }
            .ml-divider { display:none; }
            /* ê²½ìŸì‚¬ ì¸ì‚¬ì´íŠ¸ ëª¨ë°”ì¼ */
            #competitorInsightWrapper { margin-top:0 !important; }
        }
            /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           ì•„ë“œë¦¬ì—˜ ë§ˆì¼€íŒ… ì„¹ì…˜
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

        /* ì„¹ì…˜ í—¤ë” */
        .am-header {
            display:flex; align-items:center; justify-content:space-between;
            flex-wrap:wrap; gap:10px; margin-bottom:18px;
        }
        .am-header-left h2 {
            font-size:1.22em; font-weight:700; color:#2d3748;
        }
        .am-header-left p { font-size:0.82em; color:#718096; margin-top:3px; }
        .am-refresh-btn {
            padding:6px 16px;
            background: linear-gradient(135deg,#c0392b 0%,#922b21 100%);
            color:#fff; border:none; border-radius:18px;
            font-size:0.82em; font-weight:600; cursor:pointer;
            transition:opacity .18s; white-space:nowrap;
        }
        .am-refresh-btn:hover { opacity:.82; }

        /* â”€â”€ ì•„ë“œë¦¬ì—˜ ìœ„ì ¯ ì˜¤ë²„í”Œë¡œìš° ë°©ì§€ â”€â”€ */
        #adrielWrapper, #amContent {
            overflow-x: hidden;
            width: 100%;
            box-sizing: border-box;
        }
        .am-toolbar { flex-wrap: wrap !important; }
        .am-metric-group { flex-wrap: wrap !important; min-width: 0; }
        .am-period-group { flex-shrink: 0; }
        /* KPI ì¹´ë“œ ê·¸ë¦¬ë“œ */
        .am-kpi-grid {
            display:grid; grid-template-columns:repeat(6,1fr);
            gap:10px; margin-bottom:18px;
        }
        .am-kpi-card {
            background:linear-gradient(135deg,#fff9f9 0%,#ffeaea 100%);
            border:1px solid #fecaca; border-radius:11px;
            padding:13px 8px; text-align:center;
            transition:transform .18s, box-shadow .18s;
        }
        .am-kpi-card:hover { transform:translateY(-2px); box-shadow:0 5px 16px rgba(192,57,43,.14); }
        .am-kpi-label { font-size:0.68em; color:#9b2226; font-weight:700;
            text-transform:uppercase; letter-spacing:.04em; margin-bottom:5px; }
        .am-kpi-value { font-size:1.22em; font-weight:800; color:#1a202c; }
        .am-kpi-sub   { font-size:0.65em; color:#a0aec0; margin-top:2px; }

        /* ì¼/ì£¼ ë‹¨ìœ„ í† ê¸€ + ì§€í‘œ ë²„íŠ¼ í–‰ */
        .am-toolbar {
            display:flex; flex-wrap:wrap; align-items:center;
            gap:10px; margin-bottom:14px;
        }
        .am-period-group {
            display:flex; gap:0; border-radius:20px;
            overflow:hidden; border:1.5px solid #c0392b; flex-shrink:0;
        }
        .am-period-btn {
            padding:6px 16px; border:none; background:#fff;
            color:#c0392b; font-size:0.84em; font-weight:600;
            cursor:pointer; transition:all .15s;
        }
        .am-period-btn.active { background:#c0392b; color:#fff; }
        .am-period-btn:not(:last-child) { border-right:1.5px solid #c0392b; }

        .am-divider { width:1px; height:28px; background:#e2e8f0; flex-shrink:0; }

        .am-metric-group {
            display:flex; gap:6px; flex-wrap:wrap;
        }
        .am-metric-btn {
            padding:5px 13px; border-radius:18px;
            border:1.5px solid #e2e8f0; background:#fff;
            color:#718096; font-size:0.80em; font-weight:600;
            cursor:pointer; transition:all .15s;
        }
        .am-metric-btn:hover { border-color:#c0392b; color:#c0392b; }
        .am-metric-btn.active {
            background:linear-gradient(135deg,#c0392b 0%,#922b21 100%);
            border-color:transparent; color:#fff;
        }

        /* ë°ì´í„° ì •ë³´ ë°” */
        .am-info-bar {
            display:flex; justify-content:space-between; align-items:center;
            background:#fff5f5; border-radius:7px;
            padding:7px 13px; margin-bottom:12px;
            font-size:0.79em; color:#718096; flex-wrap:wrap; gap:6px;
        }
        .am-info-bar .am-range { font-weight:700; color:#4a5568; }
        .am-info-bar .am-warn  { color:#dd6b20; font-weight:600; }

        /* ë¡œë”© / ì—ëŸ¬ */
        .am-loading {
            text-align:center; padding:44px 20px; color:#718096;
        }
        .am-spinner {
            border:3px solid #f3f3f3; border-top:3px solid #c0392b;
            border-radius:50%; width:30px; height:30px;
            animation:spin .9s linear infinite; margin:0 auto 10px;
        }
        .am-error {
            text-align:center; padding:28px;
            color:#c0392b; font-weight:600;
            background:#fff5f5; border-radius:10px;
        }

        /* ì±„ë„ í•„í„° ë²„íŠ¼ (am-metric-btnê³¼ ë™ì¼í•˜ì§€ë§Œ ìƒ‰ìƒ êµ¬ë¶„) */
        .am-channel-btn {
            padding:5px 13px; border-radius:18px;
            border:1.5px solid #c8e6c9; background:#fff;
            color:#2e7d32; font-size:0.78em; font-weight:600;
            cursor:pointer; transition:all .15s;
        }
        .am-channel-btn:hover { border-color:#388e3c; background:#f1f8e9; }
        .am-channel-btn.active {
            background:linear-gradient(135deg,#2e7d32 0%,#1b5e20 100%);
            border-color:transparent; color:#fff;
        }

        /* ì°¨íŠ¸ ë²”ë¡€ í…ìŠ¤íŠ¸ */
        .am-chart-legend {
            font-size:0.79em; color:#718096;
            margin-top:10px; text-align:center;
        }

        /* ëª¨ë°”ì¼ */
        @media (max-width:768px) {
            .am-kpi-grid { grid-template-columns:repeat(3,1fr); gap:6px; }
            .am-kpi-card { padding:9px 5px; }
            .am-kpi-label { font-size:0.56em; }
            .am-kpi-value { font-size:0.82em; }
            .am-kpi-sub   { font-size:0.54em; }
            .am-toolbar { gap:5px; }
            .am-metric-btn { padding:3px 7px; font-size:0.62em; }
            .am-channel-btn { padding:3px 7px; font-size:0.62em; }
            .am-period-btn { padding:4px 10px; font-size:0.68em; }
            #adrielWrapper { padding: 10px 8px !important; }
            .am-header { flex-direction: column; align-items: flex-start; gap:6px; }
            .am-info-bar { font-size:0.62em; }
        }
        @media (max-width:480px) {
            .am-kpi-grid { grid-template-columns:repeat(2,1fr); gap:5px; }
            .am-kpi-label { font-size:0.52em; }
            .am-kpi-value { font-size:0.76em; }
            .am-metric-btn { padding:3px 6px; font-size:0.58em; }
            .am-channel-btn { padding:3px 6px; font-size:0.58em; }
        }
        /* chart4 ë†’ì´ ëª¨ë°”ì¼ +20% */
        #chart4Wrap { position:relative; height:420px; }
        @media (max-width:768px) {
            #chart4Wrap { height: 480px !important; min-height:380px !important; }
        }

        /* â•â• ì¸ì‚¬ì´íŠ¸ ì„¹ì…˜ CSS â•â• */
        #insightWrapper .chart-title { font-size: 1.05em; }
        #dynamicInsights .insight-card {
            background: #fff;
            border-radius: 12px;
            padding: 18px 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.07);
            border-left: 4px solid #c0392b;
        }
        #dynamicInsights .insight-card.blue  { border-left-color: #2563eb; }
        #dynamicInsights .insight-card.green { border-left-color: #16a34a; }
        #dynamicInsights .insight-card h3 {
            font-size: 0.95em; font-weight: 700;
            color: #1a202c; margin-bottom: 8px;
        }
        #dynamicInsights .insight-card p {
            font-size: 0.83em; color: #4a5568; line-height: 1.6;
        }
        #dynamicInsights .insight-card .highlight { font-weight: 700; color: #c0392b; }
        #dynamicInsights .insight-card.blue  .highlight { color: #2563eb; }
        #dynamicInsights .insight-card.green .highlight { color: #16a34a; }
        @media (max-width: 768px) {
            #dynamicInsights { grid-template-columns: 1fr !important; }
        }

        /* â•â• ê²½ìŸì‚¬ ì¸ì‚¬ì´íŠ¸ ì¹´ë“œ â•â• */
        #competitorInsights .ci-card {
            background: #fff;
            border-radius: 12px;
            padding: 18px 16px;
            box-shadow: 0 2px 8px rgba(192,57,43,0.09);
            border-left: 4px solid #c0392b;
        }
        #competitorInsights .ci-card.blue  { border-left-color: #2563eb; }
        #competitorInsights .ci-card.green { border-left-color: #16a34a; }
        #competitorInsights .ci-card.orange { border-left-color: #d97706; }
        #competitorInsights .ci-card h3 {
            font-size: 0.93em; font-weight: 700;
            color: #1a202c; margin-bottom: 8px; display: flex; align-items: center; gap: 6px;
        }
        #competitorInsights .ci-card p {
            font-size: 0.82em; color: #4a5568; line-height: 1.65;
        }
        #competitorInsights .ci-card .ci-hl { font-weight: 700; color: #c0392b; }
        #competitorInsights .ci-card.blue  .ci-hl { color: #2563eb; }
        #competitorInsights .ci-card.green .ci-hl { color: #16a34a; }
        #competitorInsights .ci-card.orange .ci-hl { color: #d97706; }
        #competitorInsights .ci-badge {
            display: inline-block; font-size: 0.72em; font-weight: 700;
            padding: 2px 8px; border-radius: 10px;
            background: #fee2e2; color: #c0392b; margin-left: 4px;
        }
        #competitorInsights .ci-badge.up { background: #dcfce7; color: #16a34a; }
        @media (max-width: 768px) {
            #competitorInsights { grid-template-columns: 1fr !important; }
            #competitorInsightWrapper { margin-top: 0 !important; }
        }
        </style>
</head>
<body>

<div class="loading-overlay" id="loadingOverlay">
    <div class="loading-content">
        <div class="spinner"></div>
        <h2>ë°ì´í„° ë¡œë”© ì¤‘...</h2>
        <p>êµ¬ê¸€ ì‹œíŠ¸ì—ì„œ ìµœì‹  ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ê³  ìˆìŠµë‹ˆë‹¤.</p>
    </div>
</div>

<div class="container">
    <header style="display:flex; align-items:center; justify-content:space-between; flex-wrap:wrap; gap:10px;">
        <h1 style="margin:0;">ğŸ¤– ë¡œë´‡ì²­ì†Œê¸° KPI ëª¨ë‹ˆí„°ë§ ëŒ€ì‹œë³´ë“œ</h1>
        <button class="btn-pdf" onclick="exportPDF()">ğŸ“„ PDF ì¶œë ¥</button>
    </header>

    <div id="statusMessage" class="status hide"></div>

    <div id="mainContent" class="hide">
        <div class="date-filter">
            <label for="startDate">ğŸ“… ì‹œì‘ì¼</label>
            <input type="date" id="startDate" value="2025-12-29">
            <label for="endDate">ğŸ“… ì¢…ë£Œì¼</label>
            <input type="date" id="endDate" value="2026-04-08">
            <button onclick="updateCharts()">ğŸ”„ ê¸°ê°„ ì ìš©</button>
            <button class="btn-refresh" onclick="loadGoogleSheetData()">â†» ë°ì´í„° ìƒˆë¡œê³ ì¹¨</button>
        </div>

        <div class="date-range" id="dateRange">
            <span class="date-info">2025-12-29</span> ~ <span class="date-info">2026-04-08</span>
            <span style="margin-left:10px;">ì´ <strong>101</strong>ì¼</span>
        </div>

        <div class="chart-grid">

            <!-- Chart 1: ë¡œë´‡ì²­ì†Œê¸° ì—°ë„ë³„ ê²€ìƒ‰ëŸ‰ ë¹„êµ -->
            <div class="chart-container">
                <div class="chart-title">ğŸ“ˆ 25ë…„ vs 26ë…„ ë¡œë´‡ì²­ì†Œê¸° ê²€ìƒ‰ëŸ‰ ë¹„êµ</div>
                <canvas id="chart1"></canvas>
            </div>

            <!-- Chart 2: ì—°ë„ë³„ ë¡œë³´ë½ â˜… ìŒì˜ (ë¼ë²¨ ì—†ìŒ, í•˜ë‹¨ ë²”ë¡€) -->
            <div class="chart-container">
                <div class="chart-title">ğŸ“ˆ 25ë…„ vs 26ë…„ ë¡œë³´ë½ ê²€ìƒ‰ëŸ‰ ë¹„êµ</div>
                <canvas id="chart2"></canvas>
                <div class="marketing-legend">
                    <div class="ml-item"><span class="ml-box ml-box-green"></span>25ë…„ ì‚¬ì „ë§ˆì¼€íŒ… (02.05â€“02.20)</div>
                    <div class="ml-item"><span class="ml-dash ml-dash-green"></span>25ë…„ S10 ëŸ°ì¹­ (02.21)</div>
                    <div class="ml-divider"></div>
                    <div class="ml-item"><span class="ml-box ml-box-red"></span>26ë…„ ì‚¬ì „ë§ˆì¼€íŒ… (02.15â€“02.26)</div>
                    <div class="ml-item"><span class="ml-dash ml-dash-red"></span>26ë…„ S10 ëŸ°ì¹­ (02.27)</div>
                </div>
            </div>

            <!-- Chart 3: ì œí’ˆ ëª¨ë¸ë³„ â˜… ìŒì˜ (ë¼ë²¨ ì—†ìŒ, í•˜ë‹¨ ë²”ë¡€) -->
            <div class="chart-container">
                <div class="chart-title">ğŸ“ˆ 25ë…„ vs 26ë…„ ë¡œë³´ë½ ì œí’ˆëª… ê²€ìƒ‰ëŸ‰ ë¹„êµ</div>
                <canvas id="chart3"></canvas>
                <div class="marketing-legend">
                    <div class="ml-item"><span class="ml-box ml-box-green"></span>25ë…„ ì‚¬ì „ë§ˆì¼€íŒ… (02.05â€“02.20)</div>
                    <div class="ml-item"><span class="ml-dash ml-dash-green"></span>25ë…„ S10 ëŸ°ì¹­ (02.21)</div>
                    <div class="ml-divider"></div>
                    <div class="ml-item"><span class="ml-box ml-box-red"></span>26ë…„ ì‚¬ì „ë§ˆì¼€íŒ… (02.15â€“02.26)</div>
                    <div class="ml-item"><span class="ml-dash ml-dash-red"></span>26ë…„ S10 ëŸ°ì¹­ (02.27)</div>
                </div>
            </div>

            <!-- Chart 4: ê²½ìŸì‚¬ ë¶„ì„ â˜… Xì¶• í•˜ë‹¨ íƒ€ì„ë¼ì¸ -->
            <div class="chart-container" id="chart4Container">
                <div class="chart-title">ğŸ“ˆ 26ë…„ ë¡œë´‡ì²­ì†Œê¸° ê²½ìŸì‚¬ë¶„ì„(4ê°œ ì œí’ˆ)</div>
                <div id="chart4Wrap" style="position:relative; height:420px;">
                    <canvas id="chart4"></canvas>
                </div>
                <p class="legend-info" style="margin-top:4px;margin-bottom:0;">ë¡œë³´ë½ S10 Max V Ultra &nbsp;Â·&nbsp; ì‚¼ì„±ë¹„ìŠ¤í¬í¬AIìŠ¤íŒ€ &nbsp;Â·&nbsp; ë“œë¦¬ë¯¸X60 &nbsp;Â·&nbsp; ì—ì½”ë°±ìŠ¤T90</p>
            </div>

            <!-- â•â•â•â•â•â• ê²½ìŸì‚¬ ë¶„ì„ ì¸ì‚¬ì´íŠ¸ â•â•â•â•â•â• -->
            <div class="chart-container full-width" id="competitorInsightWrapper" style="margin-top:0; background:linear-gradient(135deg,#fff9f9 0%,#ffeaea 100%); border:1.5px solid #fecaca;">
                <div class="chart-title" style="border-bottom-color:#c0392b; display:flex; align-items:center; justify-content:space-between; flex-wrap:wrap; gap:8px;">
                    <span>ğŸ” ê²½ìŸì‚¬ ë¶„ì„ ì¸ì‚¬ì´íŠ¸</span>
                    <span id="insightCutoffBadge" style="font-size:0.72em; font-weight:600; background:#fee2e2; color:#c0392b; padding:3px 10px; border-radius:12px; white-space:nowrap;">ë°ì´í„° ë¡œë”© ì¤‘...</span>
                </div>
                <div id="competitorInsights" style="display:grid; grid-template-columns:repeat(3,1fr); gap:16px; padding:16px 4px 4px;">
                    <div style="text-align:center; padding:32px 20px; color:#718096; grid-column:1/-1;">ì°¨íŠ¸ ë°ì´í„° ë¡œë”© í›„ ìë™ ë¶„ì„ë©ë‹ˆë‹¤...</div>
                </div>
            </div>

            <!-- â•â•â•â•â•â•â•â•â•â• ì•„ë“œë¦¬ì—˜ ë§ˆì¼€íŒ… ì„±ê³¼ â•â•â•â•â•â•â•â•â•â• -->
            <!-- â•â•â•â•â•â•â•â•â•â• ì•„ë“œë¦¬ì—˜ ë§ˆì¼€íŒ… ì„±ê³¼ â•â•â•â•â•â•â•â•â•â• -->
            <div class="chart-container full-width" id="adrielWrapper" style="margin-bottom:0;">

                <!-- í—¤ë” -->
                <div class="am-header">
                    <div class="am-header-left">
                        <h2>ğŸ“Š ë§ˆì¼€íŒ… ì±„ë„ ì„±ê³¼ ë¶„ì„ <span style="font-size:.7em;color:#718096;font-weight:400;">(ì•„ë“œë¦¬ì—˜ ì—°ë™)</span></h2>
                        <p>ê´‘ê³ ë¹„ Â· í´ë¦­ìˆ˜ Â· ë…¸ì¶œìˆ˜ Â· ROAS Â· êµ¬ë§¤ìˆ˜ Â· CTR Â· CPC Â· ë§¤ì¶œì•¡ Â· CVR Â· CPA</p>
                    </div>
                    <button class="am-refresh-btn" onclick="loadAdrielData()">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
                </div>

                <!-- ë¡œë”© -->
                <div class="am-loading" id="amLoading">
                    <div class="am-spinner"></div>
                    <p>ì•„ë“œë¦¬ì—˜ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
                </div>

                <!-- ì—ëŸ¬ -->
                <div class="am-error hide" id="amError"></div>

                <!-- ì½˜í…ì¸  -->
                <div class="hide" id="amContent">

                    <!-- KPI ì¹´ë“œ -->
                    <div class="am-kpi-grid" id="amKpiGrid"></div>

                    <!-- ì •ë³´ ë°” -->
                    <div class="am-info-bar">
                        <span>ğŸ“¡ Adriel Widget Export API</span>
                        <span class="am-range" id="amDateRange">â€”</span>
                        <span class="am-warn"  id="amWarn"></span>
                    </div>

                    <!-- íˆ´ë°”: ì¼/ì£¼ í† ê¸€ + ì§€í‘œ ë²„íŠ¼ -->
                    <div class="am-toolbar">
                        <!-- ê¸°ê°„ í† ê¸€ -->
                        <div class="am-period-group">
                            <button class="am-period-btn active" id="amBtnDay"  onclick="amSetPeriod('day',this)">ì¼ë‹¨ìœ„</button>
                            <button class="am-period-btn"        id="amBtnWeek" onclick="amSetPeriod('week',this)">ì£¼ë‹¨ìœ„</button>
                        </div>
                        <div class="am-divider"></div>
                        <!-- ì§€í‘œ ë²„íŠ¼ -->
                        <div class="am-metric-group" id="amMetricGroup">
                            <button class="am-metric-btn active" onclick="amSetMetric('spend',this)">ğŸ’° ê´‘ê³ ë¹„</button>
                            <button class="am-metric-btn"        onclick="amSetMetric('clicks',this)">ğŸ‘† í´ë¦­ìˆ˜</button>
                            <button class="am-metric-btn"        onclick="amSetMetric('impressions',this)">ğŸ‘ ë…¸ì¶œìˆ˜</button>
                            <button class="am-metric-btn"        onclick="amSetMetric('roas',this)">ğŸ“Š ROAS</button>
                            <button class="am-metric-btn"        onclick="amSetMetric('purchases',this)">ğŸ›’ êµ¬ë§¤ìˆ˜</button>
                            <button class="am-metric-btn"        onclick="amSetMetric('ctr',this)">ğŸ“ CTR</button>
                            <button class="am-metric-btn"        onclick="amSetMetric('cpc',this)">ğŸ’µ CPC</button>
                            <button class="am-metric-btn"        onclick="amSetMetric('revenue',this)">ğŸ’ ë§¤ì¶œì•¡</button>
                            <button class="am-metric-btn"        onclick="amSetMetric('cvr',this)">ğŸ”„ CVR</button>
                            <button class="am-metric-btn"        onclick="amSetMetric('cpa',this)">ğŸ¯ CPA</button>
                        </div>
                        <div class="am-divider"></div>
                        <!-- ì±„ë„ í•„í„° -->
                        <div class="am-metric-group" id="amChannelGroup">
                            <button class="am-channel-btn active" onclick="amSetChannel('all',this)">ğŸŒ ì „ì²´</button>
                            <button class="am-channel-btn" onclick="amSetChannel('naverGFA',this)">ë„¤ì´ë²„GFA</button>
                            <button class="am-channel-btn" onclick="amSetChannel('naver',this)">ë„¤ì´ë²„SA</button>
                            <button class="am-channel-btn" onclick="amSetChannel('kakao',this)">ì¹´ì¹´ì˜¤</button>
                            <button class="am-channel-btn" onclick="amSetChannel('facebook',this)">í˜ì´ìŠ¤ë¶</button>
                            <button class="am-channel-btn" onclick="amSetChannel('google_demandgen',this)">êµ¬ê¸€DG</button>
                        </div>
                    </div>

                    <!-- ë¼ì¸ ì°¨íŠ¸ -->
                    <div style="position:relative;height:360px;">
                        <canvas id="amChart"></canvas>
                    </div>
                    <p class="am-chart-legend" id="amChartLegend">ì±„ë„ë³„ ì¼ë³„ ê´‘ê³ ë¹„ ì¶”ì´</p>

                </div><!-- /amContent -->
            </div><!-- /adrielWrapper -->

            <!-- â˜… íŒë§¤ëŸ‰ ë³µí•© ì°¨íŠ¸ (ì „ì²´ í­, ë§¨ ì•„ë˜) -->
            <div class="chart-container full-width" id="salesChartContainer" style="padding-bottom:12px;">
                <div class="chart-title">ğŸ“Š 26ë…„ ë¡œë³´ë½ ì£¼ê°„ íŒë§¤ëŸ‰ & ê²€ìƒ‰ëŸ‰</div>

                <!-- ë·° í† ê¸€ ë²„íŠ¼ -->
                <div class="view-btn-group">
                    <button class="view-btn active" id="btnChannel" onclick="setSalesView('channel')">Channel</button>
                    <button class="view-btn"         id="btnSku"     onclick="setSalesView('sku')">SKU</button>
                    <button class="view-btn"         id="btnRetail"  onclick="setSalesView('retail')">Retail</button>
                </div>

                <!-- ë³µí•© ì°¨íŠ¸ ìº”ë²„ìŠ¤ -->
                <div style="position:relative; height:480px;">
                    <canvas id="salesChart"></canvas>
                </div>

                <!-- í•˜ë‹¨ ë²”ë¡€ ì œê±° -->

                <!-- ê²€ìƒ‰ëŸ‰ ëŒ€ë¹„ íŒë§¤ëŸ‰ ë¹„ìœ¨ í…Œì´ë¸” -->
                <div class="ratio-table-wrap" id="ratioTableWrap" style="margin-top:0;"></div>

                <!-- ë‹¨ì„œì¡°í•­ -->
                <p class="sales-disclaimer">
                    â€» íŒë§¤ëŸ‰ ë°ì´í„°ëŠ” ë¡œë³´ë½ ì•…ì„¸ì„œë¦¬ë¥¼ ì œì™¸í•œ ì „ì²´ ë³¸í’ˆ ê¸°ì¤€ì˜ ì˜¨/ì˜¤í”„ë¼ì¸ ì „ì²´ì´ë©° ì˜ì—…ê´€ë¦¬ì˜ PSIìë£Œ ê¸°ë°˜ì…ë‹ˆë‹¤.
                </p>
            </div>

            <!-- â•â•â•â•â•â•â•â•â•â• ì‹¤ì‹œê°„ ë°ì´í„° ë¶„ì„ ì¸ì‚¬ì´íŠ¸ â•â•â•â•â•â•â•â•â•â• -->
            <div class="chart-container full-width" id="insightWrapper" style="margin-top:20px; background:#f8fafc; border:1.5px solid #e2e8f0;">
                <div class="chart-title" style="border-bottom-color:#c0392b;">ğŸ” ì‹¤ì‹œê°„ ë°ì´í„° ë¶„ì„ ì¸ì‚¬ì´íŠ¸</div>
                <div id="dynamicInsights" style="display:grid; grid-template-columns:repeat(3,1fr); gap:16px; padding:16px 4px 4px;">
                    <div style="text-align:center; padding:32px 20px; color:#718096; grid-column:1/-1;">ë°ì´í„° ë¶„ì„ ì¤‘...</div>
                </div>
            </div>

        </div><!-- /chart-grid -->
    </div><!-- /mainContent -->
</div><!-- /container -->

<script>
    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       ìƒìˆ˜
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    const GOOGLE_SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTZ2StdU313UFct0BPPN6JwG73pdglCTLbjwpt3wJZ6R5ifzWMyZo8KpqMuTsE-sw/pub?gid=169813989&single=true&output=csv";
    const SALES_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vT0yD7fDrh9xrgXGgX2jO3HNKr6-UOqpYDG6g7IC8hpIxgrIUpYDpgsD9jtFOXpkQ/pub?gid=1807117921&single=true&output=csv";
    const CORS_PROXIES = [
        'https://corsproxy.io/?',
        'https://api.allorigins.win/raw?url='
    ];

    /*
     * ë§ˆì¼€íŒ… ì´ë²¤íŠ¸ ë‚ ì§œ
     * ë‚ ì§œ ì¶• = 2026ë…„ ê¸°ì¤€ (25ë…„ ë°ì´í„°ë„ 2026 ë‚ ì§œ í–‰ì— ë‚˜ë€íˆ ì €ì¥ëœ êµ¬ì¡°)
     *
     * [ë¡œë³´ë½] 25ë…„: ì‚¬ì „ 02.05~02.20, ëŸ°ì¹­ 02.21
     *          26ë…„: ì‚¬ì „ 02.15~02.26, ëŸ°ì¹­ 02.27
     * [ì‚¼ì„±]        ì‚¬ì „ì˜ˆì•½ 02.11~03.02, ëŸ°ì¹­ 03.03
     * [ë“œë¦¬ë¯¸]      ì‚¬ì „ë§ˆì¼€íŒ… 02.23~03.08, ëŸ°ì¹­ 03.09
     */
    const EVT = {
        // ë¡œë³´ë½ 25ë…„ (ì´ˆë¡)
        rr25PreStart : '2026-02-05',
        rr25PreEnd   : '2026-02-20',
        rr25Launch   : '2026-02-21',
        // ë¡œë³´ë½ 26ë…„ (ë¹¨ê°•)
        rr26PreStart : '2026-02-15',
        rr26PreEnd   : '2026-02-26',
        rr26Launch   : '2026-02-27',
        // ì‚¼ì„± (ì§„íŒŒë‘)
        ssPreStart   : '2026-02-11',
        ssPreEnd     : '2026-03-02',
        ssLaunch     : '2026-03-03',
        // ë“œë¦¬ë¯¸ (í•˜ëŠ˜íŒŒë‘)
        dmPreStart   : '2026-02-23',
        dmPreEnd     : '2026-03-08',
        dmLaunch     : '2026-03-09'
    };

    let allData    = [];
    let charts     = {};
    let salesChart = null;          // íŒë§¤ëŸ‰ ë³µí•© ì°¨íŠ¸ ì¸ìŠ¤í„´ìŠ¤
    let salesRaw   = [];            // íŒë§¤ ì›ë³¸ í–‰ [{model, channel, retailer, wkData}]
    let currentSalesView = 'channel'; // 'channel' | 'sku' | 'retail'

    /* â”€â”€ WK ì£¼ì°¨ â†’ ë‚ ì§œ ë§¤í•‘ (WK1 ì‹œì‘: 2025-12-29 ì›”ìš”ì¼) â”€â”€
     *  WK1  = 2025-12-29 ~ 2026-01-04  (ì¤‘ê°„ì  Wed 2026-01-01)
     *  WK2  = 2026-01-05 ~ 2026-01-11  (Wed 2026-01-07)
     *  WKn  ì‹œì‘ = 2025-12-29 + (n-1)*7ì¼
     *  ì¤‘ê°„ì (ìˆ˜ìš”ì¼) = ì‹œì‘ + 2ì¼
     *  WK1 index = 1, ..., WK52 = 52
    â”€â”€ */
    const WK_START_BASE = new Date('2025-12-29T00:00:00');  // WK1 ì‹œì‘ Monday
    function wkToDateStr(wkNum) {
        // ë°˜í™˜ê°’: ìˆ˜ìš”ì¼(ì¤‘ê°„ì ) ISO string YYYY-MM-DD
        const d = new Date(WK_START_BASE);
        d.setDate(d.getDate() + (wkNum - 1) * 7 + 2); // +2 = Wednesday
        return d.toISOString().slice(0, 10);
    }
    function wkToRange(wkNum) {
        const s = new Date(WK_START_BASE);
        s.setDate(s.getDate() + (wkNum - 1) * 7);
        const e = new Date(s);
        e.setDate(e.getDate() + 6);
        return {
            start: s.toISOString().slice(0, 10),
            end:   e.toISOString().slice(0, 10),
            label: `WK${wkNum}\n${(s.getMonth()+1).toString().padStart(2,'0')}/${s.getDate().toString().padStart(2,'0')}`
        };
    }

    /* â”€â”€ ëª¨ë¸ëª… ì •ê·œí™”: ì»¬ëŸ¬/ë²„ì „ ì œê±°í•˜ì—¬ ìˆœìˆ˜ ëª¨ë¸ëª… ì¶”ì¶œ â”€â”€
     *  ì˜ˆ) "S9 MaxV Ultra(í™”ì´íŠ¸)" â†’ "S9 MaxV Ultra"
     *      "S9 MaxV Ultraì§ë°°ìˆ˜(ë¸”ë™)" â†’ "S9 MaxV Ultraì§ë°°ìˆ˜"
     *      "F25 Ace Combo" â†’ "F25 Ace Combo"  (ê´„í˜¸ ì—†ìœ¼ë©´ ê·¸ëŒ€ë¡œ)
    â”€â”€ */
    function normalizeModel(raw) {
        return raw.replace(/\s*[\(\[ï¼ˆã€][^\)\]ï¼‰ã€‘]*[\)\]ï¼‰ã€‘]\s*/g, '').trim();
    }

    /* â”€â”€ íŒë§¤ ë°ì´í„° ë¡œë“œ (CSV íŒŒì‹±) â”€â”€ */
    async function loadSalesData() {
        let csv = null;
        for (const proxy of CORS_PROXIES) {
            try { csv = await tryFetch(proxy, SALES_URL); break; } catch(e) {}
        }
        if (!csv) {
            try { const r = await fetch(SALES_URL); if (r.ok) csv = await r.text(); } catch(e) {}
        }
        if (!csv) { console.warn('íŒë§¤ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨'); return; }

        Papa.parse(csv, {
            header: false,
            skipEmptyLines: true,
            complete(res) {
                const rows = res.data;
                const hdr  = rows[0]; // header row
                // WK ì»¬ëŸ¼ ì¸ë±ìŠ¤ ë§¤í•‘ (hdr[i] = 'WK1' ~ 'WK52')
                const wkMap = {}; // wkNum â†’ colIndex
                hdr.forEach((h, i) => {
                    const m = h.trim().match(/^WK(\d+)$/);
                    if (m) wkMap[parseInt(m[1])] = i;
                });

                salesRaw = [];
                for (let r = 1; r < rows.length; r++) {
                    const row = rows[r];
                    if (row.length < 8) continue;
                    const model    = (row[0] || '').trim();
                    const retailer = (row[5] || '').trim();
                    const channel  = (row[6] || '').trim();
                    if (!model || !channel) continue;

                    const wkData = {};
                    Object.entries(wkMap).forEach(([wk, ci]) => {
                        const v = parseFloat((row[ci] || '').replace(/,/g,''));
                        if (!isNaN(v) && v > 0) wkData[parseInt(wk)] = v;
                    });
                    salesRaw.push({ model: normalizeModel(model), channel, retailer, wkData });
                }
                console.log(`íŒë§¤ ë°ì´í„° ë¡œë“œ ì™„ë£Œ: ${salesRaw.length}í–‰`);
                renderSalesChart();
                // íŒë§¤ ë°ì´í„° ë¡œë“œ ì™„ë£Œ í›„ ì¸ì‚¬ì´íŠ¸ ê°±ì‹ 
                setTimeout(updateInsights, 300);
            }
        });
    }

    /* â”€â”€ ê·¸ë£¹ ì§‘ê³„: ë·° íƒ€ì…ì— ë”°ë¼ WKë³„ ê·¸ë£¹ í•©ì‚° â”€â”€ */
    function aggregateSales(viewType) {
        const groupWk = {}; // { groupName: { wkNum: total } }
        salesRaw.forEach(row => {
            let key;
            if (viewType === 'channel')  key = row.channel;
            else if (viewType === 'sku') key = row.model;
            else                         key = row.retailer;
            if (!key) key = 'ê¸°íƒ€';
            if (!groupWk[key]) groupWk[key] = {};
            Object.entries(row.wkData).forEach(([wk, v]) => {
                const w = parseInt(wk);
                groupWk[key][w] = (groupWk[key][w] || 0) + v;
            });
        });
        return groupWk;
    }

    /* â”€â”€ ì‚¬ìš© ì¤‘ì¸ WK ë²”ìœ„ ê³„ì‚° (ë°ì´í„° ìˆëŠ” WKë§Œ) â”€â”€ */
    function getActiveWks(groupWk) {
        const wkSet = new Set();
        Object.values(groupWk).forEach(wkd => Object.keys(wkd).forEach(w => wkSet.add(parseInt(w))));
        return [...wkSet].sort((a,b)=>a-b).filter(w => w >= 1); // WK1 ì´ìƒë§Œ (WK52prev ì œì™¸)
    }

    /* â”€â”€ íŒ”ë ˆíŠ¸ â”€â”€ */
    const SALES_PALETTE = [
        'rgba(79,134,247,0.82)',   // íŒŒë‘  - Social MP / Coupang
        'rgba(249,115,22,0.82)',   // ì˜¤ë Œì§€ - MOH
        'rgba(167,139,250,0.82)',  // ë³´ë¼  - TradMP
        'rgba(52,211,153,0.82)',   // ë¯¼íŠ¸  - PP gen
        'rgba(251,191,36,0.82)',   // ë…¸ë‘  - GES Chain
        'rgba(96,165,250,0.82)',   // í•˜ëŠ˜  - Department Store
        'rgba(244,114,182,0.82)',  // í•‘í¬  - Flagship
        'rgba(16,185,129,0.82)',   // ì´ˆë¡  - NAVER
        'rgba(252,211,77,0.82)',   // ì—°ë…¸  - Hypermarket
        'rgba(99,102,241,0.82)',   // ì¸ë””ê³  - Official
        'rgba(203,213,225,0.82)'   // íšŒìƒ‰  - ê¸°íƒ€
    ];
    // ì±„ë„ ê³ ì • ìƒ‰ìƒ (Channel ë·° ì¼ê´€ì„±)
    const CH_COLOR_MAP = {
        'Social MP':'rgba(79,134,247,0.82)',
        'MOH':'rgba(249,115,22,0.82)',
        'TradMP':'rgba(167,139,250,0.82)',
        'PP gen':'rgba(52,211,153,0.82)',
        'GES Chain':'rgba(251,191,36,0.82)',
        'Department Store':'rgba(96,165,250,0.82)',
        'Flagship Store':'rgba(244,114,182,0.82)',
        'NAVER':'rgba(16,185,129,0.82)',
        'Hypermarket':'rgba(252,211,77,0.82)',
        'Official Online Store':'rgba(99,102,241,0.82)',
        'ê¸°íƒ€':'rgba(203,213,225,0.82)'
    };
    function getColor(name, idx, viewType) {
        if (viewType === 'channel' && CH_COLOR_MAP[name]) return CH_COLOR_MAP[name];
        return SALES_PALETTE[idx % SALES_PALETTE.length];
    }

    /* â”€â”€ ê²€ìƒ‰ëŸ‰: WK ê¸°ê°„ ë‚´ í•©ì‚° (null/0 ì œì™¸) â”€â”€ */
    function calcSearchForWk(wkNum) {
        if (!allData.length) return null;
        const range = wkToRange(wkNum);
        const slice = allData.filter(d => d['ë‚ ì§œ'] >= range.start && d['ë‚ ì§œ'] <= range.end);
        const vals  = slice.map(d => d['26 .ë¡œë³´ë½']).filter(v => v != null && v > 0);
        if (!vals.length) return null;
        return vals.reduce((a,b)=>a+b, 0);   // â† í•©ì‚°
    }

    /* â”€â”€ íŒë§¤ëŸ‰ ë³µí•© ì°¨íŠ¸ ë Œë”ë§ â”€â”€ */
    function renderSalesChart() {
        if (!salesRaw.length) return;

        const viewType  = currentSalesView;
        const groupWk   = aggregateSales(viewType);
        const activeWks = getActiveWks(groupWk);

        /* â”€â”€ ì „ì²´ ê¸°ê°„ í•©ì‚° ê¸°ì¤€ ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬ â”€â”€ */
        const groupTotals = {};
        Object.entries(groupWk).forEach(([g, wkd]) => {
            groupTotals[g] = Object.values(wkd).reduce((a,b)=>a+b, 0);
        });
        const sortedGroups = Object.keys(groupTotals)
            .sort((a, b) => groupTotals[b] - groupTotals[a]);

        /* â”€â”€ ìƒìœ„ 10ê°œ + ê¸°íƒ€ â”€â”€ */
        const TOP_N      = 10;
        const topGroups  = sortedGroups.slice(0, TOP_N);   // index 0 = ìµœê³  íŒë§¤
        const restGroups = sortedGroups.slice(TOP_N);
        const etcWk = {};
        if (restGroups.length) {
            activeWks.forEach(w => {
                etcWk[w] = restGroups.reduce((s,g) => s + (groupWk[g]?.[w]||0), 0);
            });
            groupWk['ê¸°íƒ€'] = etcWk;
            topGroups.push('ê¸°íƒ€');
        }
        /* finalGroups[0] = ê°€ì¥ ë§ì€ í•­ëª©  (íŒë§¤ë¹„ì¤‘ ë‚´ë¦¼ì°¨ìˆœ) */
        const finalGroups = topGroups;

        /* â”€â”€ Xì¶• ë ˆì´ë¸” â”€â”€ */
        const wkDisplayLabels = activeWks.map(w => { const r=wkToRange(w); return r.label; });
        const wkCatLabels     = activeWks.map(w => 'WK' + w);   // 'WK1','WK2',...

        /* â”€â”€ ê²€ìƒ‰ëŸ‰ í•©ì‚° â”€â”€ */
        const searchVals = activeWks.map(w => calcSearchForWk(w));

        /* â”€â”€ ì£¼ê°„ ì´ íŒë§¤ â”€â”€ */
        const totalSales = activeWks.map(w =>
            finalGroups.reduce((s,g) => s + (groupWk[g]?.[w]||0), 0)
        );

        /* â”€â”€ ê²€ìƒ‰ëŸ‰ ëŒ€ë¹„ íŒë§¤ ë¹„ìœ¨ â”€â”€ */
        const ratios = activeWks.map((w,i) => {
            const sv = searchVals[i], tv = totalSales[i];
            return (sv && tv) ? (tv/sv*100).toFixed(1) : null;
        });

        /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
         *  ë§‰ëŒ€ ë°ì´í„°ì…‹
         *  ìŠ¤íƒ: ê°€ì¥ ë§ì€ í•­ëª©ì´ ë§¨ ìœ„ì— ì˜¤ë„ë¡ ì—­ìˆœ ë°°ì—´
         *  (Chart.js: ì²« dataset â†’ ë°”ë‹¥, ë§ˆì§€ë§‰ dataset â†’ ê¼­ëŒ€ê¸°)
         * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        const barDatasets = [...finalGroups].reverse().map(g => {
            const origIdx = finalGroups.indexOf(g);
            const color   = getColor(g, origIdx, viewType);
            return {
                type: 'bar',
                label: g,
                data: activeWks.map(w => groupWk[g]?.[w] || null),
                backgroundColor: color,
                borderColor: color.replace('0.82','1'),
                borderWidth: 0.5,
                stack: 'sales',
                yAxisID: 'yLeft',
                order: 2,
                datalabels: {
                    display: (ctx) => {
                        const v = ctx.dataset.data[ctx.dataIndex];
                        return v && v >= 50; // 50ëŒ€ ë¯¸ë§Œ ìˆ¨ê¹€
                    },
                    color: '#fff',
                    anchor: 'center',
                    align: 'center',
                    font: { size: 10, weight: '700' },
                    formatter: (v) => {
                        if (!v || v < 50) return null;
                        return (v / 1000).toFixed(1) + 'k';
                    }
                }
            };
        });

        /* â”€â”€ ê²€ìƒ‰ëŸ‰ ë¼ì¸ â”€â”€ */
        const lineDataset = {
            type: 'line',
            label: '26 ë¡œë³´ë½ ê²€ìƒ‰ëŸ‰',
            data: searchVals.map(v => (v !== null && v > 0) ? v : NaN),
            borderColor: 'rgb(220,38,38)',
            backgroundColor: 'transparent',
            borderWidth: 2.5,
            pointRadius: 3,
            pointHoverRadius: 5,
            tension: 0.4,
            yAxisID: 'yRight',
            order: 1,
            spanGaps: false,
            datalabels: { display: false }
        };

        /* â”€â”€ annotation ì œê±° (ì‚¬ì „ë§ˆì¼€íŒ… í‘œì‹œ ì‚­ì œ) â”€â”€ */
        const salesAnnotations = {};

        /* â”€â”€ ì°¨íŠ¸ ìƒì„± â”€â”€ */
        const ctx = document.getElementById('salesChart').getContext('2d');
        if (salesChart) salesChart.destroy();
        const isMobile = window.innerWidth <= 768;

        /* ì£¼ê°„ ì´ íŒë§¤ ë ˆì´ë¸” í”ŒëŸ¬ê·¸ì¸ */
        const totalLabelPlugin = {
            id: 'salesTotalLabel',
            afterDatasetsDraw(chart) {
                const dCtx = chart.ctx;
                const meta0 = chart.getDatasetMeta(0); // ì²« bar dataset
                if (!meta0 || !meta0.data) return;
                const nBars = meta0.data.length;
                for (let i = 0; i < nBars; i++) {
                    const total = totalSales[i];
                    if (!total) continue;
                    // ìŠ¤íƒ ì¤‘ ê°€ì¥ ë†’ì€ y ì¢Œí‘œ ì°¾ê¸°
                    let topY = Infinity;
                    chart.data.datasets.forEach((ds, di) => {
                        if (ds.type !== 'bar') return;
                        const m = chart.getDatasetMeta(di);
                        if (m && m.data[i]) {
                            const y = m.data[i].y;
                            if (y < topY) topY = y;
                        }
                    });
                    if (topY === Infinity) continue;
                    const label = (total / 1000).toFixed(1) + 'k';
                    dCtx.save();
                    dCtx.font = `bold ${isMobile ? 9 : 11}px sans-serif`;
                    dCtx.fillStyle = '#1a202c';
                    dCtx.textAlign = 'center';
                    dCtx.textBaseline = 'bottom';
                    dCtx.fillText(label, meta0.data[i].x, topY - 3);
                    dCtx.restore();
                }
            }
        };

        salesChart = new Chart(ctx, {
            type: 'bar',
            data: { labels: wkCatLabels, datasets: [...barDatasets, lineDataset] },
            plugins: [ChartDataLabels, totalLabelPlugin, {
                id: 'alignRatioTable',
                afterRender(chart) {
                    try {
                        const ca        = chart.chartArea;
                        const leftPad   = Math.round(ca.left);
                        const rightPad  = Math.round(chart.width - ca.right);
                        const dataW     = ca.right - ca.left;
                        const nWk       = activeWks.length;
                        const colW      = Math.round(dataW / nWk);
                        const wrap      = document.getElementById('ratioTableWrap');
                        if (!wrap) return;

                        /* ì™¼ìª½ ë¼ë²¨ ì—´ ë„ˆë¹„ = ì°¨íŠ¸ Yì¶• ì˜ì—­ */
                        wrap.querySelectorAll('.ratio-label-col').forEach(el => {
                            el.style.width    = leftPad + 'px';
                            el.style.minWidth = leftPad + 'px';
                            el.style.maxWidth = leftPad + 'px';
                        });
                        /* ë°ì´í„° ì…€ ë„ˆë¹„ = ê° ë°” ë„ˆë¹„ */
                        wrap.querySelectorAll('.ratio-data-col').forEach(el => {
                            el.style.width    = colW + 'px';
                            el.style.minWidth = colW + 'px';
                            el.style.maxWidth = colW + 'px';
                        });
                        /* ì˜¤ë¥¸ìª½ íŒ¨ë”© = ìš°ì¸¡ Yì¶• ê³µê°„ */
                        wrap.style.paddingRight = rightPad + 'px';
                        wrap.style.paddingLeft  = '0px';
                    } catch(e) {}
                }
            }],
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: { mode: 'index', intersect: false },
                plugins: {
                    legend: {
                        display: true, position: 'top',
                        labels: {
                            usePointStyle: true,
                            padding: isMobile ? 6 : 12,
                            font: { size: isMobile ? 9 : 11 },
                            boxWidth: isMobile ? 8 : 11,
                            /* â˜… íŒë§¤ë¹„ì¤‘ ë†’ì€ ìˆœì„œë¡œ ë²”ë¡€ ì •ë ¬ */
                            generateLabels(chart) {
                                const defs = Chart.defaults.plugins.legend.labels.generateLabels(chart);
                                const bars = defs.filter(l => l.text !== '26 ë¡œë³´ë½ ê²€ìƒ‰ëŸ‰');
                                bars.sort((a, b) => {
                                    const ai = finalGroups.indexOf(a.text);
                                    const bi = finalGroups.indexOf(b.text);
                                    return (ai === -1 ? 9999 : ai) - (bi === -1 ? 9999 : bi);
                                });
                                return bars;
                            }
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0,0,0,0.85)',
                        padding: isMobile ? 7 : 11,
                        /* â˜… íˆ´íŒ: ì „ì²´ íŒë§¤ë¹„ì¤‘ ë†’ì€ ìˆœ(finalGroups ìˆœì„œ) */
                        itemSort: (a, b) => {
                            if (a.dataset.type === 'line') return 1;
                            if (b.dataset.type === 'line') return -1;
                            const ai = finalGroups.indexOf(a.dataset.label);
                            const bi = finalGroups.indexOf(b.dataset.label);
                            return ai - bi;  // 0 = ìµœê³  â†’ ë¨¼ì € í‘œì‹œ
                        },
                        callbacks: {
                            title(items) {
                                if (!items.length) return '';
                                const i = items[0].dataIndex;
                                return wkDisplayLabels[i].replace('\n', ' ');
                            },
                            label(c) {
                                if (isNaN(c.parsed.y) || c.parsed.y === null) return null;
                                const v   = c.parsed.y;
                                const fmt = v >= 1000 ? (v/1000).toFixed(1)+'k' : Math.round(v);
                                return `${c.dataset.label}: ${fmt}`;
                            },
                            afterBody(items) {
                                const i = items[0]?.dataIndex;
                                if (i == null) return [];
                                const lines = ['â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€'];
                                if (totalSales[i])  lines.push(`ì£¼ì°¨ ì´ íŒë§¤: ${totalSales[i].toLocaleString()}ëŒ€`);
                                if (searchVals[i])  lines.push(`ê²€ìƒ‰ëŸ‰ í•©ì‚°: ${Math.round(searchVals[i]).toLocaleString()}`);
                                if (ratios[i])      lines.push(`íŒë§¤/ê²€ìƒ‰ ë¹„ìœ¨: ${ratios[i]}%`);
                                return lines;
                            }
                        }
                    },
                    annotation: { annotations: salesAnnotations }
                },
                scales: {
                    x: {
                        type: 'category',
                        stacked: true,
                        grid: { display: false },
                        ticks: {
                            font: { size: isMobile ? 8 : 10 },
                            maxRotation: isMobile ? 45 : 0,
                            autoSkip: false
                        }
                    },
                    yLeft: {
                        type: 'linear', position: 'left', stacked: true,
                        title: { display: !isMobile, text: 'íŒë§¤ëŸ‰ (ëŒ€)', font:{size:11}, color:'#374151' },
                        grid: { color: 'rgba(0,0,0,0.05)' },
                        ticks: { font:{size:isMobile?8:10}, callback: v => v>=1000?(v/1000).toFixed(0)+'k':v }
                    },
                    yRight: {
                        type: 'linear', position: 'right',
                        title: { display: !isMobile, text: 'ê²€ìƒ‰ëŸ‰ í•©ì‚°', font:{size:11}, color:'rgb(220,38,38)' },
                        grid: { drawOnChartArea: false },
                        ticks: {
                            font: {size:isMobile?8:10},
                            color: 'rgb(220,38,38)',
                            callback: v => v>=1000?(v/1000).toFixed(0)+'k':v
                        }
                    }
                }
            }
        });

        /* ë¹„ìœ¨ + ìƒì„¸ í…Œì´ë¸” ë Œë”ë§ */
        renderRatioTable(activeWks, wkCatLabels, wkDisplayLabels, totalSales, searchVals, ratios, finalGroups, groupWk, viewType);
    }

    /* â”€â”€ ë¹„ìœ¨ í…Œì´ë¸” + ê·¸ë£¹ ìƒì„¸ â”€â”€ */
    function renderRatioTable(activeWks, wkCatLabels, wkDisplayLabels, totalSales, searchVals, ratios,
                               finalGroups, groupWk, viewType) {
        const wrap = document.getElementById('ratioTableWrap');
        if (!wrap) return;

        const viewLabel = viewType === 'channel' ? 'Channel'
                        : viewType === 'sku'     ? 'SKU(ëª¨ë¸)'
                        :                         'Retail';

        /* â”€â”€ ì´í•© ê³„ì‚° â”€â”€ */
        const totalSearchSum = searchVals.reduce((s, v) => s + (v||0), 0);
        const totalSalesSum  = totalSales.reduce((s, v) => s + (v||0), 0);
        const overallRatio   = (totalSearchSum && totalSalesSum)
                               ? (totalSalesSum / totalSearchSum * 100).toFixed(1) : null;

        /* â”€â”€ ê³µí†µ í—¤ë” í–‰ ë¹Œë” â”€â”€ */
        function buildHeaderRow(firstColLabel) {
            let h = '<tr>';
            h += `<th class="ratio-label-col" style="text-align:left;font-size:0.7em;padding:3px 2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${firstColLabel}</th>`;
            activeWks.forEach((w, i) => {
                const dp = (wkDisplayLabels[i]||'').split('\n')[1] || '';
                h += `<th class="ratio-data-col">WK${w}<br><span style="font-weight:400;color:#64748b;font-size:0.8em;">${dp}</span></th>`;
            });
            /* ì´í•© ì—´ */
            h += `<th class="ratio-total-col">ì´í•©</th>`;
            h += '</tr>';
            return h;
        }

        let html = '';

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           í‘œ 1: ì£¼ì°¨ë³„ ìš”ì•½ (ê²€ìƒ‰ëŸ‰ / íŒë§¤ëŸ‰ / ë¹„ìœ¨)
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        html += '<div class="ratio-section-title">ğŸ“‹ ì£¼ì°¨ë³„ ìš”ì•½</div>';
        html += '<table class="ratio-table"><thead>' + buildHeaderRow('í•­ëª©') + '</thead><tbody>';

        /* ê²€ìƒ‰ëŸ‰ í–‰ */
        html += '<tr class="ratio-row-search"><td class="ratio-label-col" style="font-size:0.7em;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">ğŸ”ê²€ìƒ‰ëŸ‰</td>';
        searchVals.forEach(v => { html += `<td class="ratio-data-col">${v ? Math.round(v).toLocaleString() : 'â€“'}</td>`; });
        html += `<td class="ratio-total-col ratio-total-search">${totalSearchSum ? Math.round(totalSearchSum).toLocaleString() : 'â€“'}</td>`;
        html += '</tr>';

        /* íŒë§¤ëŸ‰ í–‰ */
        html += '<tr class="ratio-row-sales"><td class="ratio-label-col" style="font-size:0.7em;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">ğŸ“¦íŒë§¤ëŸ‰</td>';
        totalSales.forEach(v => { html += `<td class="ratio-data-col">${v ? v.toLocaleString() : 'â€“'}</td>`; });
        html += `<td class="ratio-total-col ratio-total-sales">${totalSalesSum ? totalSalesSum.toLocaleString() : 'â€“'}</td>`;
        html += '</tr>';

        /* ë¹„ìœ¨ í–‰ */
        html += '<tr class="ratio-row-ratio"><td class="ratio-label-col" style="font-size:0.7em;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">ğŸ“Šë¹„ìœ¨</td>';
        ratios.forEach(r => { html += `<td class="ratio-data-col ratio-pct">${r !== null ? r+'%' : 'â€“'}</td>`; });
        html += `<td class="ratio-total-col ratio-pct">${overallRatio ? overallRatio+'%' : 'â€“'}</td>`;
        html += '</tr>';

        html += '</tbody></table>';

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           í‘œ 2: Channel / SKU / Retail ìƒì„¸ íŒë§¤ëŸ‰
           íŒë§¤ëŸ‰ í•©ê³„ ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬ (ê¸°íƒ€ í•­ìƒ ë§¨ ì•„ë˜)
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        html += `<div class="ratio-section-title" style="margin-top:14px;">ğŸ“¦ ${viewLabel} ìƒì„¸ íŒë§¤ëŸ‰</div>`;
        html += '<table class="ratio-table"><thead>' + buildHeaderRow(viewLabel) + '</thead><tbody>';

        /* ê¸°íƒ€ë¥¼ ì œì™¸í•œ ê·¸ë£¹ ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬ í›„ ê¸°íƒ€ë¥¼ ë§¨ ë’¤ì— ì¶”ê°€ */
        const nonEtc = finalGroups.filter(g => g !== 'ê¸°íƒ€');
        const etcArr = finalGroups.filter(g => g === 'ê¸°íƒ€');
        const sortedDetail = [
            ...nonEtc.sort((a, b) => {
                const ta = activeWks.reduce((s,w) => s+(groupWk[a]?.[w]||0), 0);
                const tb = activeWks.reduce((s,w) => s+(groupWk[b]?.[w]||0), 0);
                return tb - ta;
            }),
            ...etcArr
        ];

        sortedDetail.forEach((g) => {
            const gIdx   = finalGroups.indexOf(g);
            const wkVals = activeWks.map(w => groupWk[g]?.[w] || 0);
            const rowTotal = wkVals.reduce((s,v) => s+v, 0);
            if (!rowTotal) return;

            const color = getColor(g, gIdx >= 0 ? gIdx : finalGroups.length - 1, viewType);
            const chip  = `<span style="display:inline-block;width:8px;height:8px;border-radius:2px;background:${color};margin-right:3px;vertical-align:middle;flex-shrink:0;"></span>`;
            const label = g.length > 14 ? g.slice(0,13)+'â€¦' : g;

            html += '<tr class="ratio-row-group">';
            html += `<td class="ratio-label-col" title="${g}" style="text-align:left;font-size:0.72em;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${chip}<span style="vertical-align:middle;">${label}</span></td>`;
            wkVals.forEach(v => { html += `<td class="ratio-data-col">${v ? v.toLocaleString() : ''}</td>`; });
            html += `<td class="ratio-total-col ratio-total-group">${rowTotal.toLocaleString()}</td>`;
            html += '</tr>';
        });

        html += '</tbody></table>';
        wrap.innerHTML = html;
    }

        /* â”€â”€ ë·° ì „í™˜ â”€â”€ */
    function setSalesView(viewType) {
        currentSalesView = viewType;
        ['channel','sku','retail'].forEach(v => {
            const btn = document.getElementById('btn' + v.charAt(0).toUpperCase() + v.slice(1));
            if (btn) btn.classList.toggle('active', v === viewType);
        });
        renderSalesChart();
    }

    

    /* â”€â”€ S10 ì˜ˆì¸¡ ê³µìš© í•¨ìˆ˜ (chart3 / chart4 ê³µìœ ) â”€â”€ */
    function buildS10PredictionForChart(fd) {
        const S9_KEY  = 'S9 Max V Ultra';
        const S10_KEY = 'S10 Max V Ultra';
        const LAUNCH_OFFSET_DAYS = 6; // S10 ì¶œì‹œ(02-27) - S9 ì°¨íŠ¸ê¸°ì¤€(02-21) = 6ì¼

        const { dateStr: cutoffDate } = getDataCutoff();

        const addDays = (dateStr, n) => {
            const d = new Date(dateStr + 'T00:00:00Z');
            d.setUTCDate(d.getUTCDate() + n);
            return d.toISOString().slice(0,10);
        };

        // S9/S10 ë§µ
        const s9Map = {}, s10Map = {};
        fd.forEach(d => {
            const v9 = parseFloat(d[S9_KEY]);
            if (v9 > 0) s9Map[d['ë‚ ì§œ']] = v9;
            const v10 = parseFloat(d[S10_KEY]);
            if (d['ë‚ ì§œ'] <= cutoffDate && v10 > 0) s10Map[d['ë‚ ì§œ']] = v10;
        });

        const s10D    = cutoffDate;
        const s9D     = addDays(s10D, -LAUNCH_OFFSET_DAYS);
        const s10Start = addDays(s10D, -6);
        const s9Start  = addDays(s9D,  -6);

        // 7ì¼ í•©ì‚°
        const s10Sum7 = fd.reduce((t, d) => {
            if (d['ë‚ ì§œ'] >= s10Start && d['ë‚ ì§œ'] <= s10D) { t += (s10Map[d['ë‚ ì§œ']] || 0); } return t;
        }, 0);
        const s9Sum7 = fd.reduce((t, d) => {
            if (d['ë‚ ì§œ'] >= s9Start && d['ë‚ ì§œ'] <= s9D) { t += (parseFloat(d[S9_KEY]) > 0 ? parseFloat(d[S9_KEY]) : 0); } return t;
        }, 0);

        const predRatio = s9Sum7 > 0 ? (s10Sum7 / s9Sum7) : null;
        const anchorS10 = s10Map[s10D] || null;

        if (predRatio === null || anchorS10 === null) {
            return { predDataset: null, disclaimer: null };
        }

        const futureDates = fd.filter(d => d['ë‚ ì§œ'] > cutoffDate).map(d => d['ë‚ ì§œ']);
        if (!futureDates.length) return { predDataset: null, disclaimer: null };

        const pts = [{ x: s10D, y: anchorS10 }];
        futureDates.forEach(date => {
            const s9DateForPred = addDays(date, -LAUNCH_OFFSET_DAYS);
            const s9v = s9Map[s9DateForPred];
            if (s9v && s9v > 0) pts.push({ x: date, y: Math.round(s9v * predRatio) });
        });

        const predDataset = pts.length > 1 ? {
            label: 'ğŸ“ˆ S10 ì˜ˆì¸¡ (S9íŒ¨í„´ ê¸°ë°˜)',
            data: pts,
            borderColor: 'rgba(220,38,38,0.55)',
            backgroundColor: 'rgba(220,38,38,0.06)',
            borderWidth: 2,
            borderDash: [7, 4],
            tension: 0.4,
            fill: true,
            pointRadius: 0,
            pointHoverRadius: 4,
            spanGaps: false,
            order: -1
        } : null;

        const disclaimer = {
            s9Sum7, s10Sum7, predRatio,
            s9Start, s9End: s9D, s10Start, s10D,
            LAUNCH_OFFSET_DAYS, anchorS10
        };

        return { predDataset, disclaimer };
    }

    /* â”€â”€ chart3 ë‹¨ì„œì¡°í•­ â”€â”€ */
    function updateChart3Disclaimer(disclaimer) {
        let el = document.getElementById('chart3Disclaimer');
        if (!el) {
            el = document.createElement('p');
            el.id = 'chart3Disclaimer';
            el.style.cssText = 'font-size:0.72em;color:#64748b;margin-top:6px;margin-bottom:0;line-height:1.6;padding:8px 10px;background:#f8fafc;border-radius:6px;border-left:3px solid #cbd5e1;';
            const c3canvas = document.getElementById('chart3');
            if (c3canvas) c3canvas.parentNode.insertBefore(el, c3canvas.nextSibling);
        }
        if (disclaimer) {
            const { s9Sum7, s10Sum7, predRatio, s9Start, s9End, s10Start, s10D, LAUNCH_OFFSET_DAYS } = disclaimer;
            el.innerHTML =
                `<strong>â€» ì˜ˆì¸¡ ë¼ì¸ ì„¤ëª… (S10 Max V Ultra ì ì„ )</strong><br>` +
                `ãƒ» <strong>ì˜ˆì¸¡ ë°©ì‹:</strong> S9(2025ë…„) íŒ¨í„´ì— í˜„ì¬ S10/S9 ê²€ìƒ‰ëŸ‰ ë¹„ìœ¨ì„ ì ìš©í•˜ì—¬ ë¯¸ë˜ ê²€ìƒ‰ëŸ‰ì„ ì¶”ì •í•©ë‹ˆë‹¤.<br>` +
                `ãƒ» <strong>ê¸°ì¤€ì¼(D):</strong> ${s10D} / <strong>ì¶œì‹œì¼ ì˜¤í”„ì…‹:</strong> ${LAUNCH_OFFSET_DAYS}ì¼ (S10 02-27 ê¸°ì¤€, S9 ì°¨íŠ¸ìƒ 02-21)<br>` +
                `ãƒ» <strong>S10 7ì¼ í•©ê³„ (${s10Start}~${s10D}):</strong> ${Math.round(s10Sum7).toLocaleString()} &nbsp;|&nbsp; ` +
                `<strong>S9 7ì¼ í•©ê³„ (${s9Start}~${s9End}):</strong> ${Math.round(s9Sum7).toLocaleString()}<br>` +
                `ãƒ» <strong>ë¹„ìœ¨(ratio):</strong> ${s10Sum7.toFixed(0)} Ã· ${s9Sum7.toFixed(0)} = <span style="color:#dc2626;font-weight:700;">${(predRatio*100).toFixed(1)}%</span><br>` +
                `ãƒ» <strong>ì˜ˆì¸¡ ì‚°ì‹:</strong> <em>S10_ì˜ˆì¸¡(t) = S9(t âˆ’ ${LAUNCH_OFFSET_DAYS}ì¼) Ã— <span style="color:#dc2626;font-weight:700;">${(predRatio*100).toFixed(1)}%</span></em><br>` +
                `ãƒ» ì‹¤ì œ ê²€ìƒ‰ëŸ‰ì€ ë§ˆì¼€íŒ… ì§‘í–‰Â·ê²½ìŸì‚¬ ë™í–¥Â·ì†Œë¹„ì ë°˜ì‘ì— ë”°ë¼ ë‹¬ë¼ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤.`;
        } else {
            el.textContent = 'â€» S10 ì˜ˆì¸¡ ë¼ì¸: ë°ì´í„° ê¸°ì¤€ì¼ ì´í›„ ë¯¸ê¸°ë¡ êµ¬ê°„ì— S9 íŒ¨í„´ ë¹„ìœ¨ì„ ì ìš©í•©ë‹ˆë‹¤. ë°ì´í„° ì¶•ì  í›„ í‘œì‹œë©ë‹ˆë‹¤.';
        }
    }

    /* â”€â”€ chart4 ë Œë” í•¨ìˆ˜ (ì¼ë‹¨ìœ„ + S10 ì˜ˆì¸¡ ë¼ì¸) â”€â”€ */
    function renderChart4(fd) {
        const isMobile = window.innerWidth <= 768;
        const ch4Keys = [
            { key: 'S10 Max V Ultra',  label: 'ë¡œë³´ë½ S10 Max V Ultra', color: 'rgb(220,38,38)' },
            { key: 'ì‚¼ì„±ë¡œë´‡ì²­ì†Œê¸°',    label: 'ì‚¼ì„±ë¹„ìŠ¤í¬í¬AIìŠ¤íŒ€',      color: 'rgb(30,64,175)' },
            { key: 'ë“œë¦¬ë¯¸x60',         label: 'ë“œë¦¬ë¯¸X60',               color: 'rgb(96,165,250)' },
            { key: 'ì—ì½”ë°±ìŠ¤T90',        label: 'ì—ì½”ë°±ìŠ¤T90',             color: 'rgb(120,53,15)' }
        ];

        /* â”€â”€ ë°ì´í„° ì»·ì˜¤í”„ ê³„ì‚° â”€â”€ */
        const { dateStr: cutoffDate } = getDataCutoff();

        /* â”€â”€ ê¸°ë³¸ ë¼ì¸ ë°ì´í„°ì…‹ â”€â”€ */
        const ds4 = (label, data, color) => ({
            label, data,
            borderColor: color, backgroundColor: 'transparent',
            borderWidth: 2.5, tension: 0.4, fill: false,
            pointRadius: 0, pointHoverRadius: 4, spanGaps: false
        });
        const datasets = ch4Keys.map(c =>
            ds4(c.label, fd.map(d => ({ x: d['ë‚ ì§œ'], y: d[c.key] })), c.color)
        );

        /* â”€â”€ S10 ì˜ˆì¸¡ ë¼ì¸ ìƒì„± (ë¹„ìœ¨ ê¸°ë°˜ ìƒˆ ë°©ì‹) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
         * LAUNCH_OFFSET_DAYS = 6
         *   S9 ì¶œì‹œì¼(ì°¨íŠ¸ ê¸°ì¤€): 2026-02-21
         *   S10 ì¶œì‹œì¼          : 2026-02-27  â†’ ì°¨ì´ = 6ì¼
         *
         * D(S10) = cutoffDate (ë°ì´í„° ê¸°ì¤€ì¼)
         * D(S9)  = cutoffDate - 6ì¼ (ì°¨íŠ¸ìƒ S9ì˜ ë™ë“± ì‹œì )
         *
         * S10_sum7 = Î£ S10 ê²€ìƒ‰ëŸ‰ [ D(S10)-6 ~ D(S10) ] (7ì¼)
         * S9_sum7  = Î£ S9  ê²€ìƒ‰ëŸ‰ [ D(S9)-6  ~ D(S9)  ] (7ì¼)
         *          = Î£ S9  ê²€ìƒ‰ëŸ‰ [ D(S10)-12 ~ D(S10)-6 ]
         *
         * ratio = S10_sum7 / S9_sum7
         * ì˜ˆì¸¡:  S10_pred(t) = S9(t - 6ì¼) Ã— ratio   (t > D(S10))
         â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        const S9_KEY  = 'S9 Max V Ultra';
        const S10_KEY = 'S10 Max V Ultra';
        const LAUNCH_OFFSET_DAYS = 6; // S10 ì¶œì‹œì¼(02-27) - S9 ì°¨íŠ¸ ì¶œì‹œì¼(02-21)

        // ë‚ ì§œ ì˜¤í”„ì…‹ í—¬í¼
        const addDays = (dateStr, n) => {
            const d = new Date(dateStr + 'T00:00:00Z');
            d.setUTCDate(d.getUTCDate() + n);
            return d.toISOString().slice(0,10);
        };

        // S9 ë‚ ì§œë³„ ê²€ìƒ‰ëŸ‰ ë§µ
        const s9Map = {};
        fd.forEach(d => {
            const v = parseFloat(d[S9_KEY]);
            if (v > 0) s9Map[d['ë‚ ì§œ']] = v;
        });

        // S10 ë‚ ì§œë³„ ê²€ìƒ‰ëŸ‰ ë§µ
        const s10Map = {};
        fd.forEach(d => {
            const v = parseFloat(d[S10_KEY]);
            if (d['ë‚ ì§œ'] <= cutoffDate && v > 0) s10Map[d['ë‚ ì§œ']] = v;
        });

        // D(S10) = cutoffDate, D(S9) = cutoffDate - 6ì¼
        const s10D = cutoffDate;
        const s9D  = addDays(cutoffDate, -LAUNCH_OFFSET_DAYS);

        // 7ì¼ í•©ì‚°
        const sumRange = (map, startDate, endDate) => {
            let total = 0, cnt = 0;
            fd.forEach(d => {
                if (d['ë‚ ì§œ'] >= startDate && d['ë‚ ì§œ'] <= endDate) {
                    const v = map[d['ë‚ ì§œ']] || (parseFloat(d[S9_KEY]) > 0 && map === s9Map ? parseFloat(d[S9_KEY]) : 0);
                    if (v > 0) { total += v; cnt++; }
                }
            });
            return { total, cnt };
        };
        const s10Start = addDays(s10D, -6);
        const s9Start  = addDays(s9D,  -6);  // = cutoffDate - 12ì¼
        const s9End    = s9D;                 // = cutoffDate - 6ì¼

        const s10Sum7 = (() => {
            let t = 0;
            fd.forEach(d => { if (d['ë‚ ì§œ'] >= s10Start && d['ë‚ ì§œ'] <= s10D) { const v = s10Map[d['ë‚ ì§œ']] || 0; t += v; } });
            return t;
        })();
        const s9Sum7 = (() => {
            let t = 0;
            fd.forEach(d => { if (d['ë‚ ì§œ'] >= s9Start && d['ë‚ ì§œ'] <= s9End) { const v = parseFloat(d[S9_KEY]) || 0; if (v > 0) t += v; } });
            return t;
        })();

        const predRatio = (s9Sum7 > 0) ? (s10Sum7 / s9Sum7) : null;

        // ì˜ˆì¸¡ í¬ì¸íŠ¸ ìƒì„± (cutoffDate ì´í›„)
        let predData = null;
        let anchorDate = s10D;
        let anchorS10  = s10Map[s10D] || null;

        if (predRatio !== null && anchorS10 !== null) {
            const futureDates = fd
                .filter(d => d['ë‚ ì§œ'] > cutoffDate)
                .map(d => d['ë‚ ì§œ']);

            if (futureDates.length > 0) {
                const pts = [{ x: anchorDate, y: anchorS10 }];
                futureDates.forEach(date => {
                    const s9DateForPred = addDays(date, -LAUNCH_OFFSET_DAYS);
                    const s9v = s9Map[s9DateForPred];
                    if (s9v && s9v > 0) {
                        pts.push({ x: date, y: Math.round(s9v * predRatio) });
                    }
                });
                if (pts.length > 1) predData = pts;
            }
        }

        // ì˜ˆì¸¡ ë°ì´í„°ì…‹ ì¶”ê°€
        if (predData) {
            datasets.push({
                label: 'ğŸ“ˆ S10 ì˜ˆì¸¡ (S9íŒ¨í„´ ê¸°ë°˜)',
                data: predData,
                borderColor: 'rgba(220,38,38,0.55)',
                backgroundColor: 'rgba(220,38,38,0.06)',
                borderWidth: 2,
                borderDash: [7, 4],
                tension: 0.4,
                fill: true,
                pointRadius: 0,
                pointHoverRadius: 4,
                spanGaps: false,
                order: -1
            });
        }

        createChart('chart4', datasets, buildCompetitorAnnotations());

        /* â”€â”€ ë‹¨ì„œì¡°í•­ ì—…ë°ì´íŠ¸ â”€â”€ */
        const chart4ExtraInfo = (predRatio !== null && anchorS10 !== null) ? {
            s9Sum7, s10Sum7, predRatio,
            s9Start, s9End: s9D, s10Start, s10D,
            LAUNCH_OFFSET_DAYS
        } : null;
        updateChart4Disclaimer(anchorDate, anchorS10, predData, chart4ExtraInfo);

        /* â”€â”€ ê²½ìŸì‚¬ ì¸ì‚¬ì´íŠ¸ ê°±ì‹  â”€â”€ */
        setTimeout(() => updateCompetitorInsights(fd, ch4Keys), 200);
    }

    /* â”€â”€ chart4 ë‹¨ì„œì¡°í•­ (ë¹„ìœ¨ ê¸°ë°˜ ìƒˆ ë°©ì‹) â”€â”€ */
    function updateChart4Disclaimer(anchorDate, anchorS10, predData, extraInfo) {
        let el = document.getElementById('chart4Disclaimer');
        if (!el) {
            el = document.createElement('p');
            el.id = 'chart4Disclaimer';
            el.style.cssText = 'font-size:0.72em;color:#64748b;margin-top:6px;margin-bottom:0;line-height:1.6;padding:8px 10px;background:#f8fafc;border-radius:6px;border-left:3px solid #cbd5e1;';
            const wrap = document.getElementById('chart4Wrap') || document.getElementById('chart4').parentNode;
            wrap.parentNode.insertBefore(el, wrap.nextSibling);
        }
        if (predData && anchorDate && extraInfo) {
            const { s9Sum7, s10Sum7, predRatio, s9Start, s9End, s10Start, s10D, LAUNCH_OFFSET_DAYS } = extraInfo;
            el.innerHTML =
                `<strong>â€» ì˜ˆì¸¡ ë¼ì¸ ì„¤ëª… (S10 Max V Ultra ì ì„ )</strong><br>` +
                `ãƒ» <strong>ì˜ˆì¸¡ ë°©ì‹:</strong> S9(2025) ê²€ìƒ‰ëŸ‰ íŒ¨í„´ì— í˜„ì¬ S10 ëŒ€ë¹„ ë¹„ìœ¨ì„ ì ìš©í•˜ì—¬ ë¯¸ë˜ ê²€ìƒ‰ëŸ‰ì„ ì¶”ì •í•©ë‹ˆë‹¤.<br>` +
                `ãƒ» <strong>ê¸°ì¤€ì¼(D):</strong> ${s10D} / <strong>ì¶œì‹œì¼ ì˜¤í”„ì…‹:</strong> ${LAUNCH_OFFSET_DAYS}ì¼ (S10 ì¶œì‹œ 02-27, S9 ì°¨íŠ¸ ê¸°ì¤€ 02-21)<br>` +
                `ãƒ» <strong>S10 7ì¼ í•©ê³„ (${s10Start}~${s10D}):</strong> ${Math.round(s10Sum7).toLocaleString()} &nbsp;|&nbsp; ` +
                `<strong>S9 7ì¼ í•©ê³„ (${s9Start}~${s9End}):</strong> ${Math.round(s9Sum7).toLocaleString()}<br>` +
                `ãƒ» <strong>ë¹„ìœ¨(ratio):</strong> ${s10Sum7.toFixed(0)} Ã· ${s9Sum7.toFixed(0)} = <span style="color:#dc2626;font-weight:700;">${(predRatio*100).toFixed(1)}%</span><br>` +
                `ãƒ» <strong>ì˜ˆì¸¡ ì‚°ì‹:</strong> <em>S10_ì˜ˆì¸¡(t) = S9(t âˆ’ ${LAUNCH_OFFSET_DAYS}ì¼) Ã— <span style="color:#dc2626;font-weight:700;">${(predRatio*100).toFixed(1)}%</span></em><br>` +
                `ãƒ» ì‹¤ì œ ê²€ìƒ‰ëŸ‰ì€ ë§ˆì¼€íŒ… ì§‘í–‰Â·ê²½ìŸì‚¬ ë™í–¥Â·ì†Œë¹„ì ë°˜ì‘ì— ë”°ë¼ ë‹¬ë¼ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤.`;
        } else {
            el.textContent = 'â€» S10 ì˜ˆì¸¡ ë¼ì¸: ë°ì´í„° ê¸°ì¤€ì¼ ì´í›„ ë¯¸ê¸°ë¡ êµ¬ê°„ì— S9 íŒ¨í„´ ë¹„ìœ¨ì„ ì ìš©í•©ë‹ˆë‹¤. ë°ì´í„° ì¶•ì  í›„ í‘œì‹œë©ë‹ˆë‹¤.';
        }
    }

    /* â”€â”€ Chart2 D ê¸°ì¤€ -7ì¼ í‰ê·  ë§ˆì»¤ â”€â”€ */
    function buildChart2DMarkers(fd) {
        const { dateStr: cutoffDate } = getDataCutoff();
        const LAUNCH_OFFSET = 6; // S10(02-27) vs S9 ì°¨íŠ¸ê¸°ì¤€(02-21)

        const addDays = (dateStr, n) => {
            const d = new Date(dateStr + 'T00:00:00Z');
            d.setUTCDate(d.getUTCDate() + n);
            return d.toISOString().slice(0,10);
        };

        // D(S10) = cutoffDate, D(S9) = cutoffDate - 6ì¼
        const d10 = cutoffDate;
        const d9  = addDays(cutoffDate, -LAUNCH_OFFSET);

        // 7ì¼ ìœˆë„ìš° í•©ì‚° â†’ í‰ê· 
        const avg7 = (key, endDate) => {
            const startDate = addDays(endDate, -6);
            const vals = fd
                .filter(r => r['ë‚ ì§œ'] >= startDate && r['ë‚ ì§œ'] <= endDate)
                .map(r => parseFloat(r[key]) || 0)
                .filter(v => v > 0);
            return vals.length ? vals.reduce((a,b)=>a+b,0)/vals.length : null;
        };

        const avg25 = avg7('25 ë¡œë³´ë½',    d9);   // S9 ê¸°ì¤€
        const avg26 = avg7('26 .ë¡œë³´ë½',   d10);  // S10 ê¸°ì¤€

        const markers = [];

        if (avg25 !== null) {
            markers.push({
                label: `25 ë¡œë³´ë½ D-7 í‰ê·  (${d9})`,
                data: [{ x: d9, y: Math.round(avg25) }],
                type: 'scatter',
                borderColor: 'rgba(34,197,94,1)',
                backgroundColor: 'rgba(34,197,94,0.25)',
                borderWidth: 2,
                pointStyle: 'rectRot',
                pointRadius: 10,
                pointHoverRadius: 12,
                showLine: false,
                order: 0
            });
        }

        if (avg26 !== null) {
            markers.push({
                label: `26 ë¡œë³´ë½ D-7 í‰ê·  (${d10})`,
                data: [{ x: d10, y: Math.round(avg26) }],
                type: 'scatter',
                borderColor: 'rgba(220,38,38,1)',
                backgroundColor: 'rgba(220,38,38,0.25)',
                borderWidth: 2,
                pointStyle: 'rectRot',
                pointRadius: 10,
                pointHoverRadius: 12,
                showLine: false,
                order: 0
            });
        }

        return markers;
    }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       ìœ í‹¸
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function showStatus(msg, type) {
        const el = document.getElementById('statusMessage');
        el.textContent = msg;
        el.className = 'status ' + type;
        el.classList.remove('hide');
        if (type === 'success') setTimeout(() => el.classList.add('hide'), 3000);
    }
    function showLoading(show) {
        document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none';
    }
    function cleanNumber(value) {
        if (value === null || value === undefined || value === '' || value === '-') return null;
        if (typeof value === 'number') return value === 0 ? null : value;
        const num = parseFloat(String(value).replace(/[,\s]/g, ''));
        return (isNaN(num) || num === 0) ? null : num;
    }
    function formatK(value) {
        if (value === null || value === undefined) return '';
        return value >= 1000 ? Math.round(value / 1000) + 'k' : Math.round(value).toString();
    }
    function calcYRange(datasets, padRatio = 0.15) {
        const vals = datasets.flatMap(d => d.data.map(p => p.y)).filter(v => v != null);
        if (!vals.length) return { min: 0, max: 10000 };
        const mn = Math.min(...vals), mx = Math.max(...vals);
        const pad = (mx - mn) * padRatio || mx * padRatio || 500;
        return {
            min: Math.max(0, Math.floor((mn - pad) / 100) * 100),
            max: Math.ceil((mx + pad) / 100) * 100
        };
    }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       CORS fetch
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    async function tryFetch(proxy, url) {
        const res = await fetch(proxy + encodeURIComponent(url), { headers: { 'Accept': 'text/csv,*/*' } });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        return await res.text();
    }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       ë°ì´í„° ë¡œë“œ
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    async function loadGoogleSheetData() {
        showLoading(true);
        let csvText = null;
        for (const proxy of CORS_PROXIES) {
            try { csvText = await tryFetch(proxy, GOOGLE_SHEET_URL); break; }
            catch(e) {}
        }
        if (!csvText) {
            try { const r = await fetch(GOOGLE_SHEET_URL); if (r.ok) csvText = await r.text(); } catch(e) {}
        }
        if (!csvText) {
            showLoading(false);
            showStatus('âŒ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
            return;
        }
        Papa.parse(csvText, {
            header: true, skipEmptyLines: true,
            complete(results) {
                allData = results.data.map(row => {
                    const out = {};
                    Object.keys(row).forEach(k => {
                        if (k === 'ë‚ ì§œ' || k.includes('ë‚ ì§œ')) out['ë‚ ì§œ'] = (row[k] || '').trim();
                        else out[k] = cleanNumber(row[k]);
                    });
                    return out;
                });
                showLoading(false);
                document.getElementById('mainContent').classList.remove('hide');
                showStatus(`âœ… ë°ì´í„° ë¡œë“œ ì™„ë£Œ! (${allData.length}ê°œ ë ˆì½”ë“œ)`, 'success');
                updateCharts();
                loadSalesData(); // íŒë§¤ ë°ì´í„° ë³„ë„ ë¡œë“œ
            },
            error(err) {
                showLoading(false);
                showStatus('âŒ íŒŒì‹± ì˜¤ë¥˜: ' + err.message, 'error');
            }
        });
    }

    function filterData(data, start, end) {
        return data.filter(d => d['ë‚ ì§œ'] >= start && d['ë‚ ì§œ'] <= end);
    }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     * Annotation ë¹Œë” A: ë¡œë³´ë½ ë§ˆì¼€íŒ… ì´ë²¤íŠ¸ (ì°¨íŠ¸ 2Â·3)
     *   - 25ë…„ ì´ˆë¡, 26ë…„ ë¹¨ê°•
     *   - ê·¸ë˜í”„ ìœ„ ë¼ë²¨ ì¹© ì™„ì „ ì œê±° (label.display: false)
     *   - ìŒì˜ ë°•ìŠ¤ + ì ì„ ë§Œ í‘œì‹œ
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function buildRoborockAnnotations() {
        return {
            // â”€â”€ 25ë…„ ì‚¬ì „ë§ˆì¼€íŒ… ìŒì˜ (ì´ˆë¡) â”€â”€
            rr25Box: {
                type: 'box',
                xMin: EVT.rr25PreStart,
                xMax: EVT.rr25PreEnd,
                backgroundColor: 'rgba(34,197,94,0.12)',
                borderColor: 'rgba(34,197,94,0.35)',
                borderWidth: 1,
                label: { display: false }
            },
            // â”€â”€ 25ë…„ ëŸ°ì¹­ ìˆ˜ì§ ì ì„  (ì´ˆë¡) â”€â”€
            rr25Line: {
                type: 'line',
                xMin: EVT.rr25Launch,
                xMax: EVT.rr25Launch,
                borderColor: 'rgba(22,163,74,0.85)',
                borderWidth: 1.8,
                borderDash: [6, 4],
                label: { display: false }
            },
            // â”€â”€ 26ë…„ ì‚¬ì „ë§ˆì¼€íŒ… ìŒì˜ (ë¹¨ê°•) â”€â”€
            rr26Box: {
                type: 'box',
                xMin: EVT.rr26PreStart,
                xMax: EVT.rr26PreEnd,
                backgroundColor: 'rgba(220,38,38,0.09)',
                borderColor: 'rgba(220,38,38,0.32)',
                borderWidth: 1,
                label: { display: false }
            },
            // â”€â”€ 26ë…„ ëŸ°ì¹­ ìˆ˜ì§ ì ì„  (ë¹¨ê°•) â”€â”€
            rr26Line: {
                type: 'line',
                xMin: EVT.rr26Launch,
                xMax: EVT.rr26Launch,
                borderColor: 'rgba(220,38,38,0.85)',
                borderWidth: 1.8,
                borderDash: [6, 4],
                label: { display: false }
            }
        };
    }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     * Annotation ë¹Œë” B: ê²½ìŸì‚¬ ì´ìŠˆ ì¼ì • (ì°¨íŠ¸ 4)
     *   â˜… ê·¸ë˜í”„ ìœ„ ìŒì˜ ì™„ì „ ì œê±° â†’ Xì¶• í•˜ë‹¨ íƒ€ì„ë¼ì¸ìœ¼ë¡œ ëŒ€ì²´
     *   â†’ annotationì€ ë¹ˆ ê°ì²´ ë°˜í™˜ (í”ŒëŸ¬ê·¸ì¸ì´ ì§ì ‘ ê·¸ë¦¼)
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function buildCompetitorAnnotations() {
        return {}; // íƒ€ì„ë¼ì¸ í”ŒëŸ¬ê·¸ì¸ì´ ëŒ€ì²´
    }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     * â˜… ì»¤ìŠ¤í…€ í”ŒëŸ¬ê·¸ì¸: Xì¶• í•˜ë‹¨ ë¸Œëœë“œë³„ íƒ€ì„ë¼ì¸ ë°”
     *   ì°¨íŠ¸ 4 ì „ìš©. afterDraw í›…ìœ¼ë¡œ ìº”ë²„ìŠ¤ì— ì§ì ‘ ê·¸ë¦¼.
     *   - ë°°ê²½ íŠ¸ë™ + ìƒ‰ìƒ ë°” + ëŸ°ì¹­ ìˆ˜ì§ì„  + ë¸Œëœë“œëª… í…ìŠ¤íŠ¸
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    const timelinePlugin = {
        id: 'chart4Timeline',
        afterDraw(chart) {
            if (chart.canvas.id !== 'chart4') return;

            const ctx   = chart.ctx;
            const xAxis = chart.scales.x;
            const area  = chart.chartArea;

            // ë‚ ì§œ(ISO string) â†’ xí”½ì…€. ì°¨íŠ¸ ë²”ìœ„ ë°–ì€ í´ë¨í”„.
            const toX = (iso) => {
                const ms = luxon.DateTime.fromISO(iso).toMillis();
                const px = xAxis.getPixelForValue(ms);
                return Math.max(area.left, Math.min(area.right, px));
            };
            // ë‚ ì§œê°€ ì°¨íŠ¸ xë²”ìœ„ ì•ˆì— ìˆëŠ”ì§€ ì—¬ë¶€
            const inRange = (iso) => {
                const ms = luxon.DateTime.fromISO(iso).toMillis();
                return ms >= xAxis.min && ms <= xAxis.max;
            };
            const eitherInRange = (s, e) => {
                const sMs = luxon.DateTime.fromISO(s).toMillis();
                const eMs = luxon.DateTime.fromISO(e).toMillis();
                return eMs >= xAxis.min && sMs <= xAxis.max;
            };

            /* íƒ€ì„ë¼ì¸ í–‰ ì •ì˜ */
            const ROW_H  = 14;   // í–‰ ë†’ì´
            const ROW_G  = 3;    // í–‰ ê°„ê²©
            const OFFSET = 28;   // Xì¶• ëˆˆê¸ˆ í…ìŠ¤íŠ¸ ì•„ë˜ ì—¬ë°±
            const LBL_W  = 42;   // ë¸Œëœë“œëª… ì˜ì—­ ë„ˆë¹„
            const startY = area.bottom + OFFSET;
            const isMob  = chart.width < 480;

            const rows = [
                {
                    /* 1í–‰: ì‚¼ì„± â€” ì‚¬ì „ì˜ˆì•½ 02.11 ì‹œì‘ (ê°€ì¥ ë¹ ë¦„) */
                    label: 'ì‚¼ì„±',
                    labelColor: '#1e40af',
                    segments: [
                        { start: EVT.ssPreStart, end: EVT.ssPreEnd, fill: 'rgba(30,64,175,0.42)' }
                    ],
                    lines: [
                        { date: EVT.ssLaunch, color: 'rgba(30,64,175,1)', label: isMob ? '' : '3.3ëŸ°ì¹­' }
                    ]
                },
                {
                    /* 2í–‰: ë¡œë³´ë½ â€” 26ë…„ ì¼ì •ë§Œ (ì‚¬ì „ 02.15 ì‹œì‘) */
                    label: 'ë¡œë³´ë½',
                    labelColor: '#dc2626',
                    segments: [
                        { start: EVT.rr26PreStart, end: EVT.rr26PreEnd, fill: 'rgba(220,38,38,0.45)' }
                    ],
                    lines: [
                        { date: EVT.rr26Launch, color: 'rgba(220,38,38,1)', label: isMob ? '' : '2.27ëŸ°ì¹­' }
                    ]
                },
                {
                    /* 3í–‰: ë“œë¦¬ë¯¸ â€” ì‚¬ì „ë§ˆì¼€íŒ… 02.23 ì‹œì‘ (ê°€ì¥ ëŠ¦ìŒ) */
                    label: 'ë“œë¦¬ë¯¸',
                    labelColor: '#3b82f6',
                    segments: [
                        { start: EVT.dmPreStart, end: EVT.dmPreEnd, fill: 'rgba(96,165,250,0.55)' }
                    ],
                    lines: [
                        { date: EVT.dmLaunch, color: 'rgba(96,165,250,1)', label: isMob ? '' : '3.9ëŸ°ì¹­' }
                    ]
                }
            ];

            ctx.save();

            rows.forEach((row, i) => {
                const y = startY + i * (ROW_H + ROW_G);

                /* â‘  íŠ¸ë™ ë°°ê²½ (íšŒìƒ‰ ë°”) */
                ctx.fillStyle = 'rgba(0,0,0,0.06)';
                ctx.beginPath();
                ctx.roundRect
                    ? ctx.roundRect(area.left + LBL_W, y, area.right - area.left - LBL_W, ROW_H, 3)
                    : ctx.rect(area.left + LBL_W, y, area.right - area.left - LBL_W, ROW_H);
                ctx.fill();

                /* â‘¡ ë¸Œëœë“œëª… í…ìŠ¤íŠ¸ */
                ctx.fillStyle = row.labelColor;
                ctx.font = `bold ${isMob ? 9 : 10}px -apple-system, sans-serif`;
                ctx.textAlign = 'left';
                ctx.textBaseline = 'middle';
                ctx.fillText(row.label, area.left + 2, y + ROW_H / 2);

                /* â‘¢ í´ë¦¬í•‘ ì˜ì—­ = íŠ¸ë™ë§Œ */
                ctx.save();
                ctx.beginPath();
                ctx.rect(area.left + LBL_W, y - 1, area.right - area.left - LBL_W, ROW_H + 2);
                ctx.clip();

                /* â‘£ ìƒ‰ìƒ ì„¸ê·¸ë¨¼íŠ¸ ë°” */
                row.segments.forEach(seg => {
                    if (!eitherInRange(seg.start, seg.end)) return;
                    const x1 = toX(seg.start);
                    const x2 = toX(seg.end);
                    ctx.fillStyle = seg.fill;
                    ctx.fillRect(x1, y, x2 - x1, ROW_H);
                });

                /* â‘¤ ëŸ°ì¹­ ìˆ˜ì§ì„  + í…ìŠ¤íŠ¸ */
                row.lines.forEach(ln => {
                    if (!inRange(ln.date)) return;
                    const x = toX(ln.date);
                    ctx.strokeStyle = ln.color;
                    ctx.lineWidth = 2;
                    ctx.setLineDash([4, 3]);
                    ctx.beginPath();
                    ctx.moveTo(x, y);
                    ctx.lineTo(x, y + ROW_H);
                    ctx.stroke();
                    ctx.setLineDash([]);

                    if (ln.label) {
                        ctx.fillStyle = ln.color;
                        ctx.font = `${isMob ? 7 : 8}px -apple-system, sans-serif`;
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'middle';
                        ctx.fillText(ln.label, x, y + ROW_H / 2);
                    }
                });

                ctx.restore(); /* í´ë¦¬í•‘ í•´ì œ */
            });

            ctx.restore();
        }
    };

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     * (ë”ë¯¸ ìœ ì§€) â€” buildCompetitorAnnotations ì•„ë˜ ì¶”ê°€ë¡œ ì°¸ì¡°ë˜ì§€ ì•ŠìŒ
     * â˜… ì‚¼ì„± ì‚¬ì „ì˜ˆì•½ ìŒì˜ (ì§„íŒŒë‘) â€” ì´í•˜ ì½”ë“œëŠ” ìœ„ì—ì„œ ì œê±°ë¨
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function _unusedOldAnnotations() {
        return {
            ssBox: { type:'box', xMin:EVT.ssPreStart, xMax:EVT.ssPreEnd, backgroundColor:'rgba(30,64,175,0.08)', borderWidth:0, label:{display:false} },
            ssLine: { type:'line', xMin:EVT.ssLaunch, xMax:EVT.ssLaunch, borderColor:'rgba(30,64,175,0.5)', borderWidth:1, borderDash:[4,3], label:{display:false} },
            dmBox: { type:'box', xMin:EVT.dmPreStart, xMax:EVT.dmPreEnd, backgroundColor:'rgba(96,165,250,0.08)', borderWidth:0, label:{display:false} },
            dmLine: { type:'line', xMin:EVT.dmLaunch, xMax:EVT.dmLaunch, borderColor:'rgba(96,165,250,0.5)', borderWidth:1, borderDash:[4,3], label:{display:false} }
        };
    }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       ì°¨íŠ¸ ìƒì„±  annotationsObj = null | Object
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function createChart(canvasId, datasets, annotationsObj = null, opts = {}) {
        const ctx = document.getElementById(canvasId).getContext('2d');
        if (charts[canvasId]) charts[canvasId].destroy();

        const isMobile   = window.innerWidth <= 768;
        const isChart4   = canvasId === 'chart4';
        const _pad       = opts.yPadRatio || 0.15;
        const yRange     = calcYRange(datasets, _pad);
        const annotationOpts = annotationsObj
            ? { annotations: annotationsObj }
            : {};
        // ì°¨íŠ¸4: Xì¶• í•˜ë‹¨ íƒ€ì„ë¼ì¸ ê³µê°„ í™•ë³´
        const bottomPad  = isChart4 ? (isMobile ? 62 : 72) : 0;
        // ì°¨íŠ¸4: íƒ€ì„ë¼ì¸ í”ŒëŸ¬ê·¸ì¸ ë“±ë¡
        const pluginList = isChart4 ? [timelinePlugin] : [];

        charts[canvasId] = new Chart(ctx, {
            type: 'line',
            data: { datasets },
            plugins: pluginList,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                layout: { padding: { bottom: bottomPad } },
                interaction: { mode: 'index', intersect: false },
                plugins: {
                    legend: {
                        display: true, position: 'top',
                        labels: {
                            usePointStyle: true,
                            padding: isMobile ? 8 : 14,
                            font: { size: isMobile ? 10 : 12 },
                            boxWidth: isMobile ? 8 : 12
                        }
                    },
                    tooltip: {
                        enabled: true,
                        backgroundColor: 'rgba(0,0,0,0.82)',
                        padding: isMobile ? 7 : 11,
                        titleFont: { size: isMobile ? 11 : 13 },
                        bodyFont:  { size: isMobile ? 10 : 12 },
                        callbacks: {
                            label(c) {
                                if (c.parsed.y === null) return null;
                                return (c.dataset.label || '') + ': ' + formatK(c.parsed.y);
                            }
                        }
                    },
                    annotation: annotationOpts
                },
                scales: {
                    x: {
                        type: 'time',
                        time: { unit: 'day', displayFormats: { day: 'MM/dd' } },
                        /* â˜… í•„í„° ì…ë ¥ê°’ìœ¼ë¡œ Xì¶• ë²”ìœ„ ê³ ì • â†’ null ë°ì´í„° ìˆì–´ë„ 12/29ë¶€í„° í‘œì‹œ */
                        min: document.getElementById('startDate').value,
                        max: document.getElementById('endDate').value,
                        title: { display: false },
                        grid: { display: false },
                        ticks: {
                            font: { size: isMobile ? 8 : 11 },
                            maxRotation: isMobile ? 45 : 0,
                            autoSkip: true,
                            maxTicksLimit: isMobile ? 5 : 10
                        }
                    },
                    y: {
                        suggestedMin: yRange.min,
                        suggestedMax: yRange.max,
                        title: { display: false },
                        grid: { color: 'rgba(0,0,0,0.05)' },
                        ticks: {
                            font: { size: isMobile ? 9 : 11 },
                            callback: v => formatK(v)
                        }
                    }
                }
            }
        });
    }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       ìƒ‰ìƒ
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    const C = {
        green25  : 'rgb(34,197,94)',    // 25ë…„ ë¡œë³´ë½ / S9
        red26    : 'rgb(220,38,38)',    // 26ë…„ ë¡œë³´ë½ / S10
        blue     : 'rgb(59,130,246)',   // 25ë…„ ë¡œë´‡ì²­ì†Œê¸°
        red      : 'rgb(239,68,68)',    // 26ë…„ ë¡œë´‡ì²­ì†Œê¸°
        samsung  : 'rgb(30,64,175)',    // ì‚¼ì„± ì§„íŒŒë‘
        dreame   : 'rgb(96,165,250)',   // ë“œë¦¬ë¯¸ í•˜ëŠ˜íŒŒë‘
        ecovacs  : 'rgb(120,53,15)'    // ì—ì½”ë°±ìŠ¤ ê°ˆìƒ‰
    };

    function ds(label, data, color) {
        return {
            label, data,
            borderColor: color, backgroundColor: 'transparent',
            borderWidth: 2.5, tension: 0.4, fill: false,
            pointRadius: 0, pointHoverRadius: 4, spanGaps: false
        };
    }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       ì°¨íŠ¸ ì—…ë°ì´íŠ¸
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function updateCharts() {
        if (!allData.length) return;
        const start = document.getElementById('startDate').value;
        const end   = document.getElementById('endDate').value;
        if (!start || !end) { alert('ì‹œì‘ì¼ê³¼ ì¢…ë£Œì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.'); return; }

        const fd = filterData(allData, start, end);
        if (!fd.length) { alert('ì„ íƒ ê¸°ê°„ì— ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.'); return; }

        document.getElementById('dateRange').innerHTML =
            `<span class="date-info">${start}</span> ~ <span class="date-info">${end}</span>` +
            `<span style="margin-left:10px;">ì´ <strong>${fd.length}</strong>ì¼</span>`;

        const pt = (d, k) => ({ x: d['ë‚ ì§œ'], y: d[k] });

        // íŒë§¤ ì°¨íŠ¸: ê²€ìƒ‰ ë°ì´í„° ê°±ì‹  í›„ ì¬ë Œë”ë§
        if (salesRaw.length) renderSalesChart();

        // Chart 1 â€“ ì—°ë„ë³„ ë¡œë´‡ì²­ì†Œê¸° (ë¡œë³´ë½ ì œì™¸ ì „ì²´ ì¹´í…Œê³ ë¦¬)
        createChart('chart1', [
            ds('25 ë¡œë´‡ì²­ì†Œê¸°', fd.map(d => pt(d, '25 ë¡œë´‡ì²­ì†Œê¸°')), C.blue),
            ds('26 ë¡œë´‡ì²­ì†Œê¸°', fd.map(d => pt(d, '26 ë¡œë´‡ì²­ì†Œê¸°')), C.red)
        ], null, { yPadRatio: 0.35 });

        // Chart 2 â€“ ì—°ë„ë³„ ë¡œë³´ë½ â˜… ìŒì˜ O / ë¼ë²¨ ì—†ìŒ + Dê¸°ì¤€ -7ì¼ í‰ê·  ë§ˆì»¤
        const c2Markers = buildChart2DMarkers(fd);
        createChart('chart2', [
            ds('25 ë¡œë³´ë½', fd.map(d => pt(d, '25 ë¡œë³´ë½')),  C.green25),
            ds('26 ë¡œë³´ë½', fd.map(d => pt(d, '26 .ë¡œë³´ë½')), C.red26),
            ...c2Markers
        ], buildRoborockAnnotations());

        // Chart 3 â€“ ì œí’ˆ ëª¨ë¸ë³„ â˜… ìŒì˜ O / ë¼ë²¨ ì—†ìŒ + S10 ì˜ˆì¸¡ ë¼ì¸
        const { predDataset: c3PredDS, disclaimer: c3Disclaimer } = buildS10PredictionForChart(fd);
        const c3Datasets = [
            ds('S9 Max V Ultra',  fd.map(d => pt(d, 'S9 Max V Ultra')),  C.green25),
            ds('S10 Max V Ultra', fd.map(d => pt(d, 'S10 Max V Ultra')), C.red26)
        ];
        if (c3PredDS) c3Datasets.push(c3PredDS);
        createChart('chart3', c3Datasets, buildRoborockAnnotations());
        // ë‹¨ì„œì¡°í•­ ì—…ë°ì´íŠ¸
        updateChart3Disclaimer(c3Disclaimer);

        // Chart 4 â€“ ê²½ìŸì‚¬ ë¶„ì„ (ì¼/ì£¼ í† ê¸€ ì§€ì›)
        renderChart4(fd);
    }

    /* ì´ˆê¸°í™” */
    window.addEventListener('DOMContentLoaded', loadGoogleSheetData);
    window.addEventListener('resize', () => {
        if (allData.length) updateCharts();
        if (salesRaw.length) renderSalesChart();
    });

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       ì•„ë“œë¦¬ì—˜ ë§ˆì¼€íŒ… ì„±ê³¼ ì„¹ì…˜ JS
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       ì•„ë“œë¦¬ì—˜ ë§ˆì¼€íŒ… ì„±ê³¼ ì„¹ì…˜ JS
       â”€ ì¼ë‹¨ìœ„ / ì£¼ë‹¨ìœ„ í† ê¸€
       â”€ 10ê°€ì§€ ì§€í‘œ ë²„íŠ¼
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

    /* Adriel Widget URLs: ìƒˆ ìœ„ì ¯(12/29~4/8 ë²”ìœ„) â†’ ê¸°ì¡´ ìœ„ì ¯ ìˆœ í´ë°± */
    const AM_URLS = [
        "https://api.adriel.com/api/widgetExport/auto?widgetId=accd84c9-1236-11f1-af44-7728e2e5c3b6&viewkey=fv5UtvvHDKuv0iYH",
        "https://api.adriel.com/api/widgetExport/auto?widgetId=95f04e09-1230-11f1-ac66-49b0ed9160e1&viewkey=5HgGtXhuDTp9XY4D"
    ];
    const AM_PROXIES = [
        'https://api.allorigins.win/raw?url=',
        'https://corsproxy.io/?url=',
        'https://thingproxy.freeboard.io/fetch/'
    ];

    /* ìƒíƒœ */
    let amRaw      = [];          // ì›ë³¸ CSV rows
    let amPeriod   = 'day';       // 'day' | 'week'
    let amMetric   = 'spend';     // í˜„ì¬ ì§€í‘œ í‚¤
    let amChannel  = 'all';       // 'all' | ì±„ë„ëª…
    let amChartInst = null;

    /* ì±„ë„ ìƒ‰ìƒ */
    const AM_CH = {
        naverGFA:         { label:'ë„¤ì´ë²„ GFA',     color:'#03C75A' },
        naver:            { label:'ë„¤ì´ë²„ SA',      color:'#00B900' },
        kakao:            { label:'ì¹´ì¹´ì˜¤',         color:'#FAC62D' },
        facebook:         { label:'í˜ì´ìŠ¤ë¶/ì¸ìŠ¤íƒ€', color:'#1877F2' },
        google_demandgen: { label:'êµ¬ê¸€ DG',        color:'#EA4335' }
    };

    /* ì§€í‘œ ì •ì˜ */
    const AM_METRICS = {
        spend:       { col:'ê´‘ê³ ë¹„',      label:'ê´‘ê³ ë¹„ (ì›)',  yFmt: v=>amKRW(v),               ttFmt: v=>amKRW(v),               calcRow: null },
        clicks:      { col:'clicks',      label:'í´ë¦­ìˆ˜',      yFmt: v=>amK(v)+'íšŒ',             ttFmt: v=>parseInt(v).toLocaleString()+'íšŒ', calcRow: null },
        impressions: { col:'impressions', label:'ë…¸ì¶œìˆ˜',      yFmt: v=>amK(v),                  ttFmt: v=>parseInt(v).toLocaleString(),     calcRow: null },
        roas:        { col:'ROAS_a',      label:'ROAS (%)',    yFmt: v=>(v*100).toFixed(0)+'%',  ttFmt: v=>(v*100).toFixed(2)+'%',          calcRow: null },
        purchases:   { col:'êµ¬ë§¤ìˆ˜_a',    label:'êµ¬ë§¤ìˆ˜',      yFmt: v=>amK(v)+'ê±´',             ttFmt: v=>parseInt(v).toLocaleString()+'ê±´', calcRow: null },
        ctr:         { col:'ctr',         label:'CTR (%)',     yFmt: v=>(v*100).toFixed(2)+'%',  ttFmt: v=>(v*100).toFixed(3)+'%',          calcRow: null },
        cpc:         { col:'cpc',         label:'CPC (ì›)',    yFmt: v=>amKRW(v),               ttFmt: v=>amKRW(v),               calcRow: null },
        revenue:     { col:'ë§¤ì¶œì•¡_a',    label:'ë§¤ì¶œì•¡ (ì›)', yFmt: v=>amKRW(v),               ttFmt: v=>amKRW(v),               calcRow: null },
        cvr:         { col:'CVR_a',       label:'CVR (%)',     yFmt: v=>(v*100).toFixed(2)+'%',  ttFmt: v=>(v*100).toFixed(3)+'%',          calcRow: null },
        cpa:         { col:'__cpa__',     label:'CPA (ì›)',    yFmt: v=>amKRW(v),               ttFmt: v=>amKRW(v),               calcRow: r => {
            const sp = parseFloat(r['ê´‘ê³ ë¹„'])||0;
            const pu = parseFloat(r['êµ¬ë§¤ìˆ˜_a'])||0;
            return pu > 0 ? sp/pu : null;
        }}
    };

    /* â”€â”€ í¬ë§· í—¬í¼ â”€â”€ */
    function amKRW(v) {
        if (v==null||isNaN(v)||v===0) return 'â‚©0';
        if (v>=100000000) return 'â‚©'+(v/100000000).toFixed(1)+'ì–µ';
        if (v>=10000)     return 'â‚©'+(v/10000).toFixed(1)+'ë§Œ';
        return 'â‚©'+Math.round(v).toLocaleString();
    }
    function amK(v) {
        if (v==null||isNaN(v)) return '0';
        if (v>=1000000) return (v/1000000).toFixed(1)+'M';
        if (v>=1000)    return (v/1000).toFixed(1)+'k';
        return Math.round(v).toLocaleString();
    }

    /* â”€â”€ CORS ìš°íšŒ fetch â”€â”€ */
    async function amFetch(url) {
        try {
            const r = await fetch(url, {mode:'cors'});
            if (r.ok) { const t=await r.text(); if(t.includes(',')&&!t.trim().startsWith('<')) return t; }
        } catch(e){}
        for (const px of AM_PROXIES) {
            try {
                const r = await fetch(px+encodeURIComponent(url), {
                    headers:{'Accept':'text/csv,text/plain,*/*'},
                    signal: AbortSignal.timeout ? AbortSignal.timeout(9000) : undefined
                });
                if (r.ok) { const t=await r.text(); if(t.includes(',')&&!t.trim().startsWith('<')) return t; }
            } catch(e){}
        }
        throw new Error('ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë„¤íŠ¸ì›Œí¬ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.');
    }

    /* â”€â”€ ë°ì´í„° ë¡œë“œ â”€â”€ */
    async function loadAdrielData() {
        document.getElementById('amLoading').style.display='block';
        document.getElementById('amContent').classList.add('hide');
        document.getElementById('amError').classList.add('hide');
        try {
            // ì—¬ëŸ¬ ìœ„ì ¯ URL ìˆœì„œëŒ€ë¡œ ì‹œë„ (ìƒˆ ìœ„ì ¯ ìš°ì„ , êµ¬ ìœ„ì ¯ í´ë°±)
            let csv = null;
            for (const amUrl of AM_URLS) {
                try {
                    csv = await amFetch(amUrl);
                    if (csv && csv.includes(',') && csv.includes('day')) break;
                } catch(e) { csv = null; }
            }
            if (!csv) throw new Error('ëª¨ë“  ìœ„ì ¯ URLì—ì„œ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            Papa.parse(csv, {
                header:true, skipEmptyLines:true,
                complete(res) {
                    if (!res.data.length) throw new Error('ë°ì´í„° ì—†ìŒ');
                    amRaw = res.data;
                    amRenderAll();
                },
                error(e){ amShowError('íŒŒì‹± ì˜¤ë¥˜: '+e.message); }
            });
        } catch(e){ amShowError(e.message); }
    }

    function amShowError(msg) {
        document.getElementById('amLoading').style.display='none';
        const el=document.getElementById('amError');
        el.textContent='âš ï¸ ì•„ë“œë¦¬ì—˜ ë¡œë“œ ì‹¤íŒ¨: '+msg;
        el.classList.remove('hide');
    }

    /* â”€â”€ ì „ì²´ ë Œë” â”€â”€ */
    function amRenderAll() {
        document.getElementById('amLoading').style.display='none';
        document.getElementById('amContent').classList.remove('hide');

        // ê·¸ëœë“œ í† íƒˆ
        const gt = amRaw.find(r=>r.all==='all'&&!r.day&&!r.channel);
        // ì¼ë³„ í•©ê³„ í–‰
        const daily = amRaw.filter(r=>r.all==='all'&&r.day&&!r.channel)
                           .sort((a,b)=>a.day.localeCompare(b.day));
        // ì±„ë„ë³„ ì¼ë³„ í–‰
        const chDay = amRaw.filter(r=>r.all==='all'&&r.day&&r.channel);

        // ë‚ ì§œ ë²”ìœ„ í‘œì‹œ
        const dates = daily.map(r=>r.day);
        const minD=dates[0]||'â€”', maxD=dates[dates.length-1]||'â€”';
        document.getElementById('amDateRange').textContent = 'ğŸ“… '+minD+' ~ '+maxD+' ('+dates.length+'ì¼)';
        document.getElementById('amWarn').textContent = dates.length<30
            ? 'âš ï¸ ìœ„ì ¯ ê¸°ê°„: '+dates.length+'ì¼ Â· ì•„ë“œë¦¬ì—˜ ìœ„ì ¯ì—ì„œ í™•ì¥ ê°€ëŠ¥' : '';

        amRenderKPI(null);  // í•„í„° ê¸°ë°˜ KPI ë Œë”
        const rows = amGetRows();
        amRenderChart(rows.daily, rows.chDay);
    }

    /* â”€â”€ í•„í„°ë§ëœ rows ê°€ì ¸ì˜¤ê¸° â”€â”€ */
    function amGetRows() {
        // daily total rows (channel="" ë˜ëŠ” channel=ì„ íƒì±„ë„)
        let daily, chDay;
        const allRows = amRaw.filter(r=>r.all==='all'&&r.day);

        if (amChannel === 'all') {
            daily = allRows.filter(r=>!r.channel).sort((a,b)=>a.day.localeCompare(b.day));
            chDay = allRows.filter(r=>r.channel);
        } else {
            // íŠ¹ì • ì±„ë„: daily = í•´ë‹¹ ì±„ë„ í–‰, chDay = ë™ì¼
            daily = allRows.filter(r=>r.channel===amChannel).sort((a,b)=>a.day.localeCompare(b.day));
            chDay = daily; // ë‹¨ì¼ ì±„ë„
        }

        if (amPeriod === 'week') {
            const agg  = amAggWeekly(amChannel==='all'
                ? allRows
                : allRows.filter(r=>r.channel===amChannel||!r.channel));
            daily = agg.filter(r=>r.channel==='').sort((a,b)=>a.day.localeCompare(b.day));
            chDay = agg.filter(r=>r.channel!=='');
            if (amChannel !== 'all') {
                daily = agg.filter(r=>r.channel===amChannel).sort((a,b)=>a.day.localeCompare(b.day));
                chDay = daily;
            }
        }
        return {daily, chDay};
    }

    /* â”€â”€ KPI ê³„ì‚°ìš©: rows í•©ì‚° â”€â”€ */
    function amCalcKPIFromRows(rows) {
        // rows: daily total (channel=='') or single channel rows
        let sp=0, cl=0, im=0, pu=0, rev=0, ctrSum=0, cpcSum=0, roSum=0, cvrSum=0, cnt=0;
        rows.forEach(r=>{
            sp  += parseFloat(r['ê´‘ê³ ë¹„'])||0;
            cl  += parseInt(r['clicks'])||0;
            im  += parseInt(r['impressions'])||0;
            pu  += parseFloat(r['êµ¬ë§¤ìˆ˜_a'])||0;
            rev += parseFloat(r['ë§¤ì¶œì•¡_a'])||0;
            ctrSum += parseFloat(r['ctr'])||0;
            cpcSum += parseFloat(r['cpc'])||0;
            roSum  += parseFloat(r['ROAS_a'])||0;
            cvrSum += parseFloat(r['CVR_a'])||0;
            cnt++;
        });
        return {
            sp, cl, im, pu, rev,
            ctr: cnt ? ctrSum/cnt : 0,
            cpc: cnt ? cpcSum/cnt : 0,
            roas: cnt ? roSum/cnt : 0,
            cvr: cnt ? cvrSum/cnt : 0,
            cpa: pu>0 ? sp/pu : 0
        };
    }

    /* â”€â”€ KPI ì¹´ë“œ â”€â”€ */
    function amRenderKPI(gt) {
        const g = document.getElementById('amKpiGrid');
        if (!amRaw.length) { g.innerHTML='<p style="color:#718096;padding:10px">ë°ì´í„° ì—†ìŒ</p>'; return; }

        // í˜„ì¬ ê¸°ê°„/ì±„ë„ í•„í„°ì— ë§ëŠ” rowsë¡œ KPI ê³„ì‚°
        const {daily} = amGetRows();
        // ì£¼ë‹¨ìœ„ë©´ ì§‘ê³„ëœ daily ì‚¬ìš©, ì¼ë‹¨ìœ„ë©´ ì›ë³¸ daily ì‚¬ìš©
        const kd = amCalcKPIFromRows(daily);

        const kpis=[
            {l:'ì´ ê´‘ê³ ë¹„', v:amKRW(kd.sp),               s:kd.sp.toLocaleString()+'ì›'},
            {l:'ì´ í´ë¦­ìˆ˜', v:amK(kd.cl)+'íšŒ',            s:kd.cl.toLocaleString()},
            {l:'ì´ ë…¸ì¶œìˆ˜', v:amK(kd.im),                 s:kd.im.toLocaleString()},
            {l:'í‰ê·  CTR',  v:(kd.ctr*100).toFixed(2)+'%', s:'í´ë¦­ë¥ '},
            {l:'í‰ê·  CPC',  v:amKRW(kd.cpc),              s:'í´ë¦­ë‹¹ ë¹„ìš©'},
            {l:'ROAS',      v:(kd.roas*100).toFixed(1)+'%',s:'ê´‘ê³ ë¹„ ëŒ€ë¹„ ë§¤ì¶œ'},
            {l:'ì´ êµ¬ë§¤ìˆ˜', v:amK(kd.pu)+'ê±´',            s:kd.pu.toLocaleString()+'ê±´'},
            {l:'ì´ ë§¤ì¶œì•¡', v:amKRW(kd.rev),              s:kd.rev.toLocaleString()+'ì›'},
            {l:'CPA',       v:amKRW(kd.cpa),              s:'êµ¬ë§¤ë‹¹ ë¹„ìš©'},
        ];
        g.innerHTML = kpis.map(k=>`
            <div class="am-kpi-card">
                <div class="am-kpi-label">${k.l}</div>
                <div class="am-kpi-value">${k.v}</div>
                <div class="am-kpi-sub">${k.s}</div>
            </div>`).join('');
        document.getElementById('amKpiGrid').style.gridTemplateColumns='repeat(9,1fr)';

        // í˜„ì¬ ì„ íƒ ì±„ë„/ê¸°ê°„ í‘œì‹œ
        const chLabel = amChannel==='all' ? 'ì „ì²´' : (AM_CH[amChannel]?.label||amChannel);
        const pLabel  = amPeriod==='week' ? 'ì£¼ë‹¨ìœ„' : 'ì¼ë‹¨ìœ„';
        const infoEl  = document.getElementById('amDateRange');
        if (infoEl) {
            const dates = daily.map(r=>r.day);
            const minD=dates[0]||'â€”', maxD=dates[dates.length-1]||'â€”';
            infoEl.textContent = 'ğŸ“… '+minD+' ~ '+maxD+' ('+dates.length+(amPeriod==='week'?'ì£¼':'ì¼')+') Â· '+chLabel+' Â· '+pLabel;
        }
    }

    /* â”€â”€ ì£¼ë‹¨ìœ„ ì§‘ê³„ â”€â”€ */
    function amAggWeekly(rows) {
        // rows: [{day, channel, ê´‘ê³ ë¹„, ...}, ...]
        const weekMap = {};
        rows.forEach(r => {
            const d   = new Date(r.day);
            const mon = new Date(d);
            mon.setDate(d.getDate() - ((d.getDay()+6)%7)); // ì›”ìš”ì¼ ê¸°ì¤€
            const wk  = mon.toISOString().slice(0,10);
            if (!weekMap[wk]) weekMap[wk] = {};
            const key = r.channel||'__total__';
            if (!weekMap[wk][key]) weekMap[wk][key] = {day:wk, channel:r.channel||'', all:'all', _cnt:0,
                'ê´‘ê³ ë¹„':0, impressions:0, clicks:0, ctr:0, cpc:0, cpm:0,
                'êµ¬ë§¤ìˆ˜_a':0, 'ë§¤ì¶œì•¡_a':0, CVR_a:0, ROAS_a:0, CPA_a:0
            };
            const t = weekMap[wk][key];
            // í•©ì‚°
            ['ê´‘ê³ ë¹„','impressions','clicks','êµ¬ë§¤ìˆ˜_a','ë§¤ì¶œì•¡_a'].forEach(c=>{
                t[c] = (t[c]||0) + (parseFloat(r[c])||0);
            });
            // ê°€ì¤‘í‰ê· ì„ ìœ„í•œ ëˆ„ì  (ë‚˜ì¤‘ì— ë‚˜ëˆ”)
            t._cnt++;
            t._ctr_sum  = (t._ctr_sum||0)  + (parseFloat(r['ctr'])||0);
            t._cpc_sum  = (t._cpc_sum||0)  + (parseFloat(r['cpc'])||0);
            t._roas_sum = (t._roas_sum||0) + (parseFloat(r['ROAS_a'])||0);
            t._cvr_sum  = (t._cvr_sum||0)  + (parseFloat(r['CVR_a'])||0);
        });
        // í‰ê·  ê³„ì‚°
        const result=[];
        Object.values(weekMap).forEach(chMap=>{
            Object.values(chMap).forEach(t=>{
                t.ctr   = t._cnt ? t._ctr_sum/t._cnt  : 0;
                t.cpc   = t._cnt ? t._cpc_sum/t._cnt  : 0;
                t.ROAS_a= t._cnt ? t._roas_sum/t._cnt : 0;
                t.CVR_a = t._cnt ? t._cvr_sum/t._cnt  : 0;
                result.push(t);
            });
        });
        return result.sort((a,b)=>a.day.localeCompare(b.day));
    }

    /* â”€â”€ ì°¨íŠ¸ ë Œë” â”€â”€ */
    function amRenderChart(dailyBase, chDayBase) {
        const m = AM_METRICS[amMetric];
        const isMobile = window.innerWidth<=768;

        // ê¸°ê°„ ì§‘ê³„
        let daily, chDay;
        if (amPeriod==='week') {
            const allRows = amRaw.filter(r=>r.all==='all'&&r.day);
            const aggAll  = amAggWeekly(allRows);
            daily = aggAll.filter(r=>r.channel==='');
            chDay = aggAll.filter(r=>r.channel!=='');
        } else {
            daily  = dailyBase;
            chDay  = chDayBase;
        }

        const dates = [...new Set([...daily,...chDay].map(r=>r.day).filter(Boolean))].sort();
        if (!dates.length) return;

        // ì£¼ë‹¨ìœ„: WK{n} ë ˆì´ë¸” ìƒì„± (ë°ì´í„° ë‚´ ì²« ë‚  ê¸°ì¤€ 1ë²ˆ ë¶€í„°)
        const wkLabels = amPeriod==='week'
            ? dates.map((d,i)=>'WK'+(i+1))
            : dates;
        // ì°¨íŠ¸ xê°’: ì£¼ë‹¨ìœ„=ì¹´í…Œê³ ë¦¬(WKn), ì¼ë‹¨ìœ„=ë‚ ì§œë¬¸ìì—´
        const xVals = wkLabels;

        // ì±„ë„ë³„ ë°ì´í„°ì…‹
        const datasets = Object.entries(AM_CH).map(([ch,cfg])=>{
            const chMap={};
            chDay.filter(r=>r.channel===ch).forEach(r=>{
                let val;
                if (m.calcRow) { val=m.calcRow(r); }
                else { val=parseFloat(r[m.col])||null; }
                chMap[r.day]=val;
            });
            if (amPeriod==='week') {
                return {
                    label: cfg.label,
                    type: 'bar',
                    data: dates.map((d,i)=>({x:xVals[i], y: chMap[d]??null})),
                    backgroundColor: cfg.color+'bb',
                    borderColor: cfg.color,
                    borderWidth: 1.5,
                    borderRadius: 5,
                    borderSkipped: false
                };
            }
            return {
                label: cfg.label,
                data: dates.map((d,i)=>({x:xVals[i], y: chMap[d]??null})),
                borderColor: cfg.color,
                backgroundColor: cfg.color+'28',
                borderWidth:2.5, tension:0.35, fill:false,
                pointRadius: dates.length<=14?4:2,
                pointHoverRadius:6, spanGaps:false
            };
        });

        // ì „ì²´ í•©ê³„ ì ì„ 
        const totalMap={};
        daily.forEach(r=>{
            let val;
            if (m.calcRow) { val=m.calcRow(r); }
            else { val=parseFloat(r[m.col])||null; }
            totalMap[r.day]=val;
        });
        datasets.unshift({
            label:'ì „ì²´ í•©ê³„',
            type: 'line',
            data: dates.map((d,i)=>({x:xVals[i], y:totalMap[d]??null})),
            borderColor:'#2d3748', backgroundColor:'transparent',
            borderWidth:3, borderDash:[6,3],
            tension:0.35, fill:false,
            pointRadius:dates.length<=14?5:2, pointHoverRadius:7, spanGaps:false,
            order: 0
        });

        const ctx=document.getElementById('amChart').getContext('2d');
        if (amChartInst) amChartInst.destroy();

        amChartInst = new Chart(ctx,{
            type: amPeriod==='week' ? 'bar' : 'line', data:{datasets},
            options:{
                responsive:true, maintainAspectRatio:false,
                interaction:{mode:'index', intersect:false},
                plugins:{
                    legend:{display:true, position:'top',
                        labels:{usePointStyle:true, padding:isMobile?7:13,
                            font:{size:isMobile?10:12}}},
                    tooltip:{
                        backgroundColor:'rgba(0,0,0,.85)',
                        callbacks:{
                            title: ctx=>{
                                if (!ctx[0]) return '';
                                const lbl = ctx[0].label;
                                if (amPeriod==='week') {
                                    // WKn â†’ ë‚ ì§œ ë²”ìœ„ í‘œì‹œ
                                    const idx = wkLabels.indexOf(lbl);
                                    if (idx>=0 && idx<dates.length) {
                                        const d = new Date(dates[idx]);
                                        const sun = new Date(d); sun.setDate(d.getDate()+6);
                                        const fmt = dd => (dd.getMonth()+1)+'/'+(dd.getDate());
                                        return lbl+' ('+fmt(d)+' ~ '+fmt(sun)+')';
                                    }
                                }
                                return lbl;
                            },
                            label: ctx=>{
                                if(ctx.parsed.y===null) return null;
                                return ' '+ctx.dataset.label+': '+m.ttFmt(ctx.parsed.y);
                            }
                        }
                    }
                },
                scales:{
                    x:{
                        type: amPeriod==='week' ? 'category' : 'time',
                        ...(amPeriod==='week' ? {} : {
                            time:{unit:'day', displayFormats:{day:'MM/dd'}}
                        }),
                        grid:{display:false},
                        ticks:{font:{size:isMobile?9:11}, maxRotation:45, autoSkip:true,
                               maxTicksLimit:isMobile?5:12}
                    },
                    y:{
                        beginAtZero:true,
                        grid:{color:'rgba(0,0,0,.05)'},
                        ticks:{font:{size:isMobile?9:11},
                               callback:v=>m.yFmt(v)}
                    }
                }
            }
        });

        const unitLabel = amPeriod==='week'?'ì£¼ë³„':'ì¼ë³„';
        document.getElementById('amChartLegend').textContent =
            'ì±„ë„ë³„ '+unitLabel+' '+m.label+' ì¶”ì´ Â· ìœ„ì ¯ ë‚ ì§œ ë²”ìœ„ì— ë”°ë¼ ë³€ê²½ë©ë‹ˆë‹¤';
    }

    /* â”€â”€ ê¸°ê°„ ë²„íŠ¼ í† ê¸€ â”€â”€ */
    function amSetPeriod(p, btn) {
        amPeriod = p;
        document.querySelectorAll('.am-period-btn').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        if (!amRaw.length) return;
        const {daily, chDay} = amGetRows();
        amRenderKPI(null);          // KPI ì¬ê³„ì‚°
        amRenderChart(daily, chDay);
    }

    /* â”€â”€ ì§€í‘œ ë²„íŠ¼ í† ê¸€ â”€â”€ */
    function amSetMetric(key, btn) {
        amMetric = key;
        document.querySelectorAll('.am-metric-btn').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        if (!amRaw.length) return;
        const {daily, chDay} = amGetRows();
        amRenderChart(daily, chDay);
    }

    /* â”€â”€ ì±„ë„ í•„í„° ë²„íŠ¼ â”€â”€ */
    function amSetChannel(ch, btn) {
        amChannel = ch;
        document.querySelectorAll('.am-channel-btn').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        if (!amRaw.length) return;
        const {daily, chDay} = amGetRows();
        amRenderKPI(null);          // KPI ì¬ê³„ì‚°
        amRenderChart(daily, chDay);
    }


    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       ê²½ìŸì‚¬ ë¶„ì„ ì¸ì‚¬ì´íŠ¸ ìë™ ìƒì„±
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       KST ê¸°ì¤€ ë°ì´í„° ì»·ì˜¤í”„ ë‚ ì§œ ê³„ì‚°
       - KST 10:00 ì´í›„ â†’ ì–´ì œ(D-1)ê¹Œì§€ ë°ì´í„° ìœ íš¨
       - KST 10:00 ì´ì „ â†’ ê·¸ì œ(D-2)ê¹Œì§€ ë°ì´í„° ìœ íš¨
       (ì˜¤ì „ 10ì‹œ ì´ì „ì—ëŠ” ì „ë‚  ë°ì´í„°ê°€ ì•„ì§ ë¯¸ê¸°ë¡)
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    function getDataCutoff() {
        const now = new Date();
        // UTC â†’ KST (UTC+9) ë³€í™˜
        const utcMs = now.getTime() + now.getTimezoneOffset() * 60000;
        const kstNow = new Date(utcMs + 9 * 60 * 60000);

        const kstHour = kstNow.getHours();
        const kstMin  = kstNow.getMinutes();

        // ì˜¤ì „ 10ì‹œ ì´í›„ë©´ ì–´ì œê¹Œì§€, ì´ì „ì´ë©´ ê·¸ì œê¹Œì§€
        const daysBack = (kstHour > 10 || (kstHour === 10 && kstMin >= 0)) ? 1 : 2;

        const cutoff = new Date(kstNow);
        cutoff.setDate(kstNow.getDate() - daysBack);

        const y = cutoff.getFullYear();
        const m = String(cutoff.getMonth() + 1).padStart(2, '0');
        const d = String(cutoff.getDate()).padStart(2, '0');
        return {
            dateStr: `${y}-${m}-${d}`,
            daysBack,
            kstHour,
            kstNow
        };
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       ê²½ìŸì‚¬ ë¶„ì„ ì¸ì‚¬ì´íŠ¸ ìë™ ìƒì„±
       â€» ê²€ìƒ‰ëŸ‰ 0 = ë¯¸ê¸°ë¡ ë°ì´í„° (ì—†ëŠ” ê²Œ ì•„ë‹˜)
         â†’ cutoff ì´í›„ ë‚ ì§œëŠ” ë¶„ì„ì—ì„œ ì™„ì „ ì œì™¸
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    function updateCompetitorInsights(fd, ch4Keys) {
        const container   = document.getElementById('competitorInsights');
        const badgeEl     = document.getElementById('insightCutoffBadge');
        if (!container) return;

        // â”€â”€ 1. ë°ì´í„° ì»·ì˜¤í”„ ê³„ì‚° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        const { dateStr: cutoffDate, daysBack, kstHour } = getDataCutoff();

        // ë±ƒì§€ ì—…ë°ì´íŠ¸
        if (badgeEl) {
            const cutoffFmt = cutoffDate.replace(/-/g, '.').slice(2); // YY.MM.DD
            const updateMsg = kstHour >= 10
                ? `ğŸ“… ë°ì´í„° ê¸°ì¤€: ${cutoffFmt} (ì˜¤ëŠ˜ 10ì‹œ ì—…ë°ì´íŠ¸ ì™„ë£Œ)`
                : `â³ ë°ì´í„° ê¸°ì¤€: ${cutoffFmt} (ì˜¤ì „ 10ì‹œ ì´ì „ â€” ì „ë‚  ë¯¸ê¸°ë¡)`;
            badgeEl.textContent = updateMsg;
        }

        if (!fd || fd.length < 3) {
            container.innerHTML = '<div style="text-align:center;padding:20px;color:#718096;grid-column:1/-1;">ì°¨íŠ¸ ë°ì´í„°ê°€ ì¶©ë¶„í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</div>';
            return;
        }

        // â”€â”€ 2. cutoff ì´í›„ ë‚ ì§œ ì œê±° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // ë‚ ì§œ ì»¬ëŸ¼ëª… ê°ì§€ ('ë‚ ì§œ' ë˜ëŠ” ì²« ë²ˆì§¸ í‚¤)
        const dateKey = fd[0] && fd[0]['ë‚ ì§œ'] !== undefined ? 'ë‚ ì§œ'
                      : (Object.keys(fd[0] || {}).find(k => /date|ë‚ ì§œ/i.test(k)) || 'ë‚ ì§œ');

        const validFd = fd.filter(row => {
            const rowDate = (row[dateKey] || '').toString().slice(0, 10);
            return rowDate && rowDate <= cutoffDate;
        });

        if (validFd.length < 3) {
            container.innerHTML = `<div style="text-align:center;padding:20px;color:#718096;grid-column:1/-1;">
                ìœ íš¨ ë°ì´í„° ë¶€ì¡± (ê¸°ì¤€: ${cutoffDate}ê¹Œì§€)<br>
                <small>ì˜¤ì „ 10ì‹œ ì´í›„ ë°ì´í„° ì—…ë°ì´íŠ¸ í›„ ë‹¤ì‹œ í™•ì¸í•´ ì£¼ì„¸ìš”.</small>
            </div>`;
            return;
        }

        // â”€â”€ 3. í‚¤ ì •ì˜ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        const roboKey    = 'S10 Max V Ultra';
        const samsungKey = 'ì‚¼ì„±ë¡œë´‡ì²­ì†Œê¸°';
        const dreamKey   = 'ë“œë¦¬ë¯¸x60';
        const ecovKey    = 'ì—ì½”ë°±ìŠ¤T90';

        // ìœ íš¨í•œ ê°’ë§Œ ì¶”ì¶œ (0 = ë¯¸ê¸°ë¡ì´ë¯€ë¡œ ì œì™¸)
        const valsOf = (key, rows) =>
            rows.map(d => parseFloat(d[key]) || 0).filter(v => v > 0);

        const rVals = valsOf(roboKey, validFd);
        const sVals = valsOf(samsungKey, validFd);
        const dVals = valsOf(dreamKey, validFd);
        const eVals = valsOf(ecovKey, validFd);

        if (!rVals.length || !sVals.length) {
            container.innerHTML = `<div style="text-align:center;padding:20px;color:#718096;grid-column:1/-1;">
                ê²€ìƒ‰ëŸ‰ ë°ì´í„° ì—†ìŒ (ê¸°ì¤€: ${cutoffDate}ê¹Œì§€)
            </div>`;
            return;
        }

        // â”€â”€ 4. í†µê³„ í•¨ìˆ˜ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        const avg    = arr => arr.reduce((a, b) => a + b, 0) / arr.length;
        const maxOf  = arr => Math.max(...arr);
        const maxIdx = arr => arr.indexOf(maxOf(arr));

        // ìµœê·¼ 7ì¼ vs ì „ì²´ í‰ê·  (ë” ì‹¤ìš©ì )
        const last7  = arr => arr.slice(-Math.min(7, arr.length));
        const last14 = arr => arr.slice(-Math.min(14, arr.length));
        const first7 = arr => arr.slice(0, Math.min(7, arr.length));

        // ìµœê·¼ 7ì¼ í‰ê· 
        const rLast7 = avg(last7(rVals));
        const sLast7 = avg(last7(sVals));
        // ì „ì²´ í‰ê· 
        const rAvg   = avg(rVals);
        const sAvg   = avg(sVals);
        const dAvg   = dVals.length ? avg(dVals) : 0;
        const eAvg   = eVals.length ? avg(eVals) : 0;

        // 7ì¼ ì¶”ì„¸ (ìµœê·¼ 7ì¼ vs ì´ì „ 7ì¼)
        const prev7 = arr => arr.slice(-Math.min(14, arr.length), -Math.min(7, arr.length));
        const rPrev7 = prev7(rVals);
        const sPrev7 = prev7(sVals);
        const rWeekTrend = rPrev7.length > 0
            ? ((rLast7 - avg(rPrev7)) / (avg(rPrev7) || 1) * 100).toFixed(1) : '0.0';
        const sWeekTrend = sPrev7.length > 0
            ? ((sLast7 - avg(sPrev7)) / (avg(sPrev7) || 1) * 100).toFixed(1) : '0.0';

        // ìµœê³ ì  ë‚ ì§œ
        const rPeakRow = validFd.reduce((best, d) => (parseFloat(d[roboKey])||0) > (parseFloat(best[roboKey])||0) ? d : best, validFd[0]);
        const rPeakDate = rPeakRow?.[dateKey] || '';
        const rPeakVal  = parseFloat(rPeakRow?.[roboKey] || 0);

        // ì—­ì „ ê°ì§€: ìœ íš¨ ê¸°ê°„ ì¤‘ ì‚¼ì„±ì´ ë¡œë³´ë½ì„ ì´ˆê³¼í•œ ë‚ 
        const allOvertakeDays = validFd.filter(d =>
            (parseFloat(d[samsungKey]) || 0) > (parseFloat(d[roboKey]) || 0) &&
            (parseFloat(d[roboKey]) || 0) > 0 && (parseFloat(d[samsungKey]) || 0) > 0
        );
        // ìµœê·¼ 7ì¼ ì—­ì „ ì¼ìˆ˜
        const last7Fd = validFd.slice(-7);
        const recentOvertake = last7Fd.filter(d =>
            (parseFloat(d[samsungKey]) || 0) > (parseFloat(d[roboKey]) || 0) &&
            (parseFloat(d[roboKey]) || 0) > 0
        );

        const rVsS = ((rAvg - sAvg) / (sAvg || 1) * 100).toFixed(1);

        // ë¶„ì„ ê¸°ê°„
        const startDate = validFd[0]?.[dateKey] || '';
        const endDate   = validFd[validFd.length - 1]?.[dateKey] || '';
        const totalDays = validFd.length;

        // â”€â”€ 5. ëŸ°ì¹­ íš¨ê³¼ ë¶„ì„ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        const launchDate = '2026-02-27';
        const preLaunchFd  = validFd.filter(d => (d[dateKey] || '') < launchDate && (parseFloat(d[roboKey]) || 0) > 0);
        const postLaunchFd = validFd.filter(d => (d[dateKey] || '') >= launchDate && (parseFloat(d[roboKey]) || 0) > 0);
        const preAvg  = preLaunchFd.length  ? avg(preLaunchFd.map(d  => parseFloat(d[roboKey]) || 0)) : 0;
        const postAvg = postLaunchFd.length ? avg(postLaunchFd.map(d => parseFloat(d[roboKey]) || 0)) : 0;
        const launchLift = preAvg > 0 && postLaunchFd.length > 0
            ? ((postAvg - preAvg) / preAvg * 100).toFixed(1) : null;

        // â”€â”€ 6. ë“œë¦¬ë¯¸ ì¶”ì„¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        const dLast7  = dVals.length >= 7 ? avg(last7(dVals))  : (dVals.length ? avg(dVals) : 0);
        const dPrev7v = dVals.length >= 7 ? avg(prev7(dVals))  : 0;
        const dTrend  = dPrev7v > 0
            ? ((dLast7 - dPrev7v) / dPrev7v * 100).toFixed(1) : '0.0';

        // â”€â”€ 7. ìµœì‹  ë‚ ì§œ ë¡œë³´ë½ ê²€ìƒ‰ëŸ‰ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        const latestRow = validFd[validFd.length - 1];
        const latestRobo    = parseFloat(latestRow?.[roboKey] || 0);
        const latestSamsung = parseFloat(latestRow?.[samsungKey] || 0);
        const latestDate    = latestRow?.[dateKey] || '';

        // â”€â”€ 8. ì¹´ë“œ ìƒì„± â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        const cards = [];

        // â”€â”€ ì¹´ë“œ 1: ìµœê·¼ 7ì¼ ê²½ìŸ í˜„í™© â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        const recentOvertakePct = Math.round(recentOvertake.length / (last7Fd.length || 1) * 100);
        // D ê¸°ì¤€ ê²©ì°¨ë¡œ ì¹´ë“œ ìƒ‰ìƒ/ë±ƒì§€ ê²°ì •
        const dGapForBadge = (latestRobo > 0 && latestSamsung > 0)
            ? ((latestRobo - latestSamsung) / latestSamsung * 100) : null;
        const cardClass1 = dGapForBadge !== null
            ? (dGapForBadge < 0 ? 'orange' : dGapForBadge < 10 ? 'orange' : 'green')
            : (recentOvertakePct >= 40 ? 'orange' : 'green');
        const badgeText = dGapForBadge !== null
            ? (dGapForBadge < 0 ? 'ğŸš¨ ì—­ì „ ë°œìƒ' : dGapForBadge < 10 ? 'âš ï¸ ì‚¼ì„± ì¶”ê²© ì¤‘' : 'âœ… ë¡œë³´ë½ ìš°ì„¸')
            : (recentOvertakePct >= 40 ? 'ì—­ì „ ìœ„í—˜' : 'ë¡œë³´ë½ ìš°ì„¸');
        const badgeClass = dGapForBadge !== null
            ? (dGapForBadge >= 10 ? 'up' : '')
            : (recentOvertakePct >= 40 ? '' : 'up');
        const rIcon = parseFloat(rWeekTrend) >= 0 ? 'ğŸ“ˆ' : 'ğŸ“‰';
        const sIcon = parseFloat(sWeekTrend) >= 0 ? 'ğŸ“ˆ' : 'ğŸ“‰';

        cards.push(`
        <div class="ci-card ${cardClass1}">
            <h3>âš”ï¸ ìµœê·¼ 7ì¼ ê²½ìŸ í˜„í™© <small style="font-size:0.8em;font-weight:400;">(ê¸°ì¤€: ${cutoffDate})</small>
                <span class="ci-badge ${badgeClass}">${badgeText}</span>
            </h3>
            <p>
                <strong>${cutoffDate} ê¸°ì¤€</strong> ë¡œë³´ë½ ê²€ìƒ‰ëŸ‰:
                <span class="ci-hl">${latestRobo > 0 ? latestRobo.toLocaleString() : 'ë¯¸ê¸°ë¡'}</span> Â·
                ì‚¼ì„±: <span class="ci-hl">${latestSamsung > 0 ? latestSamsung.toLocaleString() : 'ë¯¸ê¸°ë¡'}</span><br><br>
                ìµœê·¼ 7ì¼ í‰ê·  â€” ë¡œë³´ë½ <span class="ci-hl">${Math.round(rLast7).toLocaleString()}</span>
                vs ì‚¼ì„± <span class="ci-hl">${Math.round(sLast7).toLocaleString()}</span><br>
                ì£¼ê°„ ë³€í™”: ë¡œë³´ë½ ${rIcon} <span class="ci-hl">${parseFloat(rWeekTrend)>=0?'+':''}${rWeekTrend}%</span>
                Â· ì‚¼ì„± ${sIcon} <span class="ci-hl">${parseFloat(sWeekTrend)>=0?'+':''}${sWeekTrend}%</span><br><br>
                ${(() => {
                    // D ê¸°ì¤€ ì§ì ‘ ê²©ì°¨
                    const dR = latestRobo, dS = latestSamsung;
                    if (dR > 0 && dS > 0) {
                        const gap = ((dR - dS) / dS * 100).toFixed(1);
                        const gapN = parseFloat(gap);
                        const gapLabel = gapN >= 10
                            ? `<span class="ci-hl">+${gap}%</span> â€” âœ… ë¡œë³´ë½ ìš°ìœ„`
                            : gapN >= 0
                            ? `<span class="ci-hl">+${gap}%</span> â€” âš ï¸ ì‚¼ì„± ë¹ ë¥´ê²Œ ì¶”ê²© ì¤‘`
                            : `<span class="ci-hl">${gap}%</span> â€” ğŸš¨ ì‚¼ì„±ì— ì—­ì „ë‹¹í•œ ìƒíƒœ`;
                        // ì—°ì† ì—­ì „ì¼
                        let streak = 0;
                        for (let i = last7Fd.length - 1; i >= 0; i--) {
                            const r = parseFloat(last7Fd[i][roboKey])||0;
                            const s = parseFloat(last7Fd[i][samsungKey])||0;
                            if (r > 0 && s > 0 && s > r) streak++;
                            else break;
                        }
                        const streakMsg = streak >= 3
                            ? ` / ì‚¼ì„±ì´ <span class="ci-hl">${streak}ì¼ ì—°ì†</span> ê²€ìƒ‰ëŸ‰ ì•ì„¬ â€” ì¦‰ê° ëŒ€ì‘ í•„ìš”`
                            : streak >= 1
                            ? ` / ì‚¼ì„±ì´ ìµœê·¼ ${streak}ì¼ ê²€ìƒ‰ëŸ‰ ì•ì„¬`
                            : ``;
                        return `${cutoffDate} ê¸°ì¤€ ë¡œë³´ë½ vs ì‚¼ì„±: ${gapLabel}${streakMsg}`;
                    }
                    return '';
                })()}
            </p>
        </div>`);

        // â”€â”€ ì¹´ë“œ 2: S10 ëŸ°ì¹­ íš¨ê³¼ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        if (launchLift !== null) {
            const liftNum = parseFloat(launchLift);
            const liftClass = liftNum >= 20 ? 'blue' : (liftNum >= 0 ? 'blue' : 'orange');
            const liftMsg = liftNum >= 20
                ? 'ëŸ°ì¹­ ë§ˆì¼€íŒ… íš¨ê³¼ê°€ <span class="ci-hl">ì„±ê³µì </span>ìœ¼ë¡œ ë‚˜íƒ€ë‚¬ìŠµë‹ˆë‹¤.'
                : liftNum >= 5
                ? 'ëŸ°ì¹­ íš¨ê³¼ê°€ í™•ì¸ë˜ë‚˜, <span class="ci-hl">ì§€ì† ë§ˆì¼€íŒ…</span>ìœ¼ë¡œ ê´€ì‹¬ë„ë¥¼ ìœ ì§€í•´ì•¼ í•©ë‹ˆë‹¤.'
                : liftNum >= 0
                ? 'ëŸ°ì¹­ ì§í›„ ì†Œí­ ìƒìŠ¹ â€” <span class="ci-hl">ì½˜í…ì¸  ë§ˆì¼€íŒ… ê°•í™”</span>ë¥¼ ê¶Œì¥í•©ë‹ˆë‹¤.'
                : 'ëŸ°ì¹­ í›„ ê²€ìƒ‰ëŸ‰ í•˜ë½ì„¸. <span class="ci-hl">ì¬íƒ€ê²ŸíŒ… ê´‘ê³ </span> ì¦‰ì‹œ ê°•í™” í•„ìš”í•©ë‹ˆë‹¤.';
            cards.push(`
            <div class="ci-card ${liftClass}">
                <h3>ğŸš€ S10 Max V Ultra ëŸ°ì¹­ íš¨ê³¼
                    <span class="ci-badge up">${liftNum>=0?'+'+launchLift:''+launchLift}%</span>
                </h3>
                <p>
                    ëŸ°ì¹­(02.27) ì´ì „ ${preLaunchFd.length}ì¼ í‰ê· :
                    <span class="ci-hl">${Math.round(preAvg).toLocaleString()}</span><br>
                    ëŸ°ì¹­ ì´í›„ ${postLaunchFd.length}ì¼ í‰ê· :
                    <span class="ci-hl">${Math.round(postAvg).toLocaleString()}</span><br>
                    â†’ <span class="ci-hl">${Math.abs(liftNum)}% ${liftNum>=0?'ìƒìŠ¹':'í•˜ë½'}</span><br><br>
                    ${liftMsg}<br>
                    ìµœê³  ê²€ìƒ‰ëŸ‰: <span class="ci-hl">${rPeakVal.toLocaleString()}</span> (${rPeakDate})
                </p>
            </div>`);
        } else {
            // ëŸ°ì¹­ ì „ì´ê±°ë‚˜ ë°ì´í„° ë¶€ì¡±
            const isBeforeLaunch = cutoffDate < launchDate;
            cards.push(`
            <div class="ci-card blue">
                <h3>ğŸš€ ${isBeforeLaunch ? 'ì‹ ì œí’ˆ ëŸ°ì¹­ ì˜ˆì¸¡ ì¸ì‚¬ì´íŠ¸' : 'S10 Max V Ultra ëŸ°ì¹­ íš¨ê³¼'}</h3>
                <p>
                    ${isBeforeLaunch
                        ? `<span class="ci-hl">S10 Max V Ultra</span> ëŸ°ì¹­(02.27)ê¹Œì§€ D-${Math.round((new Date(launchDate)-new Date(cutoffDate))/(86400000))}ì¼.<br>
                           ì‚¬ì „ ë§ˆì¼€íŒ…(02.15~02.26) ê¸°ê°„ ì¤‘ ê²€ìƒ‰ëŸ‰ì´ ìƒìŠ¹ì„¸ë¥¼ ë³´ì´ê³  ìˆìŠµë‹ˆë‹¤.<br><br>
                           ëŸ°ì¹­ ë‹¹ì¼ <span class="ci-hl">ì§‘ì¤‘ ê´‘ê³  ì§‘í–‰</span>ìœ¼ë¡œ ê²½ìŸì‚¬ ëŒ€ë¹„ ìš°ìœ„ë¥¼ í™•ë³´í•˜ì„¸ìš”.<br>
                           ìµœê³  ê²€ìƒ‰ëŸ‰: <span class="ci-hl">${rPeakVal.toLocaleString()}</span> (${rPeakDate})`
                        : `ëŸ°ì¹­ ì´í›„ ë°ì´í„° ì¶•ì  ì¤‘ (í˜„ì¬ ${postLaunchFd.length}ì¼ì¹˜).<br>
                           ì¶©ë¶„í•œ ë°ì´í„° ìˆ˜ì§‘ í›„ íš¨ê³¼ ë¶„ì„ì´ ì œê³µë©ë‹ˆë‹¤.<br>
                           ìµœê³  ê²€ìƒ‰ëŸ‰: <span class="ci-hl">${rPeakVal.toLocaleString()}</span> (${rPeakDate})`}
                </p>
            </div>`);
        }

        // â”€â”€ ì¹´ë“œ 3: ê²½ìŸì‚¬ í¬ì§€ì…”ë‹ & ì „ëµ ì œì–¸ (D ê¸°ì¤€ + ìµœê·¼ 7ì¼/30ì¼ ì¶”ì´) â”€â”€
        // D ê¸°ì¤€ ê²€ìƒ‰ëŸ‰ (cutoffDate ë‹¹ì¼)
        const dDateRow   = validFd.find(d => (d[dateKey]||'').slice(0,10) === cutoffDate);
        const dRobo      = dDateRow ? (parseFloat(dDateRow[roboKey])||0)    : (latestRobo    || 0);
        const dSamsung   = dDateRow ? (parseFloat(dDateRow[samsungKey])||0) : (latestSamsung || 0);
        const dDreami    = dDateRow ? (parseFloat(dDateRow[dreamKey])||0)   : 0;
        const dEcov      = dDateRow ? (parseFloat(dDateRow[ecovKey])||0)    : 0;

        // 30ì¼ ì¶”ì´ (ìµœê·¼ 30ì¼ vs ì´ì „ 30ì¼)
        const last30  = (arr) => arr.slice(-Math.min(30, arr.length));
        const prev30  = (arr) => arr.slice(-Math.min(60, arr.length), -Math.min(30, arr.length));
        const rLast30 = last30(rVals); const rPrev30 = prev30(rVals);
        const sLast30 = last30(sVals); const sPrev30 = prev30(sVals);
        const dLast30v= last30(dVals); const dPrev30v= prev30(dVals);

        const trend30 = (a, b) => {
            const av = a.length ? a.reduce((s,v)=>s+v,0)/a.length : 0;
            const bv = b.length ? b.reduce((s,v)=>s+v,0)/b.length : 0;
            return bv > 0 ? ((av - bv)/bv*100).toFixed(1) : null;
        };
        const rTrend30 = trend30(rLast30, rPrev30);
        const sTrend30 = trend30(sLast30, sPrev30);
        const dTrend30 = trend30(dLast30v, dPrev30v);

        // D ê¸°ì¤€ ë¡œë³´ë½ vs ì‚¼ì„± ê²©ì°¨
        const dGap = (dSamsung > 0 && dRobo > 0)
            ? ((dRobo - dSamsung) / dSamsung * 100).toFixed(1) : null;

        const mkTrend = (val, icon=true) => {
            if (val === null) return 'â€“';
            const n = parseFloat(val);
            return (icon ? (n>=0?'ğŸ“ˆ ':'ğŸ“‰ ') : '') + (n>=0?'+':'') + val + '%';
        };

        // ì „ëµ ì œì–¸ í…ìŠ¤íŠ¸
        let stratText = '';
        if (dGap !== null) {
            const gapN = parseFloat(dGap);
            if (gapN >= 30) {
                stratText = 'âœ… ë¡œë³´ë½ì´ ì‚¼ì„± ëŒ€ë¹„ <span class="ci-hl">+'+dGap+'%</span> ìš°ì„¸ â€” í˜„ì¬ ìš°ìœ„ë¥¼ ë°”íƒ•ìœ¼ë¡œ <span class="ci-hl">ì „í™˜ìœ¨ ì¤‘ì‹¬</span> ìº í˜ì¸ì„ ì§‘ì¤‘ ìš´ì˜í•˜ì„¸ìš”.';
            } else if (gapN >= 10) {
                stratText = 'âš ï¸ ì‚¼ì„±ì´ ì¶”ê²© ì¤‘ (ê²©ì°¨ <span class="ci-hl">'+dGap+'%</span>) â€” <span class="ci-hl">í‚¤ì›Œë“œ ë°©ì–´</span> ë° <span class="ci-hl">ë¹„êµ ê´‘ê³ </span> ê°•í™” í•„ìš”.';
            } else if (gapN >= 0) {
                stratText = 'ğŸš¨ ì‚¼ì„±ê³¼ ê²©ì°¨ <span class="ci-hl">'+dGap+'%</span>ë¡œ ê·¼ì ‘ â€” <span class="ci-hl">ì¦‰ê°ì  ì˜ˆì‚° ì¦ì•¡</span> ë° <span class="ci-hl">ì‚¼ì„± ê²€ìƒ‰ ì‚¬ìš©ì ë¦¬íƒ€ê²ŸíŒ…</span> ê¸´ê¸‰ ê¶Œì¥.';
            } else {
                stratText = 'ğŸš¨ ì‚¼ì„±ì´ ë¡œë³´ë½ì„ <span class="ci-hl">ì—­ì „</span> (ê²©ì°¨ <span class="ci-hl">'+Math.abs(parseFloat(dGap))+'%</span>) â€” <span class="ci-hl">ì§‘ì¤‘ ê´‘ê³  ì§‘í–‰</span> ì¦‰ì‹œ í•„ìš”.';
            }
        }
        if (parseFloat(dTrend30 || '0') >= 10) {
            stratText += '<br>ë“œë¦¬ë¯¸ 30ì¼ ì¶”ì„¸ <span class="ci-hl">'+mkTrend(dTrend30)+'</span> â€” ì¤‘ì €ê°€ ì‹œì¥ ë°©ì–´ ì „ëµ ì ê²€ í•„ìš”.';
        }

        cards.push(`
        <div class="ci-card green">
            <h3>ğŸ“Š ê²½ìŸì‚¬ í¬ì§€ì…”ë‹ & ì „ëµ ì œì–¸ <small style="font-size:0.8em;font-weight:400;">(ê¸°ì¤€: ${cutoffDate})</small></h3>
            <p>
                <strong>${cutoffDate} ê¸°ì¤€ ê²€ìƒ‰ëŸ‰</strong><br>
                ğŸ”´ ë¡œë³´ë½: <span class="ci-hl">${dRobo > 0 ? dRobo.toLocaleString() : 'ë¯¸ê¸°ë¡'}</span>
                &nbsp;ğŸ”µ ì‚¼ì„±: <span class="ci-hl">${dSamsung > 0 ? dSamsung.toLocaleString() : 'ë¯¸ê¸°ë¡'}</span>
                &nbsp;ğŸŸ¦ ë“œë¦¬ë¯¸: <span class="ci-hl">${dDreami > 0 ? dDreami.toLocaleString() : 'ë¯¸ê¸°ë¡'}</span>
                &nbsp;ğŸŸ« ì—ì½”ë°±ìŠ¤: <span class="ci-hl">${dEcov > 0 ? dEcov.toLocaleString() : 'ë¯¸ê¸°ë¡'}</span><br>
                ${dGap !== null ? `${cutoffDate} ê¸°ì¤€ ë¡œë³´ë½ vs ì‚¼ì„± ê²©ì°¨: <span class="ci-hl">${parseFloat(dGap)>=0?'+':''}${dGap}%</span><br>` : ''}
                <br>
                <strong>ğŸ“… ìµœê·¼ 7ì¼ ì¶”ì´</strong> (ì „ì£¼ 7ì¼ ëŒ€ë¹„)<br>
                ë¡œë³´ë½ ${mkTrend(rWeekTrend)} &nbsp;Â·&nbsp; ì‚¼ì„± ${mkTrend(sWeekTrend)} &nbsp;Â·&nbsp; ë“œë¦¬ë¯¸ ${mkTrend(dTrend)}<br>
                <br>
                <strong>ğŸ“… ìµœê·¼ 30ì¼ ì¶”ì´</strong> (ì´ì „ 30ì¼ ëŒ€ë¹„)<br>
                ë¡œë³´ë½ ${mkTrend(rTrend30)} &nbsp;Â·&nbsp; ì‚¼ì„± ${mkTrend(sTrend30)} &nbsp;Â·&nbsp; ë“œë¦¬ë¯¸ ${mkTrend(dTrend30)}<br>
                <br>
                ${stratText}
                <br>ğŸ’¡ <span class="ci-hl">ê¶Œì¥ ì•¡ì…˜:</span> ê²½ìŸì‚¬ í”„ë¡œëª¨ì…˜ ì‹œì¦Œ ì „í›„ ì¦‰ê°ì ì¸
                <span class="ci-hl">ë¹„êµ ê´‘ê³ </span> + <span class="ci-hl">ì „í™˜ ìº í˜ì¸</span> ì§‘í–‰.
            </p>
        </div>`);

        container.innerHTML = cards.join('\n');
    }

    /* â”€â”€ ì´ˆê¸° ë¡œë“œ â”€â”€ */    /* â”€â”€ ì´ˆê¸° ë¡œë“œ â”€â”€ */
    document.addEventListener('DOMContentLoaded', ()=>{
        setTimeout(loadAdrielData, 800);
    });

    // ---------------------------------------------------------
    // [ì¶”ê°€] ì¸ì‚¬ì´íŠ¸ ìë™ ìƒì„± ë¡œì§
    // ---------------------------------------------------------
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       ì‹¤ì‹œê°„ ë°ì´í„° ë¶„ì„ ì¸ì‚¬ì´íŠ¸
       - ê¸°ì¤€: íŒë§¤ ë°ì´í„°ì˜ ë§ˆì§€ë§‰ WK ì£¼ì°¨
       - ê²€ìƒ‰ëŸ‰ ê¸°ì¤€: getDataCutoff() (ì˜¤ì „ 10ì‹œ ê¸°ì¤€ -1ì¼)
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    function updateInsights() {
        const insightContainer = document.getElementById('dynamicInsights');
        if (!insightContainer) return;
        if (!salesRaw.length || !allData.length) {
            insightContainer.innerHTML = '<div style="text-align:center;padding:20px;color:#718096;grid-column:1/-1;">ë°ì´í„° ë¡œë”© í›„ ì¸ì‚¬ì´íŠ¸ê°€ ìƒì„±ë©ë‹ˆë‹¤.</div>';
            return;
        }

        /* 1. íŒë§¤ ë°ì´í„° ë§ˆì§€ë§‰ WK íƒìƒ‰ */
        const groupWk   = aggregateSales(currentSalesView);
        const activeWks = getActiveWks(groupWk);
        if (!activeWks.length) return;

        const lastWk      = activeWks[activeWks.length - 1];
        const prevWk      = activeWks.length >= 2 ? activeWks[activeWks.length - 2] : null;
        const lastWkRange = wkToRange(lastWk);
        const prevWkRange = prevWk ? wkToRange(prevWk) : null;

        /* 2. ì£¼ê°„ ì´ íŒë§¤ëŸ‰ */
        const totalByWk = (wk) =>
            Object.keys(groupWk).reduce((s, g) => s + (groupWk[g]?.[wk] || 0), 0);

        const lastSales = totalByWk(lastWk);
        const prevSales = prevWk ? totalByWk(prevWk) : null;
        const salesChg  = (prevSales && prevSales > 0)
            ? ((lastSales - prevSales) / prevSales * 100).toFixed(1) : null;

        /* 3. ê²€ìƒ‰ëŸ‰: getDataCutoff() ê¸°ì¤€ */
        const { dateStr: cutoffDate } = getDataCutoff();

        const searchInRange = (start, end) => {
            const rows = allData.filter(d => d['ë‚ ì§œ'] >= start && d['ë‚ ì§œ'] <= end && d['ë‚ ì§œ'] <= cutoffDate);
            const vals = rows.map(d => parseFloat(d['26 .ë¡œë³´ë½']) || 0).filter(v => v > 0);
            return vals.length ? vals.reduce((a,b)=>a+b,0) : null;
        };

        const lastSearch = searchInRange(lastWkRange.start, lastWkRange.end);
        const prevSearch = prevWkRange ? searchInRange(prevWkRange.start, prevWkRange.end) : null;
        const searchChg  = (prevSearch && prevSearch > 0 && lastSearch)
            ? ((lastSearch - prevSearch) / prevSearch * 100).toFixed(1) : null;

        /* 4. ëˆ„ì  ì´ íŒë§¤ëŸ‰ */
        const totalAllSales = activeWks.reduce((s, w) => s + totalByWk(w), 0);

        /* 5. ëŸ°ì¹­ ë‚ ì§œ ì»¨í…ìŠ¤íŠ¸ */
        const launchDate   = '2026-02-27';
        const isPreLaunch  = cutoffDate < launchDate;
        const isLaunchWeek = lastWkRange.start <= launchDate && lastWkRange.end >= launchDate;

        /* 6. ì‹œë‚˜ë¦¬ì˜¤ ë¶„ë¥˜ */
        const searchUp  = searchChg !== null && parseFloat(searchChg) >  3;
        const searchDn  = searchChg !== null && parseFloat(searchChg) < -3;
        const salesDown = salesChg  !== null && parseFloat(salesChg)  <= 0;
        const salesUp   = salesChg  !== null && parseFloat(salesChg)  >  0;

        const fmtK = (v) => v != null ? (v/1000).toFixed(1)+'k' : 'â€”';
        const fmtN = (v) => v != null ? Math.round(v).toLocaleString() : 'â€”';
        const sign  = (v) => parseFloat(v) >= 0 ? '+' : '';

        /* 7. ì¹´ë“œ ìƒì„± */

        // ì¹´ë“œ 1: íŒë§¤ ì„±ê³¼ ìš”ì•½
        let salesNarrative = '';
        if (searchUp && salesDown && isPreLaunch) {
            salesNarrative =
                'WK'+lastWk+' ê²€ìƒ‰ëŸ‰ì€ ì „ì£¼ ëŒ€ë¹„ <span class="highlight">+'+searchChg+'% ìƒìŠ¹</span>í•˜ëŠ” ë°˜ë©´ '+
                'íŒë§¤ëŸ‰ì€ <span class="highlight">'+(salesChg!==null?sign(salesChg)+salesChg+'%':'ê°ì†Œ')+'</span> ê°ì†Œí–ˆìŠµë‹ˆë‹¤.<br><br>'+
                'S10 Max V Ultra ì¶œì‹œ(02.27) ì¼ì •ì´ ê°€ê¹Œì›Œì§ì— ë”°ë¼, ì†Œë¹„ì ê´€ì‹¬ë„(ê²€ìƒ‰ëŸ‰)ëŠ” ë†’ì•„ì§€ì§€ë§Œ '+
                '<span class="highlight">ì‹ ì œí’ˆ êµ¬ë§¤ ëŒ€ê¸° ìˆ˜ìš”ê°€ ëŠ˜ì–´ë‚¨</span>ì— ë”°ë¼ '+
                'S9ì„ ë¹„ë¡¯í•œ ê¸°ì¡´ SKUì˜ íŒë§¤ëŸ‰ì´ ê°ì†Œí•˜ê³  ìˆëŠ” ìƒí™©ì…ë‹ˆë‹¤. '+
                'ëŸ°ì¹­ ì§í›„ ê¸‰ê²©í•œ íŒë§¤ ë°˜ë“±ì´ ì˜ˆìƒë©ë‹ˆë‹¤.';
        } else if (searchUp && salesDown && isLaunchWeek) {
            salesNarrative =
                'S10 Max V Ultra ëŸ°ì¹­ ì£¼ì°¨(WK'+lastWk+'): ê²€ìƒ‰ëŸ‰ <span class="highlight">+'+searchChg+'%</span> ê¸‰ë“±. '+
                'ëŸ°ì¹­ ì´ˆë°˜ íŒë§¤ ë°ì´í„° ë°˜ì˜ê¹Œì§€ ì‹œì°¨ê°€ ìˆìœ¼ë‚˜, '+
                'ê²€ìƒ‰ ê´€ì‹¬ë„ ê¸°ì¤€ <span class="highlight">ì¶œì‹œ íš¨ê³¼ í™•ì¸</span>. '+
                'íŒë§¤ ë°ì´í„° ê°±ì‹  í›„ ì „í™˜ìœ¨ ì§‘ì¤‘ ëª¨ë‹ˆí„°ë§ì´ í•„ìš”í•©ë‹ˆë‹¤.';
        } else if (!isPreLaunch && salesUp) {
            salesNarrative =
                'S10 ëŸ°ì¹­ ì´í›„ WK'+lastWk+': íŒë§¤ëŸ‰ <span class="highlight">+'+salesChg+'%</span> ë°˜ë“± í™•ì¸. '+
                (lastSearch ? 'ê²€ìƒ‰ëŸ‰ <span class="highlight">'+fmtN(lastSearch)+'</span> ìˆ˜ì¤€ ìœ ì§€. ' : '')+
                'ì‹ ì œí’ˆ ì¶œì‹œ íš¨ê³¼ê°€ íŒë§¤ ì§€í‘œì— ë°˜ì˜ë˜ê³  ìˆìŠµë‹ˆë‹¤.';
        } else if (searchDn && salesDown) {
            salesNarrative =
                'WK'+lastWk+' ê²€ìƒ‰ëŸ‰ <span class="highlight">'+(searchChg!==null?sign(searchChg)+searchChg+'%':'í•˜ë½')+'</span>, '+
                'íŒë§¤ëŸ‰ <span class="highlight">'+(salesChg!==null?sign(salesChg)+salesChg+'%':'ê°ì†Œ')+'</span> ë™ë°˜ ê°ì†Œ. '+
                '<span class="highlight">í”„ë¡œëª¨ì…˜Â·ê´‘ê³  ê°•í™”</span>ë¥¼ í†µí•œ ìˆ˜ìš” íšŒë³µì´ í•„ìš”í•©ë‹ˆë‹¤.';
        } else {
            salesNarrative =
                'WK'+lastWk+' íŒë§¤ëŸ‰: <span class="highlight">'+fmtK(lastSales)+'</span>'+
                (salesChg !== null ? ' (ì „ì£¼ ëŒ€ë¹„ '+sign(salesChg)+salesChg+'%)' : '')+'. '+
                (lastSearch ? 'ê²€ìƒ‰ëŸ‰: <span class="highlight">'+fmtN(lastSearch)+'</span>'+(searchChg!==null?' ('+sign(searchChg)+searchChg+'%)':'') : '')+
                ' ëˆ„ì  íŒë§¤: <span class="highlight">'+fmtK(totalAllSales)+'</span>ëŒ€';
        }

        const card1 = '<div class="insight-card blue">'+
            '<h3>ğŸ“¦ íŒë§¤ ì„±ê³¼ ìš”ì•½ <small style="font-size:0.78em;font-weight:400;">(ê¸°ì¤€: WK'+lastWk+' Â· ê²€ìƒ‰ëŸ‰ '+cutoffDate+'ê¹Œì§€)</small></h3>'+
            '<p>'+salesNarrative+
            '<br><br><strong>WK'+lastWk+' ì£¼ê°„ íŒë§¤:</strong> <span class="highlight">'+fmtK(lastSales)+'</span>ëŒ€'+
            (prevSales !== null ? ' / ì „ì£¼(WK'+prevWk+'): <span class="highlight">'+fmtK(prevSales)+'</span>ëŒ€' : '')+
            ' &nbsp;|&nbsp; ëˆ„ì  í•©ê³„: <span class="highlight">'+fmtK(totalAllSales)+'</span>ëŒ€'+
            '</p></div>';

        // ì¹´ë“œ 2: ê´‘ê³  ì§‘í–‰ íŠ¸ë Œë“œ
        let card2 = '';
        if (amRaw.length) {
            const dailyRows = amGetRows().daily;
            const lastSpendRows = dailyRows.slice(-7);
            const prevSpendRows = dailyRows.slice(-14, -7);
            const sumSpend = (arr) => arr.reduce((s,r) => s+(parseFloat(r['ê´‘ê³ ë¹„'])||0), 0);
            const lastSpend7 = sumSpend(lastSpendRows);
            const prevSpend7 = sumSpend(prevSpendRows);
            const spendWkChg = prevSpend7 > 0
                ? ((lastSpend7 - prevSpend7) / prevSpend7 * 100).toFixed(1) : null;
            const fmtW = (v) => {
                if (!v||v===0) return 'â‚©0';
                if (v>=100000000) return 'â‚©'+(v/100000000).toFixed(1)+'ì–µ';
                if (v>=10000) return 'â‚©'+(v/10000).toFixed(0)+'ë§Œ';
                return 'â‚©'+Math.round(v).toLocaleString();
            };
            card2 = '<div class="insight-card">'+
                '<h3>ğŸ’° ê´‘ê³  ì§‘í–‰ íŠ¸ë Œë“œ <small style="font-size:0.78em;font-weight:400;">(ìµœê·¼ 7ì¼)</small></h3>'+
                '<p>ìµœê·¼ 7ì¼ ê´‘ê³ ë¹„: <span class="highlight">'+fmtW(lastSpend7)+'</span><br>'+
                (spendWkChg !== null ? 'ì „ì£¼ 7ì¼ ëŒ€ë¹„: <span class="highlight">'+(parseFloat(spendWkChg)>=0?'+':'')+spendWkChg+'%</span><br>' : '')+
                (parseFloat(spendWkChg) >= 15
                    ? 'ê´‘ê³  ì§‘í–‰ <span class="highlight">ì¦ê°€ì„¸</span> â€” S10 ëŸ°ì¹­ ë§ˆì¼€íŒ… ì§‘ì¤‘ êµ¬ê°„ ì§„ì….'
                    : parseFloat(spendWkChg) <= -15
                    ? 'ê´‘ê³ ë¹„ <span class="highlight">ê°ì†Œì„¸</span> â€” ì˜ˆì‚° íš¨ìœ¨í™” ë˜ëŠ” ì§‘í–‰ ì¡°ì • ì¤‘.'
                    : 'ê´‘ê³ ë¹„ <span class="highlight">ì•ˆì •ì  ì§‘í–‰</span> ìœ ì§€ ì¤‘.')+
                (isPreLaunch
                    ? '<br>ğŸ’¡ ëŸ°ì¹­(02.27) ì „í›„ <span class="highlight">ì§‘ì¤‘ ì§‘í–‰</span> êµ¬ê°„ ëŒ€ë¹„ ê¶Œì¥.'
                    : '<br>ğŸ’¡ ëŸ°ì¹­ í›„ <span class="highlight">ì „í™˜ ì¤‘ì‹¬</span> ìº í˜ì¸ìœ¼ë¡œ ì „í™˜ ê¶Œì¥.')+
                '</p></div>';
        } else {
            card2 = '<div class="insight-card"><h3>ğŸ’° ê´‘ê³  ì§‘í–‰ íŠ¸ë Œë“œ</h3><p>ì•„ë“œë¦¬ì—˜ ë°ì´í„° ì—°ë™ í›„ ê´‘ê³ ë¹„ íŠ¸ë Œë“œê°€ í‘œì‹œë©ë‹ˆë‹¤.</p></div>';
        }

        // ì¹´ë“œ 3: ì „ëµ ì œì–¸
        let strategyMsg = '';
        if (searchUp && salesDown && isPreLaunch) {
            strategyMsg =
                'ğŸ“Œ <strong>ëŸ°ì¹­ D-day ì „ëµ:</strong><br>'+
                'í˜„ì¬ ëŒ€ê¸° ìˆ˜ìš”ê°€ ì¶•ì  ì¤‘ì…ë‹ˆë‹¤. ëŸ°ì¹­ ë‹¹ì¼(02.27) ê²€ìƒ‰ëŸ‰ ê¸‰ì¦ì— ëŒ€ë¹„í•´ '+
                '<span class="highlight">í‚¤ì›Œë“œ ê´‘ê³  ì…ì°°ê°€ ìƒí–¥</span>ê³¼ '+
                '<span class="highlight">S10 ì „ìš© ëœë”©í˜ì´ì§€</span> íŠ¸ë˜í”½ ìœ ë„ë¥¼ ê°•í™”í•˜ì„¸ìš”.<br><br>'+
                'S9 ë“± ê¸°ì¡´ SKU íŒë§¤ í•˜ë½ì€ ì¼ì‹œì  í˜„ìƒì´ë©°, '+
                'ëŸ°ì¹­ ì´í›„ <span class="highlight">S9 ê°€ê²© í”„ë¡œëª¨ì…˜</span>ìœ¼ë¡œ ì¬ê³  ì†Œì§„ ìº í˜ì¸ì„ ë³‘í–‰í•  ê²ƒì„ ê¶Œì¥í•©ë‹ˆë‹¤.';
        } else if (isLaunchWeek || !isPreLaunch) {
            strategyMsg =
                'ğŸš€ <strong>ëŸ°ì¹­ íš¨ê³¼ ê·¹ëŒ€í™” ì „ëµ:</strong><br>'+
                'ì‹ ì œí’ˆ ì¶œì‹œ ì´ˆê¸° êµ¬ë§¤ ê³ ë ¤ìë¥¼ ëŒ€ìƒìœ¼ë¡œ '+
                '<span class="highlight">ë¦¬ë·° ì»¨í…ì¸ </span> ë° '+
                '<span class="highlight">ë¹„êµ ê´‘ê³ </span>ë¥¼ ì§‘ì¤‘ ë…¸ì¶œí•˜ì„¸ìš”.<br><br>'+
                'ê²½ìŸì‚¬(ì‚¼ì„± 03.03, ë“œë¦¬ë¯¸ 03.09) ëŸ°ì¹­ ì „ì— '+
                '<span class="highlight">S10 êµ¬ë§¤ ê²°ì • ìœ ë„</span> ìº í˜ì¸ì„ ìš°ì„  ì§‘í–‰í•˜ëŠ” ê²ƒì´ ì¤‘ìš”í•©ë‹ˆë‹¤.';
        } else {
            strategyMsg =
                'ğŸ’¡ <strong>ë°ì´í„° ê¸°ë°˜ ê¶Œì¥ ì•¡ì…˜:</strong><br>'+
                'ê²½ìŸì‚¬ ê²€ìƒ‰ëŸ‰ ê¸‰ë“± ê°ì§€ ì‹œ ì¦‰ê° <span class="highlight">ë¹„êµ ê´‘ê³  ì†Œì¬</span> ë…¸ì¶œ, '+
                'ì£¼ë§ ê³ ì „í™˜ ì‹œê°„ëŒ€ ì˜ˆì‚° ì¦ì•¡, '+
                'ì‚¼ì„±Â·ë“œë¦¬ë¯¸ í‚¤ì›Œë“œ ê²€ìƒ‰ ì‚¬ìš©ì ëŒ€ìƒ <span class="highlight">ë¦¬íƒ€ê²ŸíŒ… ìº í˜ì¸</span> ê°•í™”.';
        }
        const card3 = '<div class="insight-card green">'+
            '<h3>ğŸ’¡ í–¥í›„ ì „ëµ ì œì–¸</h3>'+
            '<p>'+strategyMsg+'</p></div>';

        insightContainer.innerHTML = card1 + card2 + card3;
    }

    // â”€â”€ PDF ì¶œë ¥ â”€â”€
    function exportPDF() {
        // ì¶œë ¥ ì „ ì•ˆë‚´
        const btn = document.querySelector('.btn-pdf');
        if (btn) { btn.textContent = 'â³ ì¤€ë¹„ ì¤‘...'; btn.disabled = true; }
        setTimeout(() => {
            window.print();
            if (btn) { btn.innerHTML = 'ğŸ“„ PDF ì¶œë ¥'; btn.disabled = false; }
        }, 300);
    }

    // updateCharts override
    const originalUpdateCharts = updateCharts;
    updateCharts = function() {
        originalUpdateCharts();
        setTimeout(updateInsights, 500);
    };

</script>
</body>
</html>
