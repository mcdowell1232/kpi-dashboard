<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ë¡œë´‡ì²­ì†Œê¸° KPI ëª¨ë‹ˆí„°ë§ ëŒ€ì‹œë³´ë“œ</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/luxon@3.3.0/build/global/luxon.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1.3.1/dist/chartjs-adapter-luxon.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Apple SD Gothic Neo', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
            overflow-x: hidden;
        }
        .container { max-width: 1600px; margin: 0 auto; width: 100%; }

        /* â”€â”€ í—¤ë” â”€â”€ */
        header {
            background: white;
            padding: 28px 30px 22px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 25px;
            text-align: center;
        }
        h1 { color: #2d3748; font-size: 2.2em; font-weight: 700; letter-spacing: -0.5px; }

        /* â”€â”€ ë‚ ì§œ í•„í„° â”€â”€ */
        .date-filter {
            background: white; padding: 20px 25px; border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2); margin-bottom: 25px;
            display: flex; align-items: center; justify-content: center;
            gap: 18px; flex-wrap: wrap;
        }
        .date-filter label { font-weight: 600; color: #2d3748; font-size: 1em; }
        .date-filter input[type="date"] {
            padding: 9px 13px; border: 2px solid #e2e8f0;
            border-radius: 8px; font-size: 0.95em; color: #2d3748;
        }
        .date-filter button {
            padding: 9px 22px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; border: none; border-radius: 8px;
            font-size: 0.95em; font-weight: 600; cursor: pointer; transition: opacity 0.2s;
        }
        .date-filter button:hover { opacity: 0.88; }
        .btn-refresh { background: linear-gradient(135deg, #28a745 0%, #20c997 100%) !important; }

        /* â”€â”€ ë‚ ì§œ ë²”ìœ„ â”€â”€ */
        .date-range {
            text-align: center; color: white; font-size: 1em;
            margin-bottom: 20px; background: rgba(255,255,255,0.2);
            padding: 12px 18px; border-radius: 10px;
        }
        .date-info {
            display: inline-block; background: rgba(255,255,255,0.3);
            padding: 4px 11px; border-radius: 5px; margin: 0 4px; font-weight: 600;
        }

        /* â”€â”€ ì°¨íŠ¸ ê·¸ë¦¬ë“œ â”€â”€ */
        .chart-grid {
            display: grid; grid-template-columns: repeat(2, 1fr);
            gap: 28px; margin-bottom: 28px;
        }
        .chart-container {
            background: white; padding: 22px 20px 16px;
            border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        /* íŒë§¤ëŸ‰ ë³µí•© ì°¨íŠ¸ëŠ” ì „ì²´ í­ */
        .chart-container.full-width {
            grid-column: 1 / -1;
        }
        .chart-title {
            font-size: 1.25em; font-weight: 600; color: #2d3748;
            margin-bottom: 16px; text-align: center;
            padding-bottom: 12px; border-bottom: 3px solid #667eea;
        }
        canvas { max-height: 400px; }
        /* íŒë§¤ëŸ‰ ì°¨íŠ¸ ìº”ë²„ìŠ¤ ë†’ì´ ê³ ì • */
        #salesChart { max-height: 420px !important; }

        /* â”€â”€ ë·° í† ê¸€ ë²„íŠ¼ â”€â”€ */
        .view-btn-group {
            display: flex; gap: 8px; margin-bottom: 16px;
            justify-content: flex-start;
        }
        .view-btn {
            padding: 6px 18px; border-radius: 20px;
            border: 1.5px solid #cbd5e1;
            background: #f8fafc; color: #64748b;
            font-size: 0.85em; font-weight: 600;
            cursor: pointer; transition: all 0.18s;
        }
        .view-btn:hover { background: #e2e8f0; }
        .view-btn.active {
            background: #1e3a5f; color: #fff;
            border-color: #1e3a5f;
        }

        /* â”€â”€ ê²€ìƒ‰ëŸ‰ ëŒ€ë¹„ ë¹„ìœ¨ í…Œì´ë¸” â”€â”€ */
        .ratio-section-title {
            font-size: 0.8em; font-weight: 700; color: #475569;
            margin-bottom: 4px; letter-spacing: 0.03em;
        }
        .ratio-table-wrap {
            overflow-x: auto; margin-top: 14px;
            box-sizing: border-box;
        }
        .ratio-table {
            width: 100%; border-collapse: collapse;
            font-size: 0.78em; color: #374151;
            table-layout: fixed;
        }
        /* ì™¼ìª½ ë¼ë²¨ ì—´: afterRenderì—ì„œ ë„ˆë¹„ ë™ì  ì„¤ì • */
        .ratio-label-col {
            text-align: left !important; font-weight: 600;
            font-size: 0.7em !important; line-height: 1.2;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
            padding: 3px 2px !important;
            box-sizing: border-box;
        }
        /* ë°ì´í„° ì…€: afterRenderì—ì„œ ë„ˆë¹„ ë™ì  ì„¤ì • */
        .ratio-data-col {
            text-align: center; box-sizing: border-box;
            white-space: nowrap; overflow: hidden;
        }
        .ratio-table th {
            background: #f1f5f9; padding: 5px 3px;
            font-weight: 600; text-align: center;
            border-bottom: 2px solid #e2e8f0;
            white-space: nowrap; font-size: 0.9em;
        }
        .ratio-table td {
            padding: 4px 3px; text-align: center;
            border-bottom: 1px solid #f0f0f0;
            white-space: nowrap; font-size: 0.9em;
        }
        /* ê²€ìƒ‰ëŸ‰ í–‰ */
        .ratio-row-search td { background: #f8fafc; color:#475569; }
        /* íŒë§¤ëŸ‰ í–‰ */
        .ratio-row-sales td { background: #f0fdf4; color:#166534; font-weight:600; }
        /* ë¹„ìœ¨ í–‰ */
        .ratio-row-ratio td {
            font-weight: 700; background: #fffbeb;
            border-top: 2px solid #fbbf24; color: #dc2626;
        }
        /* ê·¸ë£¹ ìƒì„¸ ë°ì´í„° í–‰ */
        .ratio-row-group td {
            font-size: 0.88em; color:#374151;
            background: #fafafa;
        }
        .ratio-row-group:hover td { background: #f0f9ff; }
        .ratio-pct { font-weight: 700; color: #dc2626; }
        /* ì´í•© ì—´ */
        .ratio-total-col {
            text-align: center; font-weight: 700;
            background: #eef2ff !important;
            color: #3730a3; white-space: nowrap;
            border-left: 2px solid #c7d2fe;
            padding: 4px 6px; font-size: 0.92em;
            min-width: 58px;
        }
        .ratio-total-search { color: #475569; }
        .ratio-total-sales  { color: #166534; }
        .ratio-total-group  { color: #1e40af; }

        /* â”€â”€ ë§ˆì¼€íŒ… ì´ë²¤íŠ¸ í•˜ë‹¨ ë²”ë¡€ (ê³µí†µ ë˜í¼) â”€â”€ */
        .marketing-legend {
            display: flex; align-items: center; justify-content: center;
            gap: 6px 16px; flex-wrap: wrap;
            margin-top: 12px; padding-top: 10px;
            border-top: 1px solid #f0f0f0;
        }
        .ml-item {
            display: flex; align-items: center; gap: 6px;
            font-size: 0.74em; color: #555; font-weight: 500;
            white-space: nowrap;
        }

        /* â”€â”€ ê³µí†µ ë²”ë¡€ ì•„ì´ì½˜ ê¸°ë³¸ â”€â”€ */
        .ml-box {
            width: 16px; height: 12px; border-radius: 3px; flex-shrink: 0;
        }
        .ml-dash {
            width: 20px; height: 0; flex-shrink: 0;
        }

        /* 25ë…„ ë¡œë³´ë½ = ì´ˆë¡ */
        .ml-box-green  { background: rgba(34,197,94,0.2);  border: 1.5px solid rgba(34,197,94,0.6); }
        .ml-dash-green { border-top: 2.5px dashed rgba(22,163,74,0.9); }

        /* 26ë…„ ë¡œë³´ë½ = ë¹¨ê°• */
        .ml-box-red    { background: rgba(220,38,38,0.15); border: 1.5px solid rgba(220,38,38,0.55); }
        .ml-dash-red   { border-top: 2.5px dashed rgba(220,38,38,0.9); }

        /* ì‚¼ì„± = ì§„íŒŒë‘ */
        .ml-box-samsung  { background: rgba(30,64,175,0.15); border: 1.5px solid rgba(30,64,175,0.5); }
        .ml-dash-samsung { border-top: 2.5px dashed rgba(30,64,175,0.9); }

        /* ë“œë¦¬ë¯¸ = í•˜ëŠ˜íŒŒë‘ */
        .ml-box-dreame   { background: rgba(96,165,250,0.2); border: 1.5px solid rgba(96,165,250,0.7); }
        .ml-dash-dreame  { border-top: 2.5px dashed rgba(96,165,250,1); }

        /* â”€â”€ êµ¬ë¶„ì„  â”€â”€ */
        .ml-divider {
            width: 1px; height: 14px;
            background: #ddd; flex-shrink: 0; margin: 0 4px;
        }

        /* â”€â”€ ì¼ë°˜ í…ìŠ¤íŠ¸ ë²”ë¡€ â”€â”€ */
        .legend-info { font-size: 0.82em; color: #718096; margin-top: 10px; text-align: center; }

        /* â”€â”€ ìƒíƒœ / ë¡œë”© â”€â”€ */
        .status { text-align: center; padding: 10px; border-radius: 5px; margin-bottom: 18px; font-weight: 600; }
        .status.success { background: #d4edda; color: #155724; }
        .status.error   { background: #f8d7da; color: #721c24; }
        .hide { display: none; }
        .loading-overlay {
            position: fixed; top:0; left:0; width:100%; height:100%;
            background: rgba(0,0,0,0.7); display:flex;
            justify-content:center; align-items:center; z-index:9999;
        }
        .loading-content { background:white; padding:40px; border-radius:15px; text-align:center; max-width:90%; }
        .spinner {
            border: 4px solid #f3f3f3; border-top: 4px solid #667eea;
            border-radius: 50%; width:50px; height:50px;
            animation: spin 1s linear infinite; margin: 0 auto 20px;
        }
        @keyframes spin { 0%{transform:rotate(0deg)} 100%{transform:rotate(360deg)} }

        /* â”€â”€ íƒœë¸”ë¦¿ â”€â”€ */
        @media (max-width:1200px) and (min-width:769px) {
            .chart-grid { grid-template-columns: 1fr; }
        }

        /* â”€â”€ ëª¨ë°”ì¼ â”€â”€ */
        @media (max-width:768px) {
            body { padding: 10px; }
            .container { width:100%; max-width:100%; }
            h1 { font-size: 1.35em; }
            header { padding: 14px 12px 12px; margin-bottom: 12px; }
            .chart-grid { grid-template-columns: 1fr; gap:14px; margin-bottom:14px; }
            .chart-container { padding: 12px 10px 10px; width:100%; }
            .chart-title { font-size: 0.95em; padding-bottom:8px; margin-bottom:10px; }
            canvas { max-height:none !important; height:45vh !important; min-height:260px; width:100% !important; }
            #salesChart { height:55vw !important; min-height:240px !important; max-height:340px !important; }
            .view-btn { padding:5px 12px; font-size:0.78em; }
            .ratio-table { font-size:0.72em; }
            .ratio-table th, .ratio-table td { padding:4px 6px; }
            .date-filter { padding:12px 10px; gap:8px; margin-bottom:12px; }
            .date-filter label { font-size:0.82em; width:100%; text-align:left; }
            .date-filter input[type="date"] { padding:7px 8px; font-size:0.82em; width:100%; }
            .date-filter button { padding:8px 10px; font-size:0.82em; width:100%; }
            .date-range { font-size:0.88em; padding:9px 10px; margin-bottom:12px; }
            .date-info { padding:3px 7px; font-size:0.88em; }
            .marketing-legend { gap:5px 10px; margin-top:8px; padding-top:8px; }
            .ml-item { font-size:0.68em; white-space:normal; }
            .ml-divider { display:none; }
        }
    </style>
</head>
<body>

<div class="loading-overlay" id="loadingOverlay">
    <div class="loading-content">
        <div class="spinner"></div>
        <h2>ë°ì´í„° ë¡œë”© ì¤‘...</h2>
        <p>êµ¬ê¸€ ì‹œíŠ¸ì—ì„œ ìµœì‹  ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ê³  ìˆìŠµë‹ˆë‹¤.</p>
    </div>
</div>

<div class="container">
    <header>
        <h1>ğŸ¤– ë¡œë´‡ì²­ì†Œê¸° KPI ëª¨ë‹ˆí„°ë§ ëŒ€ì‹œë³´ë“œ</h1>
    </header>

    <div id="statusMessage" class="status hide"></div>

    <div id="mainContent" class="hide">
        <div class="date-filter">
            <label for="startDate">ğŸ“… ì‹œì‘ì¼</label>
            <input type="date" id="startDate" value="2026-01-01">
            <label for="endDate">ğŸ“… ì¢…ë£Œì¼</label>
            <input type="date" id="endDate" value="2026-04-08">
            <button onclick="updateCharts()">ğŸ”„ ê¸°ê°„ ì ìš©</button>
            <button class="btn-refresh" onclick="loadGoogleSheetData()">â†» ë°ì´í„° ìƒˆë¡œê³ ì¹¨</button>
        </div>

        <div class="date-range" id="dateRange">
            <span class="date-info">2026-01-01</span> ~ <span class="date-info">2026-04-08</span>
            <span style="margin-left:10px;">ì´ <strong>98</strong>ì¼</span>
        </div>

        <div class="chart-grid">

            <!-- Chart 2: ì—°ë„ë³„ ë¡œë³´ë½ â˜… ìŒì˜ (ë¼ë²¨ ì—†ìŒ, í•˜ë‹¨ ë²”ë¡€) -->
            <div class="chart-container">
                <div class="chart-title">ğŸ“ˆ ì—°ë„ë³„ ë¡œë³´ë½ ê²€ìƒ‰ëŸ‰ ë¹„êµ</div>
                <canvas id="chart2"></canvas>
                <div class="marketing-legend">
                    <div class="ml-item"><span class="ml-box ml-box-green"></span>25ë…„ ì‚¬ì „ë§ˆì¼€íŒ… (02.05â€“02.20)</div>
                    <div class="ml-item"><span class="ml-dash ml-dash-green"></span>25ë…„ S10 ëŸ°ì¹­ (02.21)</div>
                    <div class="ml-divider"></div>
                    <div class="ml-item"><span class="ml-box ml-box-red"></span>26ë…„ ì‚¬ì „ë§ˆì¼€íŒ… (02.15â€“02.26)</div>
                    <div class="ml-item"><span class="ml-dash ml-dash-red"></span>26ë…„ S10 ëŸ°ì¹­ (02.27)</div>
                </div>
            </div>

            <!-- Chart 3: ì œí’ˆ ëª¨ë¸ë³„ â˜… ìŒì˜ (ë¼ë²¨ ì—†ìŒ, í•˜ë‹¨ ë²”ë¡€) -->
            <div class="chart-container">
                <div class="chart-title">ğŸ“ˆ ì œí’ˆ ëª¨ë¸ë³„ ê²€ìƒ‰ëŸ‰ ì¶”ì´</div>
                <canvas id="chart3"></canvas>
                <div class="marketing-legend">
                    <div class="ml-item"><span class="ml-box ml-box-green"></span>25ë…„ ì‚¬ì „ë§ˆì¼€íŒ… (02.05â€“02.20)</div>
                    <div class="ml-item"><span class="ml-dash ml-dash-green"></span>25ë…„ S10 ëŸ°ì¹­ (02.21)</div>
                    <div class="ml-divider"></div>
                    <div class="ml-item"><span class="ml-box ml-box-red"></span>26ë…„ ì‚¬ì „ë§ˆì¼€íŒ… (02.15â€“02.26)</div>
                    <div class="ml-item"><span class="ml-dash ml-dash-red"></span>26ë…„ S10 ëŸ°ì¹­ (02.27)</div>
                </div>
            </div>

            <!-- Chart 4: ê²½ìŸì‚¬ ë¶„ì„ â˜… Xì¶• í•˜ë‹¨ íƒ€ì„ë¼ì¸ -->
            <div class="chart-container">
                <div class="chart-title">ğŸ“ˆ ê²½ìŸì‚¬ ë¶„ì„ (4ê°œ ì œí’ˆ)</div>
                <canvas id="chart4"></canvas>
                <p class="legend-info" style="margin-top:6px;">ë¡œë³´ë½ S10 Max V Ultra &nbsp;Â·&nbsp; ì‚¼ì„±ë¹„ìŠ¤í¬í¬AIìŠ¤íŒ€ &nbsp;Â·&nbsp; ë“œë¦¬ë¯¸X60 &nbsp;Â·&nbsp; ì—ì½”ë°±ìŠ¤T90</p>
            </div>

            <!-- â˜… íŒë§¤ëŸ‰ ë³µí•© ì°¨íŠ¸ (ì „ì²´ í­, ë§¨ ì•„ë˜) -->
            <div class="chart-container full-width" id="salesChartContainer">
                <div class="chart-title">ğŸ“Š 2026ë…„ ë¡œë³´ë½ ê²€ìƒ‰ëŸ‰ ë° íŒë§¤ëŸ‰</div>

                <!-- ë·° í† ê¸€ ë²„íŠ¼ -->
                <div class="view-btn-group">
                    <button class="view-btn active" id="btnChannel" onclick="setSalesView('channel')">Channel</button>
                    <button class="view-btn"         id="btnSku"     onclick="setSalesView('sku')">SKU</button>
                    <button class="view-btn"         id="btnRetail"  onclick="setSalesView('retail')">Retail</button>
                </div>

                <!-- ë³µí•© ì°¨íŠ¸ ìº”ë²„ìŠ¤ -->
                <div style="position:relative; height:420px;">
                    <canvas id="salesChart"></canvas>
                </div>

                <!-- ê²€ìƒ‰ëŸ‰ ëŒ€ë¹„ íŒë§¤ëŸ‰ ë¹„ìœ¨ í…Œì´ë¸” -->
                <div class="ratio-table-wrap" id="ratioTableWrap"></div>

                <!-- í•˜ë‹¨ ë²”ë¡€ (ì‚¬ì „ë§ˆì¼€íŒ…/ëŸ°ì¹­) -->
                <div class="marketing-legend" style="margin-top:10px;">
                    <div class="ml-item"><span class="ml-box ml-box-red"></span>26ë…„ ì‚¬ì „ë§ˆì¼€íŒ… (02.15â€“02.26)</div>
                    <div class="ml-item"><span class="ml-dash ml-dash-red"></span>26ë…„ ëŸ°ì¹­ (02.27)</div>
                </div>
            </div>

        </div><!-- /chart-grid -->
    </div><!-- /mainContent -->
</div><!-- /container -->

<script>
    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       ìƒìˆ˜
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    const GOOGLE_SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTZ2StdU313UFct0BPPN6JwG73pdglCTLbjwpt3wJZ6R5ifzWMyZo8KpqMuTsE-sw/pub?gid=169813989&single=true&output=csv";
    const SALES_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vT0yD7fDrh9xrgXGgX2jO3HNKr6-UOqpYDG6g7IC8hpIxgrIUpYDpgsD9jtFOXpkQ/pub?gid=1807117921&single=true&output=csv";
    const CORS_PROXIES = [
        'https://corsproxy.io/?',
        'https://api.allorigins.win/raw?url='
    ];

    /*
     * ë§ˆì¼€íŒ… ì´ë²¤íŠ¸ ë‚ ì§œ
     * ë‚ ì§œ ì¶• = 2026ë…„ ê¸°ì¤€ (25ë…„ ë°ì´í„°ë„ 2026 ë‚ ì§œ í–‰ì— ë‚˜ë€íˆ ì €ì¥ëœ êµ¬ì¡°)
     *
     * [ë¡œë³´ë½] 25ë…„: ì‚¬ì „ 02.05~02.20, ëŸ°ì¹­ 02.21
     *          26ë…„: ì‚¬ì „ 02.15~02.26, ëŸ°ì¹­ 02.27
     * [ì‚¼ì„±]        ì‚¬ì „ì˜ˆì•½ 02.11~03.02, ëŸ°ì¹­ 03.03
     * [ë“œë¦¬ë¯¸]      ì‚¬ì „ë§ˆì¼€íŒ… 02.23~03.08, ëŸ°ì¹­ 03.09
     */
    const EVT = {
        // ë¡œë³´ë½ 25ë…„ (ì´ˆë¡)
        rr25PreStart : '2026-02-05',
        rr25PreEnd   : '2026-02-20',
        rr25Launch   : '2026-02-21',
        // ë¡œë³´ë½ 26ë…„ (ë¹¨ê°•)
        rr26PreStart : '2026-02-15',
        rr26PreEnd   : '2026-02-26',
        rr26Launch   : '2026-02-27',
        // ì‚¼ì„± (ì§„íŒŒë‘)
        ssPreStart   : '2026-02-11',
        ssPreEnd     : '2026-03-02',
        ssLaunch     : '2026-03-03',
        // ë“œë¦¬ë¯¸ (í•˜ëŠ˜íŒŒë‘)
        dmPreStart   : '2026-02-23',
        dmPreEnd     : '2026-03-08',
        dmLaunch     : '2026-03-09'
    };

    let allData    = [];
    let charts     = {};
    let salesChart = null;          // íŒë§¤ëŸ‰ ë³µí•© ì°¨íŠ¸ ì¸ìŠ¤í„´ìŠ¤
    let salesRaw   = [];            // íŒë§¤ ì›ë³¸ í–‰ [{model, channel, retailer, wkData}]
    let currentSalesView = 'channel'; // 'channel' | 'sku' | 'retail'

    /* â”€â”€ WK ì£¼ì°¨ â†’ ë‚ ì§œ ë§¤í•‘ (WK1 ì‹œì‘: 2025-12-29 ì›”ìš”ì¼) â”€â”€
     *  WK1  = 2025-12-29 ~ 2026-01-04  (ì¤‘ê°„ì  Wed 2026-01-01)
     *  WK2  = 2026-01-05 ~ 2026-01-11  (Wed 2026-01-07)
     *  WKn  ì‹œì‘ = 2025-12-29 + (n-1)*7ì¼
     *  ì¤‘ê°„ì (ìˆ˜ìš”ì¼) = ì‹œì‘ + 2ì¼
     *  WK1 index = 1, ..., WK52 = 52
    â”€â”€ */
    const WK_START_BASE = new Date('2025-12-29T00:00:00');  // WK1 ì‹œì‘ Monday
    function wkToDateStr(wkNum) {
        // ë°˜í™˜ê°’: ìˆ˜ìš”ì¼(ì¤‘ê°„ì ) ISO string YYYY-MM-DD
        const d = new Date(WK_START_BASE);
        d.setDate(d.getDate() + (wkNum - 1) * 7 + 2); // +2 = Wednesday
        return d.toISOString().slice(0, 10);
    }
    function wkToRange(wkNum) {
        const s = new Date(WK_START_BASE);
        s.setDate(s.getDate() + (wkNum - 1) * 7);
        const e = new Date(s);
        e.setDate(e.getDate() + 6);
        return {
            start: s.toISOString().slice(0, 10),
            end:   e.toISOString().slice(0, 10),
            label: `WK${wkNum}\n${(s.getMonth()+1).toString().padStart(2,'0')}/${s.getDate().toString().padStart(2,'0')}`
        };
    }

    /* â”€â”€ ëª¨ë¸ëª… ì •ê·œí™”: ì»¬ëŸ¬/ë²„ì „ ì œê±°í•˜ì—¬ ìˆœìˆ˜ ëª¨ë¸ëª… ì¶”ì¶œ â”€â”€
     *  ì˜ˆ) "S9 MaxV Ultra(í™”ì´íŠ¸)" â†’ "S9 MaxV Ultra"
     *      "S9 MaxV Ultraì§ë°°ìˆ˜(ë¸”ë™)" â†’ "S9 MaxV Ultraì§ë°°ìˆ˜"
     *      "F25 Ace Combo" â†’ "F25 Ace Combo"  (ê´„í˜¸ ì—†ìœ¼ë©´ ê·¸ëŒ€ë¡œ)
    â”€â”€ */
    function normalizeModel(raw) {
        return raw.replace(/\s*[\(\[ï¼ˆã€][^\)\]ï¼‰ã€‘]*[\)\]ï¼‰ã€‘]\s*/g, '').trim();
    }

    /* â”€â”€ íŒë§¤ ë°ì´í„° ë¡œë“œ (CSV íŒŒì‹±) â”€â”€ */
    async function loadSalesData() {
        let csv = null;
        for (const proxy of CORS_PROXIES) {
            try { csv = await tryFetch(proxy, SALES_URL); break; } catch(e) {}
        }
        if (!csv) {
            try { const r = await fetch(SALES_URL); if (r.ok) csv = await r.text(); } catch(e) {}
        }
        if (!csv) { console.warn('íŒë§¤ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨'); return; }

        Papa.parse(csv, {
            header: false,
            skipEmptyLines: true,
            complete(res) {
                const rows = res.data;
                const hdr  = rows[0]; // header row
                // WK ì»¬ëŸ¼ ì¸ë±ìŠ¤ ë§¤í•‘ (hdr[i] = 'WK1' ~ 'WK52')
                const wkMap = {}; // wkNum â†’ colIndex
                hdr.forEach((h, i) => {
                    const m = h.trim().match(/^WK(\d+)$/);
                    if (m) wkMap[parseInt(m[1])] = i;
                });

                salesRaw = [];
                for (let r = 1; r < rows.length; r++) {
                    const row = rows[r];
                    if (row.length < 8) continue;
                    const model    = (row[0] || '').trim();
                    const retailer = (row[5] || '').trim();
                    const channel  = (row[6] || '').trim();
                    if (!model || !channel) continue;

                    const wkData = {};
                    Object.entries(wkMap).forEach(([wk, ci]) => {
                        const v = parseFloat((row[ci] || '').replace(/,/g,''));
                        if (!isNaN(v) && v > 0) wkData[parseInt(wk)] = v;
                    });
                    salesRaw.push({ model: normalizeModel(model), channel, retailer, wkData });
                }
                console.log(`íŒë§¤ ë°ì´í„° ë¡œë“œ ì™„ë£Œ: ${salesRaw.length}í–‰`);
                renderSalesChart();
            }
        });
    }

    /* â”€â”€ ê·¸ë£¹ ì§‘ê³„: ë·° íƒ€ì…ì— ë”°ë¼ WKë³„ ê·¸ë£¹ í•©ì‚° â”€â”€ */
    function aggregateSales(viewType) {
        const groupWk = {}; // { groupName: { wkNum: total } }
        salesRaw.forEach(row => {
            let key;
            if (viewType === 'channel')  key = row.channel;
            else if (viewType === 'sku') key = row.model;
            else                         key = row.retailer;
            if (!key) key = 'ê¸°íƒ€';
            if (!groupWk[key]) groupWk[key] = {};
            Object.entries(row.wkData).forEach(([wk, v]) => {
                const w = parseInt(wk);
                groupWk[key][w] = (groupWk[key][w] || 0) + v;
            });
        });
        return groupWk;
    }

    /* â”€â”€ ì‚¬ìš© ì¤‘ì¸ WK ë²”ìœ„ ê³„ì‚° (ë°ì´í„° ìˆëŠ” WKë§Œ) â”€â”€ */
    function getActiveWks(groupWk) {
        const wkSet = new Set();
        Object.values(groupWk).forEach(wkd => Object.keys(wkd).forEach(w => wkSet.add(parseInt(w))));
        return [...wkSet].sort((a,b)=>a-b).filter(w => w >= 1); // WK1 ì´ìƒë§Œ (WK52prev ì œì™¸)
    }

    /* â”€â”€ íŒ”ë ˆíŠ¸ â”€â”€ */
    const SALES_PALETTE = [
        'rgba(79,134,247,0.82)',   // íŒŒë‘  - Social MP / Coupang
        'rgba(249,115,22,0.82)',   // ì˜¤ë Œì§€ - MOH
        'rgba(167,139,250,0.82)',  // ë³´ë¼  - TradMP
        'rgba(52,211,153,0.82)',   // ë¯¼íŠ¸  - PP gen
        'rgba(251,191,36,0.82)',   // ë…¸ë‘  - GES Chain
        'rgba(96,165,250,0.82)',   // í•˜ëŠ˜  - Department Store
        'rgba(244,114,182,0.82)',  // í•‘í¬  - Flagship
        'rgba(16,185,129,0.82)',   // ì´ˆë¡  - NAVER
        'rgba(252,211,77,0.82)',   // ì—°ë…¸  - Hypermarket
        'rgba(99,102,241,0.82)',   // ì¸ë””ê³  - Official
        'rgba(203,213,225,0.82)'   // íšŒìƒ‰  - ê¸°íƒ€
    ];
    // ì±„ë„ ê³ ì • ìƒ‰ìƒ (Channel ë·° ì¼ê´€ì„±)
    const CH_COLOR_MAP = {
        'Social MP':'rgba(79,134,247,0.82)',
        'MOH':'rgba(249,115,22,0.82)',
        'TradMP':'rgba(167,139,250,0.82)',
        'PP gen':'rgba(52,211,153,0.82)',
        'GES Chain':'rgba(251,191,36,0.82)',
        'Department Store':'rgba(96,165,250,0.82)',
        'Flagship Store':'rgba(244,114,182,0.82)',
        'NAVER':'rgba(16,185,129,0.82)',
        'Hypermarket':'rgba(252,211,77,0.82)',
        'Official Online Store':'rgba(99,102,241,0.82)',
        'ê¸°íƒ€':'rgba(203,213,225,0.82)'
    };
    function getColor(name, idx, viewType) {
        if (viewType === 'channel' && CH_COLOR_MAP[name]) return CH_COLOR_MAP[name];
        return SALES_PALETTE[idx % SALES_PALETTE.length];
    }

    /* â”€â”€ ê²€ìƒ‰ëŸ‰: WK ê¸°ê°„ ë‚´ í•©ì‚° (null/0 ì œì™¸) â”€â”€ */
    function calcSearchForWk(wkNum) {
        if (!allData.length) return null;
        const range = wkToRange(wkNum);
        const slice = allData.filter(d => d['ë‚ ì§œ'] >= range.start && d['ë‚ ì§œ'] <= range.end);
        const vals  = slice.map(d => d['26 .ë¡œë³´ë½']).filter(v => v != null && v > 0);
        if (!vals.length) return null;
        return vals.reduce((a,b)=>a+b, 0);   // â† í•©ì‚°
    }

    /* â”€â”€ íŒë§¤ëŸ‰ ë³µí•© ì°¨íŠ¸ ë Œë”ë§ â”€â”€ */
    function renderSalesChart() {
        if (!salesRaw.length) return;

        const viewType  = currentSalesView;
        const groupWk   = aggregateSales(viewType);
        const activeWks = getActiveWks(groupWk);

        /* â”€â”€ ì „ì²´ ê¸°ê°„ í•©ì‚° ê¸°ì¤€ ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬ â”€â”€ */
        const groupTotals = {};
        Object.entries(groupWk).forEach(([g, wkd]) => {
            groupTotals[g] = Object.values(wkd).reduce((a,b)=>a+b, 0);
        });
        const sortedGroups = Object.keys(groupTotals)
            .sort((a, b) => groupTotals[b] - groupTotals[a]);

        /* â”€â”€ ìƒìœ„ 10ê°œ + ê¸°íƒ€ â”€â”€ */
        const TOP_N      = 10;
        const topGroups  = sortedGroups.slice(0, TOP_N);   // index 0 = ìµœê³  íŒë§¤
        const restGroups = sortedGroups.slice(TOP_N);
        const etcWk = {};
        if (restGroups.length) {
            activeWks.forEach(w => {
                etcWk[w] = restGroups.reduce((s,g) => s + (groupWk[g]?.[w]||0), 0);
            });
            groupWk['ê¸°íƒ€'] = etcWk;
            topGroups.push('ê¸°íƒ€');
        }
        /* finalGroups[0] = ê°€ì¥ ë§ì€ í•­ëª©  (íŒë§¤ë¹„ì¤‘ ë‚´ë¦¼ì°¨ìˆœ) */
        const finalGroups = topGroups;

        /* â”€â”€ Xì¶• ë ˆì´ë¸” â”€â”€ */
        const wkDisplayLabels = activeWks.map(w => { const r=wkToRange(w); return r.label; });
        const wkCatLabels     = activeWks.map(w => 'WK' + w);   // 'WK1','WK2',...

        /* â”€â”€ ê²€ìƒ‰ëŸ‰ í•©ì‚° â”€â”€ */
        const searchVals = activeWks.map(w => calcSearchForWk(w));

        /* â”€â”€ ì£¼ê°„ ì´ íŒë§¤ â”€â”€ */
        const totalSales = activeWks.map(w =>
            finalGroups.reduce((s,g) => s + (groupWk[g]?.[w]||0), 0)
        );

        /* â”€â”€ ê²€ìƒ‰ëŸ‰ ëŒ€ë¹„ íŒë§¤ ë¹„ìœ¨ â”€â”€ */
        const ratios = activeWks.map((w,i) => {
            const sv = searchVals[i], tv = totalSales[i];
            return (sv && tv) ? (tv/sv*100).toFixed(1) : null;
        });

        /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
         *  ë§‰ëŒ€ ë°ì´í„°ì…‹
         *  ìŠ¤íƒ: ê°€ì¥ ë§ì€ í•­ëª©ì´ ë§¨ ìœ„ì— ì˜¤ë„ë¡ ì—­ìˆœ ë°°ì—´
         *  (Chart.js: ì²« dataset â†’ ë°”ë‹¥, ë§ˆì§€ë§‰ dataset â†’ ê¼­ëŒ€ê¸°)
         * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        const barDatasets = [...finalGroups].reverse().map(g => {
            const origIdx = finalGroups.indexOf(g);
            const color   = getColor(g, origIdx, viewType);
            return {
                type: 'bar',
                label: g,
                data: activeWks.map(w => groupWk[g]?.[w] || null),
                backgroundColor: color,
                borderColor: color.replace('0.82','1'),
                borderWidth: 0.5,
                stack: 'sales',
                yAxisID: 'yLeft',
                order: 2
            };
        });

        /* â”€â”€ ê²€ìƒ‰ëŸ‰ ë¼ì¸ â”€â”€ */
        const lineDataset = {
            type: 'line',
            label: '26 ë¡œë³´ë½ ê²€ìƒ‰ëŸ‰',
            data: searchVals.map(v => (v !== null && v > 0) ? v : NaN),
            borderColor: 'rgb(220,38,38)',
            backgroundColor: 'transparent',
            borderWidth: 2.5,
            pointRadius: 3,
            pointHoverRadius: 5,
            tension: 0.4,
            yAxisID: 'yRight',
            order: 1,
            spanGaps: false
        };

        /* â”€â”€ annotation â”€â”€ */
        const salesAnnotations = {
            preBox: {
                type: 'box',
                xMin: 'WK7', xMax: 'WK8',
                backgroundColor: 'rgba(220,38,38,0.07)',
                borderColor: 'rgba(220,38,38,0.25)', borderWidth: 1,
                label: { display: false }
            },
            launchLine: {
                type: 'line',
                xMin: 'WK9', xMax: 'WK9',
                borderColor: 'rgba(220,38,38,0.75)',
                borderWidth: 1.8, borderDash: [6,4],
                label: { display: false }
            }
        };

        /* â”€â”€ ì°¨íŠ¸ ìƒì„± â”€â”€ */
        const ctx = document.getElementById('salesChart').getContext('2d');
        if (salesChart) salesChart.destroy();
        const isMobile = window.innerWidth <= 768;

        salesChart = new Chart(ctx, {
            type: 'bar',
            data: { labels: wkCatLabels, datasets: [...barDatasets, lineDataset] },
            plugins: [{
                id: 'alignRatioTable',
                afterRender(chart) {
                    try {
                        const ca        = chart.chartArea;
                        const leftPad   = Math.round(ca.left);
                        const rightPad  = Math.round(chart.width - ca.right);
                        const dataW     = ca.right - ca.left;
                        const nWk       = activeWks.length;
                        const colW      = Math.round(dataW / nWk);
                        const wrap      = document.getElementById('ratioTableWrap');
                        if (!wrap) return;

                        /* ì™¼ìª½ ë¼ë²¨ ì—´ ë„ˆë¹„ = ì°¨íŠ¸ Yì¶• ì˜ì—­ */
                        wrap.querySelectorAll('.ratio-label-col').forEach(el => {
                            el.style.width    = leftPad + 'px';
                            el.style.minWidth = leftPad + 'px';
                            el.style.maxWidth = leftPad + 'px';
                        });
                        /* ë°ì´í„° ì…€ ë„ˆë¹„ = ê° ë°” ë„ˆë¹„ */
                        wrap.querySelectorAll('.ratio-data-col').forEach(el => {
                            el.style.width    = colW + 'px';
                            el.style.minWidth = colW + 'px';
                            el.style.maxWidth = colW + 'px';
                        });
                        /* ì˜¤ë¥¸ìª½ íŒ¨ë”© = ìš°ì¸¡ Yì¶• ê³µê°„ */
                        wrap.style.paddingRight = rightPad + 'px';
                        wrap.style.paddingLeft  = '0px';
                    } catch(e) {}
                }
            }],
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: { mode: 'index', intersect: false },
                plugins: {
                    legend: {
                        display: true, position: 'top',
                        labels: {
                            usePointStyle: true,
                            padding: isMobile ? 6 : 12,
                            font: { size: isMobile ? 9 : 11 },
                            boxWidth: isMobile ? 8 : 11,
                            /* â˜… íŒë§¤ë¹„ì¤‘ ë†’ì€ ìˆœì„œë¡œ ë²”ë¡€ ì •ë ¬ */
                            generateLabels(chart) {
                                const defs = Chart.defaults.plugins.legend.labels.generateLabels(chart);
                                const bars = defs.filter(l => l.text !== '26 ë¡œë³´ë½ ê²€ìƒ‰ëŸ‰');
                                bars.sort((a, b) => {
                                    const ai = finalGroups.indexOf(a.text);
                                    const bi = finalGroups.indexOf(b.text);
                                    return (ai === -1 ? 9999 : ai) - (bi === -1 ? 9999 : bi);
                                });
                                return bars;
                            }
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0,0,0,0.85)',
                        padding: isMobile ? 7 : 11,
                        /* â˜… íˆ´íŒ: ì „ì²´ íŒë§¤ë¹„ì¤‘ ë†’ì€ ìˆœ(finalGroups ìˆœì„œ) */
                        itemSort: (a, b) => {
                            if (a.dataset.type === 'line') return 1;
                            if (b.dataset.type === 'line') return -1;
                            const ai = finalGroups.indexOf(a.dataset.label);
                            const bi = finalGroups.indexOf(b.dataset.label);
                            return ai - bi;  // 0 = ìµœê³  â†’ ë¨¼ì € í‘œì‹œ
                        },
                        callbacks: {
                            title(items) {
                                if (!items.length) return '';
                                const i = items[0].dataIndex;
                                return wkDisplayLabels[i].replace('\n', ' ');
                            },
                            label(c) {
                                if (isNaN(c.parsed.y) || c.parsed.y === null) return null;
                                const v   = c.parsed.y;
                                const fmt = v >= 1000 ? (v/1000).toFixed(1)+'k' : Math.round(v);
                                return `${c.dataset.label}: ${fmt}`;
                            },
                            afterBody(items) {
                                const i = items[0]?.dataIndex;
                                if (i == null) return [];
                                const lines = ['â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€'];
                                if (totalSales[i])  lines.push(`ì£¼ì°¨ ì´ íŒë§¤: ${totalSales[i].toLocaleString()}ëŒ€`);
                                if (searchVals[i])  lines.push(`ê²€ìƒ‰ëŸ‰ í•©ì‚°: ${Math.round(searchVals[i]).toLocaleString()}`);
                                if (ratios[i])      lines.push(`íŒë§¤/ê²€ìƒ‰ ë¹„ìœ¨: ${ratios[i]}%`);
                                return lines;
                            }
                        }
                    },
                    annotation: { annotations: salesAnnotations }
                },
                scales: {
                    x: {
                        type: 'category',
                        stacked: true,
                        grid: { display: false },
                        ticks: {
                            font: { size: isMobile ? 8 : 10 },
                            maxRotation: isMobile ? 45 : 0,
                            autoSkip: false
                        }
                    },
                    yLeft: {
                        type: 'linear', position: 'left', stacked: true,
                        title: { display: !isMobile, text: 'íŒë§¤ëŸ‰ (ëŒ€)', font:{size:11}, color:'#374151' },
                        grid: { color: 'rgba(0,0,0,0.05)' },
                        ticks: { font:{size:isMobile?8:10}, callback: v => v>=1000?(v/1000).toFixed(0)+'k':v }
                    },
                    yRight: {
                        type: 'linear', position: 'right',
                        title: { display: !isMobile, text: 'ê²€ìƒ‰ëŸ‰ í•©ì‚°', font:{size:11}, color:'rgb(220,38,38)' },
                        grid: { drawOnChartArea: false },
                        ticks: {
                            font: {size:isMobile?8:10},
                            color: 'rgb(220,38,38)',
                            callback: v => v>=1000?(v/1000).toFixed(0)+'k':v
                        }
                    }
                }
            }
        });

        /* ë¹„ìœ¨ + ìƒì„¸ í…Œì´ë¸” ë Œë”ë§ */
        renderRatioTable(activeWks, wkCatLabels, wkDisplayLabels, totalSales, searchVals, ratios, finalGroups, groupWk, viewType);
    }

    /* â”€â”€ ë¹„ìœ¨ í…Œì´ë¸” + ê·¸ë£¹ ìƒì„¸ â”€â”€ */
    function renderRatioTable(activeWks, wkCatLabels, wkDisplayLabels, totalSales, searchVals, ratios,
                               finalGroups, groupWk, viewType) {
        const wrap = document.getElementById('ratioTableWrap');
        if (!wrap) return;

        const viewLabel = viewType === 'channel' ? 'Channel'
                        : viewType === 'sku'     ? 'SKU(ëª¨ë¸)'
                        :                         'Retail';

        /* â”€â”€ ì´í•© ê³„ì‚° â”€â”€ */
        const totalSearchSum = searchVals.reduce((s, v) => s + (v||0), 0);
        const totalSalesSum  = totalSales.reduce((s, v) => s + (v||0), 0);
        const overallRatio   = (totalSearchSum && totalSalesSum)
                               ? (totalSalesSum / totalSearchSum * 100).toFixed(1) : null;

        /* â”€â”€ ê³µí†µ í—¤ë” í–‰ ë¹Œë” â”€â”€ */
        function buildHeaderRow(firstColLabel) {
            let h = '<tr>';
            h += `<th class="ratio-label-col" style="text-align:left;font-size:0.7em;padding:3px 2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${firstColLabel}</th>`;
            activeWks.forEach((w, i) => {
                const dp = (wkDisplayLabels[i]||'').split('\n')[1] || '';
                h += `<th class="ratio-data-col">WK${w}<br><span style="font-weight:400;color:#64748b;font-size:0.8em;">${dp}</span></th>`;
            });
            /* ì´í•© ì—´ */
            h += `<th class="ratio-total-col">ì´í•©</th>`;
            h += '</tr>';
            return h;
        }

        let html = '';

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           í‘œ 1: ì£¼ì°¨ë³„ ìš”ì•½ (ê²€ìƒ‰ëŸ‰ / íŒë§¤ëŸ‰ / ë¹„ìœ¨)
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        html += '<div class="ratio-section-title">ğŸ“‹ ì£¼ì°¨ë³„ ìš”ì•½</div>';
        html += '<table class="ratio-table"><thead>' + buildHeaderRow('í•­ëª©') + '</thead><tbody>';

        /* ê²€ìƒ‰ëŸ‰ í–‰ */
        html += '<tr class="ratio-row-search"><td class="ratio-label-col" style="font-size:0.7em;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">ğŸ”ê²€ìƒ‰ëŸ‰</td>';
        searchVals.forEach(v => { html += `<td class="ratio-data-col">${v ? Math.round(v).toLocaleString() : 'â€“'}</td>`; });
        html += `<td class="ratio-total-col ratio-total-search">${totalSearchSum ? Math.round(totalSearchSum).toLocaleString() : 'â€“'}</td>`;
        html += '</tr>';

        /* íŒë§¤ëŸ‰ í–‰ */
        html += '<tr class="ratio-row-sales"><td class="ratio-label-col" style="font-size:0.7em;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">ğŸ“¦íŒë§¤ëŸ‰</td>';
        totalSales.forEach(v => { html += `<td class="ratio-data-col">${v ? v.toLocaleString() : 'â€“'}</td>`; });
        html += `<td class="ratio-total-col ratio-total-sales">${totalSalesSum ? totalSalesSum.toLocaleString() : 'â€“'}</td>`;
        html += '</tr>';

        /* ë¹„ìœ¨ í–‰ */
        html += '<tr class="ratio-row-ratio"><td class="ratio-label-col" style="font-size:0.7em;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">ğŸ“Šë¹„ìœ¨</td>';
        ratios.forEach(r => { html += `<td class="ratio-data-col ratio-pct">${r !== null ? r+'%' : 'â€“'}</td>`; });
        html += `<td class="ratio-total-col ratio-pct">${overallRatio ? overallRatio+'%' : 'â€“'}</td>`;
        html += '</tr>';

        html += '</tbody></table>';

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           í‘œ 2: Channel / SKU / Retail ìƒì„¸ íŒë§¤ëŸ‰
           íŒë§¤ëŸ‰ í•©ê³„ ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬ (ê¸°íƒ€ í•­ìƒ ë§¨ ì•„ë˜)
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        html += `<div class="ratio-section-title" style="margin-top:14px;">ğŸ“¦ ${viewLabel} ìƒì„¸ íŒë§¤ëŸ‰</div>`;
        html += '<table class="ratio-table"><thead>' + buildHeaderRow(viewLabel) + '</thead><tbody>';

        /* ê¸°íƒ€ë¥¼ ì œì™¸í•œ ê·¸ë£¹ ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬ í›„ ê¸°íƒ€ë¥¼ ë§¨ ë’¤ì— ì¶”ê°€ */
        const nonEtc = finalGroups.filter(g => g !== 'ê¸°íƒ€');
        const etcArr = finalGroups.filter(g => g === 'ê¸°íƒ€');
        const sortedDetail = [
            ...nonEtc.sort((a, b) => {
                const ta = activeWks.reduce((s,w) => s+(groupWk[a]?.[w]||0), 0);
                const tb = activeWks.reduce((s,w) => s+(groupWk[b]?.[w]||0), 0);
                return tb - ta;
            }),
            ...etcArr
        ];

        sortedDetail.forEach((g) => {
            const gIdx   = finalGroups.indexOf(g);
            const wkVals = activeWks.map(w => groupWk[g]?.[w] || 0);
            const rowTotal = wkVals.reduce((s,v) => s+v, 0);
            if (!rowTotal) return;

            const color = getColor(g, gIdx >= 0 ? gIdx : finalGroups.length - 1, viewType);
            const chip  = `<span style="display:inline-block;width:8px;height:8px;border-radius:2px;background:${color};margin-right:3px;vertical-align:middle;flex-shrink:0;"></span>`;
            const label = g.length > 14 ? g.slice(0,13)+'â€¦' : g;

            html += '<tr class="ratio-row-group">';
            html += `<td class="ratio-label-col" title="${g}" style="text-align:left;font-size:0.72em;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${chip}<span style="vertical-align:middle;">${label}</span></td>`;
            wkVals.forEach(v => { html += `<td class="ratio-data-col">${v ? v.toLocaleString() : ''}</td>`; });
            html += `<td class="ratio-total-col ratio-total-group">${rowTotal.toLocaleString()}</td>`;
            html += '</tr>';
        });

        html += '</tbody></table>';
        wrap.innerHTML = html;
    }

        /* â”€â”€ ë·° ì „í™˜ â”€â”€ */
    function setSalesView(viewType) {
        currentSalesView = viewType;
        ['channel','sku','retail'].forEach(v => {
            const btn = document.getElementById('btn' + v.charAt(0).toUpperCase() + v.slice(1));
            if (btn) btn.classList.toggle('active', v === viewType);
        });
        renderSalesChart();
    }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       ìœ í‹¸
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function showStatus(msg, type) {
        const el = document.getElementById('statusMessage');
        el.textContent = msg;
        el.className = 'status ' + type;
        el.classList.remove('hide');
        if (type === 'success') setTimeout(() => el.classList.add('hide'), 3000);
    }
    function showLoading(show) {
        document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none';
    }
    function cleanNumber(value) {
        if (value === null || value === undefined || value === '' || value === '-') return null;
        if (typeof value === 'number') return value === 0 ? null : value;
        const num = parseFloat(String(value).replace(/[,\s]/g, ''));
        return (isNaN(num) || num === 0) ? null : num;
    }
    function formatK(value) {
        if (value === null || value === undefined) return '';
        return value >= 1000 ? (value / 1000).toFixed(1) + 'k' : Math.round(value).toString();
    }
    function calcYRange(datasets) {
        const vals = datasets.flatMap(d => d.data.map(p => p.y)).filter(v => v != null);
        if (!vals.length) return { min: 0, max: 10000 };
        const mn = Math.min(...vals), mx = Math.max(...vals);
        const pad = (mx - mn) * 0.1;
        return {
            min: Math.max(0, Math.floor((mn - pad) / 100) * 100),
            max: Math.ceil((mx + pad) / 100) * 100
        };
    }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       CORS fetch
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    async function tryFetch(proxy, url) {
        const res = await fetch(proxy + encodeURIComponent(url), { headers: { 'Accept': 'text/csv,*/*' } });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        return await res.text();
    }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       ë°ì´í„° ë¡œë“œ
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    async function loadGoogleSheetData() {
        showLoading(true);
        let csvText = null;
        for (const proxy of CORS_PROXIES) {
            try { csvText = await tryFetch(proxy, GOOGLE_SHEET_URL); break; }
            catch(e) {}
        }
        if (!csvText) {
            try { const r = await fetch(GOOGLE_SHEET_URL); if (r.ok) csvText = await r.text(); } catch(e) {}
        }
        if (!csvText) {
            showLoading(false);
            showStatus('âŒ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
            return;
        }
        Papa.parse(csvText, {
            header: true, skipEmptyLines: true,
            complete(results) {
                allData = results.data.map(row => {
                    const out = {};
                    Object.keys(row).forEach(k => {
                        if (k === 'ë‚ ì§œ' || k.includes('ë‚ ì§œ')) out['ë‚ ì§œ'] = row[k];
                        else out[k] = cleanNumber(row[k]);
                    });
                    return out;
                });
                showLoading(false);
                document.getElementById('mainContent').classList.remove('hide');
                showStatus(`âœ… ë°ì´í„° ë¡œë“œ ì™„ë£Œ! (${allData.length}ê°œ ë ˆì½”ë“œ)`, 'success');
                updateCharts();
                loadSalesData(); // íŒë§¤ ë°ì´í„° ë³„ë„ ë¡œë“œ
            },
            error(err) {
                showLoading(false);
                showStatus('âŒ íŒŒì‹± ì˜¤ë¥˜: ' + err.message, 'error');
            }
        });
    }

    function filterData(data, start, end) {
        return data.filter(d => d['ë‚ ì§œ'] >= start && d['ë‚ ì§œ'] <= end);
    }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     * Annotation ë¹Œë” A: ë¡œë³´ë½ ë§ˆì¼€íŒ… ì´ë²¤íŠ¸ (ì°¨íŠ¸ 2Â·3)
     *   - 25ë…„ ì´ˆë¡, 26ë…„ ë¹¨ê°•
     *   - ê·¸ë˜í”„ ìœ„ ë¼ë²¨ ì¹© ì™„ì „ ì œê±° (label.display: false)
     *   - ìŒì˜ ë°•ìŠ¤ + ì ì„ ë§Œ í‘œì‹œ
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function buildRoborockAnnotations() {
        return {
            // â”€â”€ 25ë…„ ì‚¬ì „ë§ˆì¼€íŒ… ìŒì˜ (ì´ˆë¡) â”€â”€
            rr25Box: {
                type: 'box',
                xMin: EVT.rr25PreStart,
                xMax: EVT.rr25PreEnd,
                backgroundColor: 'rgba(34,197,94,0.12)',
                borderColor: 'rgba(34,197,94,0.35)',
                borderWidth: 1,
                label: { display: false }
            },
            // â”€â”€ 25ë…„ ëŸ°ì¹­ ìˆ˜ì§ ì ì„  (ì´ˆë¡) â”€â”€
            rr25Line: {
                type: 'line',
                xMin: EVT.rr25Launch,
                xMax: EVT.rr25Launch,
                borderColor: 'rgba(22,163,74,0.85)',
                borderWidth: 1.8,
                borderDash: [6, 4],
                label: { display: false }
            },
            // â”€â”€ 26ë…„ ì‚¬ì „ë§ˆì¼€íŒ… ìŒì˜ (ë¹¨ê°•) â”€â”€
            rr26Box: {
                type: 'box',
                xMin: EVT.rr26PreStart,
                xMax: EVT.rr26PreEnd,
                backgroundColor: 'rgba(220,38,38,0.09)',
                borderColor: 'rgba(220,38,38,0.32)',
                borderWidth: 1,
                label: { display: false }
            },
            // â”€â”€ 26ë…„ ëŸ°ì¹­ ìˆ˜ì§ ì ì„  (ë¹¨ê°•) â”€â”€
            rr26Line: {
                type: 'line',
                xMin: EVT.rr26Launch,
                xMax: EVT.rr26Launch,
                borderColor: 'rgba(220,38,38,0.85)',
                borderWidth: 1.8,
                borderDash: [6, 4],
                label: { display: false }
            }
        };
    }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     * Annotation ë¹Œë” B: ê²½ìŸì‚¬ ì´ìŠˆ ì¼ì • (ì°¨íŠ¸ 4)
     *   â˜… ê·¸ë˜í”„ ìœ„ ìŒì˜ ì™„ì „ ì œê±° â†’ Xì¶• í•˜ë‹¨ íƒ€ì„ë¼ì¸ìœ¼ë¡œ ëŒ€ì²´
     *   â†’ annotationì€ ë¹ˆ ê°ì²´ ë°˜í™˜ (í”ŒëŸ¬ê·¸ì¸ì´ ì§ì ‘ ê·¸ë¦¼)
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function buildCompetitorAnnotations() {
        return {}; // íƒ€ì„ë¼ì¸ í”ŒëŸ¬ê·¸ì¸ì´ ëŒ€ì²´
    }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     * â˜… ì»¤ìŠ¤í…€ í”ŒëŸ¬ê·¸ì¸: Xì¶• í•˜ë‹¨ ë¸Œëœë“œë³„ íƒ€ì„ë¼ì¸ ë°”
     *   ì°¨íŠ¸ 4 ì „ìš©. afterDraw í›…ìœ¼ë¡œ ìº”ë²„ìŠ¤ì— ì§ì ‘ ê·¸ë¦¼.
     *   - ë°°ê²½ íŠ¸ë™ + ìƒ‰ìƒ ë°” + ëŸ°ì¹­ ìˆ˜ì§ì„  + ë¸Œëœë“œëª… í…ìŠ¤íŠ¸
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    const timelinePlugin = {
        id: 'chart4Timeline',
        afterDraw(chart) {
            if (chart.canvas.id !== 'chart4') return;

            const ctx   = chart.ctx;
            const xAxis = chart.scales.x;
            const area  = chart.chartArea;

            // ë‚ ì§œ(ISO string) â†’ xí”½ì…€. ì°¨íŠ¸ ë²”ìœ„ ë°–ì€ í´ë¨í”„.
            const toX = (iso) => {
                const ms = luxon.DateTime.fromISO(iso).toMillis();
                const px = xAxis.getPixelForValue(ms);
                return Math.max(area.left, Math.min(area.right, px));
            };
            // ë‚ ì§œê°€ ì°¨íŠ¸ xë²”ìœ„ ì•ˆì— ìˆëŠ”ì§€ ì—¬ë¶€
            const inRange = (iso) => {
                const ms = luxon.DateTime.fromISO(iso).toMillis();
                return ms >= xAxis.min && ms <= xAxis.max;
            };
            const eitherInRange = (s, e) => {
                const sMs = luxon.DateTime.fromISO(s).toMillis();
                const eMs = luxon.DateTime.fromISO(e).toMillis();
                return eMs >= xAxis.min && sMs <= xAxis.max;
            };

            /* íƒ€ì„ë¼ì¸ í–‰ ì •ì˜ */
            const ROW_H  = 14;   // í–‰ ë†’ì´
            const ROW_G  = 3;    // í–‰ ê°„ê²©
            const OFFSET = 28;   // Xì¶• ëˆˆê¸ˆ í…ìŠ¤íŠ¸ ì•„ë˜ ì—¬ë°±
            const LBL_W  = 42;   // ë¸Œëœë“œëª… ì˜ì—­ ë„ˆë¹„
            const startY = area.bottom + OFFSET;
            const isMob  = chart.width < 480;

            const rows = [
                {
                    /* 1í–‰: ì‚¼ì„± â€” ì‚¬ì „ì˜ˆì•½ 02.11 ì‹œì‘ (ê°€ì¥ ë¹ ë¦„) */
                    label: 'ì‚¼ì„±',
                    labelColor: '#1e40af',
                    segments: [
                        { start: EVT.ssPreStart, end: EVT.ssPreEnd, fill: 'rgba(30,64,175,0.42)' }
                    ],
                    lines: [
                        { date: EVT.ssLaunch, color: 'rgba(30,64,175,1)', label: isMob ? '' : '3.3ëŸ°ì¹­' }
                    ]
                },
                {
                    /* 2í–‰: ë¡œë³´ë½ â€” 26ë…„ ì¼ì •ë§Œ (ì‚¬ì „ 02.15 ì‹œì‘) */
                    label: 'ë¡œë³´ë½',
                    labelColor: '#dc2626',
                    segments: [
                        { start: EVT.rr26PreStart, end: EVT.rr26PreEnd, fill: 'rgba(220,38,38,0.45)' }
                    ],
                    lines: [
                        { date: EVT.rr26Launch, color: 'rgba(220,38,38,1)', label: isMob ? '' : '2.27ëŸ°ì¹­' }
                    ]
                },
                {
                    /* 3í–‰: ë“œë¦¬ë¯¸ â€” ì‚¬ì „ë§ˆì¼€íŒ… 02.23 ì‹œì‘ (ê°€ì¥ ëŠ¦ìŒ) */
                    label: 'ë“œë¦¬ë¯¸',
                    labelColor: '#3b82f6',
                    segments: [
                        { start: EVT.dmPreStart, end: EVT.dmPreEnd, fill: 'rgba(96,165,250,0.55)' }
                    ],
                    lines: [
                        { date: EVT.dmLaunch, color: 'rgba(96,165,250,1)', label: isMob ? '' : '3.9ëŸ°ì¹­' }
                    ]
                }
            ];

            ctx.save();

            rows.forEach((row, i) => {
                const y = startY + i * (ROW_H + ROW_G);

                /* â‘  íŠ¸ë™ ë°°ê²½ (íšŒìƒ‰ ë°”) */
                ctx.fillStyle = 'rgba(0,0,0,0.06)';
                ctx.beginPath();
                ctx.roundRect
                    ? ctx.roundRect(area.left + LBL_W, y, area.right - area.left - LBL_W, ROW_H, 3)
                    : ctx.rect(area.left + LBL_W, y, area.right - area.left - LBL_W, ROW_H);
                ctx.fill();

                /* â‘¡ ë¸Œëœë“œëª… í…ìŠ¤íŠ¸ */
                ctx.fillStyle = row.labelColor;
                ctx.font = `bold ${isMob ? 9 : 10}px -apple-system, sans-serif`;
                ctx.textAlign = 'left';
                ctx.textBaseline = 'middle';
                ctx.fillText(row.label, area.left + 2, y + ROW_H / 2);

                /* â‘¢ í´ë¦¬í•‘ ì˜ì—­ = íŠ¸ë™ë§Œ */
                ctx.save();
                ctx.beginPath();
                ctx.rect(area.left + LBL_W, y - 1, area.right - area.left - LBL_W, ROW_H + 2);
                ctx.clip();

                /* â‘£ ìƒ‰ìƒ ì„¸ê·¸ë¨¼íŠ¸ ë°” */
                row.segments.forEach(seg => {
                    if (!eitherInRange(seg.start, seg.end)) return;
                    const x1 = toX(seg.start);
                    const x2 = toX(seg.end);
                    ctx.fillStyle = seg.fill;
                    ctx.fillRect(x1, y, x2 - x1, ROW_H);
                });

                /* â‘¤ ëŸ°ì¹­ ìˆ˜ì§ì„  + í…ìŠ¤íŠ¸ */
                row.lines.forEach(ln => {
                    if (!inRange(ln.date)) return;
                    const x = toX(ln.date);
                    ctx.strokeStyle = ln.color;
                    ctx.lineWidth = 2;
                    ctx.setLineDash([4, 3]);
                    ctx.beginPath();
                    ctx.moveTo(x, y);
                    ctx.lineTo(x, y + ROW_H);
                    ctx.stroke();
                    ctx.setLineDash([]);

                    if (ln.label) {
                        ctx.fillStyle = ln.color;
                        ctx.font = `${isMob ? 7 : 8}px -apple-system, sans-serif`;
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'middle';
                        ctx.fillText(ln.label, x, y + ROW_H / 2);
                    }
                });

                ctx.restore(); /* í´ë¦¬í•‘ í•´ì œ */
            });

            ctx.restore();
        }
    };

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     * (ë”ë¯¸ ìœ ì§€) â€” buildCompetitorAnnotations ì•„ë˜ ì¶”ê°€ë¡œ ì°¸ì¡°ë˜ì§€ ì•ŠìŒ
     * â˜… ì‚¼ì„± ì‚¬ì „ì˜ˆì•½ ìŒì˜ (ì§„íŒŒë‘) â€” ì´í•˜ ì½”ë“œëŠ” ìœ„ì—ì„œ ì œê±°ë¨
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function _unusedOldAnnotations() {
        return {
            ssBox: { type:'box', xMin:EVT.ssPreStart, xMax:EVT.ssPreEnd, backgroundColor:'rgba(30,64,175,0.08)', borderWidth:0, label:{display:false} },
            ssLine: { type:'line', xMin:EVT.ssLaunch, xMax:EVT.ssLaunch, borderColor:'rgba(30,64,175,0.5)', borderWidth:1, borderDash:[4,3], label:{display:false} },
            dmBox: { type:'box', xMin:EVT.dmPreStart, xMax:EVT.dmPreEnd, backgroundColor:'rgba(96,165,250,0.08)', borderWidth:0, label:{display:false} },
            dmLine: { type:'line', xMin:EVT.dmLaunch, xMax:EVT.dmLaunch, borderColor:'rgba(96,165,250,0.5)', borderWidth:1, borderDash:[4,3], label:{display:false} }
        };
    }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       ì°¨íŠ¸ ìƒì„±  annotationsObj = null | Object
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function createChart(canvasId, datasets, annotationsObj = null) {
        const ctx = document.getElementById(canvasId).getContext('2d');
        if (charts[canvasId]) charts[canvasId].destroy();

        const isMobile   = window.innerWidth <= 768;
        const isChart4   = canvasId === 'chart4';
        const yRange     = calcYRange(datasets);
        const annotationOpts = annotationsObj
            ? { annotations: annotationsObj }
            : {};
        // ì°¨íŠ¸4: Xì¶• í•˜ë‹¨ íƒ€ì„ë¼ì¸ ê³µê°„ í™•ë³´
        const bottomPad  = isChart4 ? (isMobile ? 62 : 72) : 0;
        // ì°¨íŠ¸4: íƒ€ì„ë¼ì¸ í”ŒëŸ¬ê·¸ì¸ ë“±ë¡
        const pluginList = isChart4 ? [timelinePlugin] : [];

        charts[canvasId] = new Chart(ctx, {
            type: 'line',
            data: { datasets },
            plugins: pluginList,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                layout: { padding: { bottom: bottomPad } },
                interaction: { mode: 'index', intersect: false },
                plugins: {
                    legend: {
                        display: true, position: 'top',
                        labels: {
                            usePointStyle: true,
                            padding: isMobile ? 8 : 14,
                            font: { size: isMobile ? 10 : 12 },
                            boxWidth: isMobile ? 8 : 12
                        }
                    },
                    tooltip: {
                        enabled: true,
                        backgroundColor: 'rgba(0,0,0,0.82)',
                        padding: isMobile ? 7 : 11,
                        titleFont: { size: isMobile ? 11 : 13 },
                        bodyFont:  { size: isMobile ? 10 : 12 },
                        callbacks: {
                            label(c) {
                                if (c.parsed.y === null) return null;
                                return (c.dataset.label || '') + ': ' + formatK(c.parsed.y);
                            }
                        }
                    },
                    annotation: annotationOpts
                },
                scales: {
                    x: {
                        type: 'time',
                        time: { unit: 'day', displayFormats: { day: 'MM/dd' } },
                        title: { display: false },
                        grid: { display: false },
                        ticks: {
                            font: { size: isMobile ? 8 : 11 },
                            maxRotation: isMobile ? 45 : 0,
                            autoSkip: true,
                            maxTicksLimit: isMobile ? 5 : 10
                        }
                    },
                    y: {
                        suggestedMin: yRange.min,
                        suggestedMax: yRange.max,
                        title: { display: false },
                        grid: { color: 'rgba(0,0,0,0.05)' },
                        ticks: {
                            font: { size: isMobile ? 9 : 11 },
                            callback: v => formatK(v)
                        }
                    }
                }
            }
        });
    }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       ìƒ‰ìƒ
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    const C = {
        green25  : 'rgb(34,197,94)',    // 25ë…„ ë¡œë³´ë½ / S9
        red26    : 'rgb(220,38,38)',    // 26ë…„ ë¡œë³´ë½ / S10
        blue     : 'rgb(59,130,246)',   // 25ë…„ ë¡œë´‡ì²­ì†Œê¸°
        red      : 'rgb(239,68,68)',    // 26ë…„ ë¡œë´‡ì²­ì†Œê¸°
        samsung  : 'rgb(30,64,175)',    // ì‚¼ì„± ì§„íŒŒë‘
        dreame   : 'rgb(96,165,250)',   // ë“œë¦¬ë¯¸ í•˜ëŠ˜íŒŒë‘
        ecovacs  : 'rgb(120,53,15)'    // ì—ì½”ë°±ìŠ¤ ê°ˆìƒ‰
    };

    function ds(label, data, color) {
        return {
            label, data,
            borderColor: color, backgroundColor: 'transparent',
            borderWidth: 2.5, tension: 0.4, fill: false,
            pointRadius: 0, pointHoverRadius: 4, spanGaps: false
        };
    }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       ì°¨íŠ¸ ì—…ë°ì´íŠ¸
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function updateCharts() {
        if (!allData.length) return;
        const start = document.getElementById('startDate').value;
        const end   = document.getElementById('endDate').value;
        if (!start || !end) { alert('ì‹œì‘ì¼ê³¼ ì¢…ë£Œì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.'); return; }

        const fd = filterData(allData, start, end);
        if (!fd.length) { alert('ì„ íƒ ê¸°ê°„ì— ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.'); return; }

        document.getElementById('dateRange').innerHTML =
            `<span class="date-info">${start}</span> ~ <span class="date-info">${end}</span>` +
            `<span style="margin-left:10px;">ì´ <strong>${fd.length}</strong>ì¼</span>`;

        const pt = (d, k) => ({ x: d['ë‚ ì§œ'], y: d[k] });

        // íŒë§¤ ì°¨íŠ¸: ê²€ìƒ‰ ë°ì´í„° ê°±ì‹  í›„ ì¬ë Œë”ë§
        if (salesRaw.length) renderSalesChart();

        // Chart 2 â€“ ì—°ë„ë³„ ë¡œë³´ë½ â˜… ìŒì˜ O / ë¼ë²¨ ì—†ìŒ
        createChart('chart2', [
            ds('25 ë¡œë³´ë½', fd.map(d => pt(d, '25 ë¡œë³´ë½')),  C.green25),
            ds('26 ë¡œë³´ë½', fd.map(d => pt(d, '26 .ë¡œë³´ë½')), C.red26)
        ], buildRoborockAnnotations());

        // Chart 3 â€“ ì œí’ˆ ëª¨ë¸ë³„ â˜… ìŒì˜ O / ë¼ë²¨ ì—†ìŒ
        createChart('chart3', [
            ds('S9 Max V Ultra',  fd.map(d => pt(d, 'S9 Max V Ultra')),  C.green25),
            ds('S10 Max V Ultra', fd.map(d => pt(d, 'S10 Max V Ultra')), C.red26)
        ], buildRoborockAnnotations());

        // Chart 4 â€“ ê²½ìŸì‚¬ ë¶„ì„ â˜… ì‚¼ì„±Â·ë“œë¦¬ë¯¸ ìŒì˜ O / ë¼ë²¨ ì—†ìŒ
        createChart('chart4', [
            ds('ë¡œë³´ë½ S10 Max V Ultra', fd.map(d => pt(d, 'S10 Max V Ultra')),  C.red26),
            ds('ì‚¼ì„±ë¹„ìŠ¤í¬í¬AIìŠ¤íŒ€',      fd.map(d => pt(d, 'ì‚¼ì„±ë¡œë´‡ì²­ì†Œê¸°')),   C.samsung),
            ds('ë“œë¦¬ë¯¸X60',              fd.map(d => pt(d, 'ë“œë¦¬ë¯¸x60')),        C.dreame),
            ds('ì—ì½”ë°±ìŠ¤T90',            fd.map(d => pt(d, 'ì—ì½”ë°±ìŠ¤T90')),      C.ecovacs)
        ], buildCompetitorAnnotations());
    }

    /* ì´ˆê¸°í™” */
    window.addEventListener('DOMContentLoaded', loadGoogleSheetData);
    window.addEventListener('resize', () => {
        if (allData.length) updateCharts();
        if (salesRaw.length) renderSalesChart();
    });
</script>
</body>
</html>
